var OIMO={REVISION:"REV.1.0.0"};OIMO.BROAD_PHASE_BRUTE_FORCE=1,OIMO.BROAD_PHASE_SWEEP_AND_PRUNE=2,OIMO.SHAPE_NULL=0,OIMO.SHAPE_SPHERE=1,OIMO.SHAPE_BOX=2,OIMO.SHAPE_CYLINDER=3,OIMO.MAX_BODIES=16384,OIMO.WORLD_MAX_SHAPES=32768,OIMO.MAX_CONTACTS=65536,OIMO.MAX_JOINTS=16384,OIMO.MAX_CONSTRAINTS=OIMO.MAX_CONTACTS+OIMO.MAX_JOINTS,OIMO.MAX_SHAPES=64,OIMO.BODY_DYNAMIC=0,OIMO.BODY_STATIC=1,OIMO.WORLD_SCALE=100,OIMO.INV_SCALE=.01,OIMO.TO_RAD=Math.PI/180,OIMO.Link=function(n){var t=n||{},f,i;if(t.world){this.name=t.name||"";var s=t.type||"hinge",e=t.axe1||[1,0,0],o=t.axe2||[1,0,0],r=t.pos1||[0,0,0],u=t.pos2||[0,0,0];r=r.map(function(n){return n*OIMO.INV_SCALE}),u=u.map(function(n){return n*OIMO.INV_SCALE}),f=t.max||10,f=f*OIMO.INV_SCALE,i=new OIMO.JointConfig,i.allowCollision=t.collision||!1,i.localAxis1.init(e[0],e[1],e[2]),i.localAxis2.init(o[0],o[1],o[2]),i.localRelativeAnchorPosition1.init(r[0],r[1],r[2]),i.localRelativeAnchorPosition2.init(u[0],u[1],u[2]),(typeof t.body1=="string"||t.body1 instanceof String)&&(t.body1=t.world.getByName(t.body1)),(typeof t.body2=="string"||t.body2 instanceof String)&&(t.body2=t.world.getByName(t.body2));switch(s){case"ball":case"jointBall":this.joint=new OIMO.BallJoint(i,t.body1,t.body2);break;case"distance":case"jointDistance":this.joint=new OIMO.DistanceJoint(i,t.body1,t.body2,f);break;case"hinge":case"jointHinge":this.joint=new OIMO.HingeJoint(i,t.body1,t.body2);break;case"hinge2":case"jointHinge2":this.joint=new OIMO.Hinge2Joint(i,t.body1,t.body2)}this.joint.name=this.name,t.world.addJoint(this.joint)}},OIMO.Link.prototype={constructor:OIMO.Link,getMatrix:function(){}},OIMO.Body=function(n){var i=n||{},u,s,f,l,o,h,c,r,y,t;if(i.world){this.name=i.name||"";var a=i.move||!1,v=i.noSleep||!1,e=i.pos||[0,0,0];for(e=e.map(function(n){return n*OIMO.INV_SCALE}),u=i.size||[1,1,1],u=u.map(function(n){return n*OIMO.INV_SCALE}),s=i.rot||[0,0,0],s=s.map(function(n){return n*OIMO.TO_RAD}),f=[],t=0;t<s.length/3;t++)l=OIMO.EulerToAxis(s[t+0],s[t+1],s[t+2]),f.push(l[0]),f.push(l[1]),f.push(l[2]),f.push(l[3]);for(o=i.sc||new OIMO.ShapeConfig,i.config&&(o.density=i.config[0]||1,o.friction=i.config[1]||.5,o.restitution=i.config[2]||.5),o.position.init(e[0],e[1],e[2]),this.body=new OIMO.RigidBody(f[0],f[1],f[2],f[3]),h=[],c=i.type||"box",typeof c=="string"&&(c=[c]),t=0;t<c.length;t++){r=t*3,y=t*4;switch(c[t]){case"sphere":h[t]=new OIMO.SphereShape(o,u[r+0]);break;case"cylinder":h[t]=new OIMO.CylinderShape(o,u[r+0],u[r+1]);break;case"box":h[t]=new OIMO.BoxShape(o,u[r+0],u[r+1],u[r+2])}this.body.addShape(h[t]),t>0&&h[t].relativePosition.init(e[r+0],e[r+1],e[r+2])}a?(this.body.setupMass(OIMO.BODY_DYNAMIC),this.body.allowSleep=v?!1:!0):this.body.setupMass(OIMO.BODY_STATIC),this.body.name=this.name,i.world.addRigidBody(this.body)}},OIMO.Body.prototype={constructor:OIMO.Body,getMatrix:function(){return this.body.getMatrix()},setPosition:function(n,t,i){this.body.setPosition(n,t,i)},setRotation:function(n,t,i){var r=OIMO.EulerToAxis(n*OIMO.TO_RAD,t*OIMO.TO_RAD,i*OIMO.TO_RAD),e=r[0],u=r[1]*r[1]+r[2]*r[2]+r[3]*r[3],f,o;u>0&&(u=1/Math.sqrt(u),r[1]*=u,r[2]*=u,r[3]*=u),f=Math.sin(e*.5),o=Math.cos(e*.5),this.body.orientation=new OIMO.Quat(o,f*r[1],f*r[2],f*r[3])},sleep:function(){return this.body.sleeping}},OIMO.World=function(n,t){var u=n||60,f=t||OIMO.BROAD_PHASE_SWEEP_AND_PRUNE,r,i;this.rigidBodies=[],this.rigidBodies.length=OIMO.MAX_BODIES,this.numRigidBodies=0,this.shapes=[],this.shapes.length=OIMO.WORLD_MAX_SHAPES,this.numShapes=0,this.contacts=null,this.prevContacts=null,this.contactPool1=[],this.contactPool2=[],this.contactPool1.length=OIMO.MAX_CONTACTS,this.contactPool2.length=OIMO.MAX_CONTACTS,this.numContacts=0,this.numPrevContacts1=0,this.numPrevContacts2=0,this.joints=[],this.joints.length=OIMO.MAX_JOINTS,this.numJoints=0,this.numIslands=0,this.constraints=[],this.constraints.length=OIMO.MAX_CONSTRAINTS,this.numConstraints=0,this.collisionResult=new OIMO.CollisionResult(OIMO.MAX_CONTACTS),this.islandStack=[],this.islandStack.length=OIMO.MAX_BODIES,this.islandRigidBodies=[],this.islandRigidBodies.length=OIMO.MAX_BODIES,this.islandNumRigidBodies=0,this.islandConstraints=[],this.islandConstraints.length=OIMO.MAX_CONSTRAINTS,this.islandNumConstraints=0;switch(f){case OIMO.BROAD_PHASE_BRUTE_FORCE:this.broadPhase=new OIMO.BruteForceBroadPhase;break;case OIMO.BROAD_PHASE_SWEEP_AND_PRUNE:this.broadPhase=new OIMO.SweepAndPruneBroadPhase}for(this.timeStep=1/u,this.iteration=8,this.gravity=new OIMO.Vec3(0,-9.80665,0),this.performance=new OIMO.Performance,r=4,this.detectors=[],this.detectors.length=r,i=0;i<r;i++)this.detectors[i]=[],this.detectors[i].length=r;this.detectors[OIMO.SHAPE_SPHERE][OIMO.SHAPE_SPHERE]=new OIMO.SphereSphereCollisionDetector,this.detectors[OIMO.SHAPE_SPHERE][OIMO.SHAPE_BOX]=new OIMO.SphereBoxCollisionDetector(!1),this.detectors[OIMO.SHAPE_SPHERE][OIMO.SHAPE_CYLINDER]=new OIMO.SphereCylinderCollisionDetector(!1),this.detectors[OIMO.SHAPE_BOX][OIMO.SHAPE_SPHERE]=new OIMO.SphereBoxCollisionDetector(!0),this.detectors[OIMO.SHAPE_BOX][OIMO.SHAPE_BOX]=new OIMO.BoxBoxCollisionDetector,this.detectors[OIMO.SHAPE_CYLINDER][OIMO.SHAPE_SPHERE]=new OIMO.SphereCylinderCollisionDetector(!0),this.detectors[OIMO.SHAPE_BOX][OIMO.SHAPE_CYLINDER]=new OIMO.BoxCylinderCollisionDetector(!1),this.detectors[OIMO.SHAPE_CYLINDER][OIMO.SHAPE_BOX]=new OIMO.BoxCylinderCollisionDetector(!0),this.detectors[OIMO.SHAPE_CYLINDER][OIMO.SHAPE_CYLINDER]=new OIMO.CylinderCylinderCollisionDetector,this.contacts=this.contactPool1,this.prevContacts=this.contactPool2,this.randX=65535,this.randA=98765,this.randB=123456789},OIMO.World.prototype={constructor:OIMO.World,clear:function(){this.randX=65535;for(var t=this.numRigidBodies,n=t-1;n>=0;n--)this.removeRigidBody(this.rigidBodies[n]);for(t=this.numJoints,n=t-1;n>=0;n--)this.removeJoint(this.joints[n])},addRigidBody:function(n){var i,t;if(this.numRigidBodies==OIMO.MAX_BODIES)throw new Error("It is not possible to add a rigid body to the world any more");if(n.parent)throw new Error("It is not possible to be added to more than one world one of the rigid body");for(n.awake(),i=n.numShapes,t=0;t<i;t++)this.addShape(n.shapes[t]);this.rigidBodies[this.numRigidBodies++]=n,n.parent=this},removeRigidBody:function(n){for(var i=null,r,u,f,t=0;t<this.numRigidBodies;t++)if(this.rigidBodies[t]==n){i=n,this.rigidBodies[t]=this.rigidBodies[--this.numRigidBodies],this.rigidBodies[this.numRigidBodies]=null;break}if(i!=null){for(i.awake(),r=i.jointList;r!=null;)u=r.parent,r=r.next,this.removeJoint(u);for(f=i.numShapes,t=0;t<f;t++)this.removeShape(i.shapes[t]);i.parent=null}},addShape:function(n){if(this.numShapes==OIMO.WORLD_MAX_SHAPES)throw new Error("It is not possible to add a shape to the world any more");if(!n.parent)throw new Error("It is not possible to be added alone to shape world");if(n.parent.parent)throw new Error("It is not possible to be added to multiple world the shape of one");this.broadPhase.addProxy(n.proxy),this.shapes[this.numShapes++]=n},removeShape:function(n){for(var i=null,t=0;t<this.numShapes;t++)if(this.shapes[t]==n){i=n,this.shapes[t]=this.shapes[--this.numShapes],this.shapes[this.numShapes]=null;break}i!=null&&this.broadPhase.removeProxy(i.proxy)},addJoint:function(n){if(this.numJoints==OIMO.World.MAX_JOINTS)throw new Error("It is not possible to add a joint to the world any more");if(n.parent)throw new Error("It is not possible to be added to more than one world one of the joint");var t=n.body1,i=n.connection1;t.awake(),t.numJoints++,i.next=t.jointList,t.jointList!=null&&(t.jointList.prev=i),t.jointList=i,t=n.body2,i=n.connection2,t.awake(),t.numJoints++,i.next=t.jointList,t.jointList!=null&&(t.jointList.prev=i),t.jointList=i,this.joints[this.numJoints++]=n,n.parent=this},removeJoint:function(n){for(var i=null,t,r=0;r<this.numJoints;r++)if(this.joints[r]==n){i=n,this.joints[r]=this.joints[--this.numJoints],this.joints[this.numJoints]=null;break}i!=null&&(i.body1.awake(),i.body1.numJoints--,i.body2.awake(),i.body2.numJoints--,t=i.connection1,t.prev!=null&&(t.prev.next=t.next,t.prev=null),t.next!=null&&(t.next.prev=t.prev,t.next=null),t=i.connection2,t.prev!=null&&(t.prev.next=t.next,t.prev=null),t.next!=null&&(t.next.prev=t.prev,t.next=null),i.parent=null)},getByName:function(n){for(var f=null,i,r,u=this.numRigidBodies,t=u-1;t>=0;t--)i=this.rigidBodies[t],i.name!==""&&i.name===n&&(f=i);for(u=this.numJoints,t=u-1;t>=0;t--)r=this.joints[t],r.name!==""&&r.name===n&&(f=r);return f},step:function(){var h=Date.now(),c=this.contacts,r,n,s;for(this.contacts=this.prevContacts,this.prevContacts=c,r=this.numRigidBodies;r--;)if(n=this.rigidBodies[r],n.sleeping){var u=n.linearVelocity,f=n.linearVelocity,e=n.position,o=n.sleepPosition,t=n.orientation,i=n.sleepOrientation;if(u.x!=0||u.y!=0||u.z!=0||f.x!=0||f.y!=0||f.z!=0||e.x!=o.x||e.y!=o.y||e.z!=o.z||t.s!=i.s||t.x!=i.x||t.y!=i.y||t.z!=i.z){n.awake();continue}}this.detectCollisions(),this.updateIslands(),s=Date.now(),this.performance.solvingTime=s-this.performance.solvingTime,this.performance.totalTime=s-h},detectCollisions:function(){this.collectContactInfos(),this.setupContacts()},collectContactInfos:function(){var h=Date.now(),t,r,u,n,i;for(this.broadPhase.detectPairs(),t=Date.now(),this.performance.broadPhaseTime=t-h,this.collisionResult.numContactInfos=0,r=this.broadPhase.pairs,u=this.broadPhase.numPairs,n=0;n<u;n++){var f=r[n],e=f.shape1,o=f.shape2,s=this.detectors[e.type][o.type];if(s&&(s.detectCollision(e,o,this.collisionResult),this.collisionResult.numContactInfos==OIMO.MAX_CONTACTS))return}i=Date.now(),this.performance.narrowPhaseTime=i-t,this.performance.updatingTime=i},setupContacts:function(){var r,n,t,o,f,e,u,i;for(this.numPrevContacts2=this.numPrevContacts1,this.numPrevContacts1=this.numContacts,r=0,n=0;n<this.numPrevContacts1;n++)t=this.prevContacts[n],t.sleeping&&(this.prevContacts[n]=this.contacts[r],this.contacts[r++]=t);for(o=this.collisionResult.contactInfos,this.numContacts=r+this.collisionResult.numContactInfos,n=r;n<this.numContacts;n++)for(this.contacts[n]||(this.contacts[n]=new OIMO.Contact),t=this.contacts[n],t.setupFromContactInfo(o[n-r]),f=t.shape1,e=t.shape2,u=f.numContacts<e.numContacts?f.contactList:e.contactList;u!=null;){if(i=u.parent,(i.shape1==t.shape1&&i.shape2==t.shape2||i.shape1==t.shape2&&i.shape2==t.shape1)&&i.id.equals(t.id)){t.normalImpulse=i.normalImpulse,t.tangentImpulse=i.tangentImpulse,t.binormalImpulse=i.binormalImpulse,t.warmStarted=!0;break}u=u.next}for(n=this.numContacts;n<this.numPrevContacts2;n++)this.contacts[n].removeReferences()},updateIslands:function(){for(var k=1/this.timeStep,u,n,f,d,e,i,w,b,c,l,o,s,t,p,h,r=0;r<this.numShapes;r++)f=this.shapes[r],f.contactList=null,f.numContacts=0;for(r=0;r<this.numRigidBodies;r++)n=this.rigidBodies[r],n.contactList=null,n.addedToIsland=!1;for(this.numConstraints=0,r=0;r<this.numContacts;r++)e=this.contacts[r],e.addedToIsland=!1,i=e.shapeConnection1,f=e.shape1,i.prev=null,i.next=f.contactList,f.contactList!=null&&(f.contactList.prev=i),f.contactList=i,f.numContacts++,i=e.shapeConnection2,f=e.shape2,i.prev=null,i.next=f.contactList,f.contactList!=null&&(f.contactList.prev=i),f.contactList=i,f.numContacts++,i=e.bodyConnection1,n=e.body1,i.prev=null,i.next=n.contactList,n.contactList!=null&&(n.contactList.prev=i),n.contactList=i,i=e.bodyConnection2,n=e.body2,i.prev=null,i.next=n.contactList,n.contactList!=null&&(n.contactList.prev=i),n.contactList=i,this.constraints[this.numConstraints++]=e;for(r=0;r<this.numJoints;r++)u=this.joints[r],u.addedToIsland=!1,this.constraints[this.numConstraints++]=u;for(r=1;r<this.numConstraints;r++)w=(this.randX=this.randX*this.randA+this.randB&2147483647)/2147483648*r|0,u=this.constraints[r],this.constraints[r]=this.constraints[w],this.constraints[w]=u;for(b=Date.now(),this.performance.updatingTime=b-this.performance.updatingTime,this.performance.solvingTime=b,this.numIslands=0,r=0;r<this.numRigidBodies;r++)if(c=this.rigidBodies[r],!c.addedToIsland&&c.type!=OIMO.BODY_STATIC&&!c.sleeping){for(this.islandNumRigidBodies=0,this.islandNumConstraints=0,l=1,this.islandStack[0]=c,c.addedToIsland=!0;l>0;){for(n=this.islandStack[--l],n.sleeping=!1,this.islandRigidBodies[this.islandNumRigidBodies++]=n,i=n.contactList;i!=null;){if(u=i.parent,u.addedToIsland){i=i.next;continue}if(this.islandConstraints[this.islandNumConstraints++]=u,u.addedToIsland=!0,u.sleeping=!1,o=i.connectedBody,o.addedToIsland||o.type==OIMO.BODY_STATIC){i=i.next;continue}this.islandStack[l++]=o,o.addedToIsland=!0,i=i.next}for(s=n.jointList;s!=null;){if(u=s.parent,u.addedToIsland){s=s.next;continue}if(this.islandConstraints[this.islandNumConstraints++]=u,u.addedToIsland=!0,u.sleeping=!1,o=s.connected,o.addedToIsland||o.type==OIMO.BODY_STATIC){s=s.next;continue}this.islandStack[l++]=o,o.addedToIsland=!0,s=s.next}}for(t=0;t<this.islandNumRigidBodies;t++)n=this.islandRigidBodies[t],n.updateVelocity(this.timeStep,this.gravity);for(t=0;t<this.islandNumConstraints;t++)this.islandConstraints[t].preSolve(this.timeStep,k);for(t=0;t<this.iteration;t++)for(p=0;p<this.islandNumConstraints;p++)this.islandConstraints[p].solve();for(t=0;t<this.islandNumConstraints;t++)this.islandConstraints[t].postSolve();for(h=1e3,t=0;t<this.islandNumRigidBodies;t++){if(n=this.islandRigidBodies[t],!n.allowSleep){n.sleepTime=0,h=0;continue}var a=n.linearVelocity.x,v=n.linearVelocity.y,y=n.linearVelocity.z;if(a*a+v*v+y*y>.01){n.sleepTime=0,h=0;continue}if(a=n.angularVelocity.x,v=n.angularVelocity.y,y=n.angularVelocity.z,a*a+v*v+y*y>.04){n.sleepTime=0,h=0;continue}n.sleepTime+=this.timeStep,n.sleepTime<h&&(h=n.sleepTime)}if(h>.5){for(t=0;t<this.islandNumRigidBodies;t++)n=this.islandRigidBodies[t],n.linearVelocity.init(),n.angularVelocity.init(),n.sleepPosition.copy(n.position),n.sleepOrientation.copy(n.orientation),n.sleepTime=0,n.sleeping=!0;for(t=0;t<this.islandNumConstraints;t++)this.islandConstraints[t].sleeping=!0}else for(t=0;t<this.islandNumRigidBodies;t++)this.islandRigidBodies[t].updatePosition(this.timeStep);this.numIslands++}}},OIMO.Performance=function(){this.broadPhaseTime=0,this.narrowPhaseTime=0,this.solvingTime=0,this.updatingTime=0,this.totalTime=0},OIMO.RigidBody=function(n,t,i,r){var h=n||0,f=t||0,e=i||0,o=r||0,u,s,c;this.name="",this.type=0,this.position=null,this.mass=NaN,this.invertMass=NaN,this.shapes=[],this.shapes.length=OIMO.MAX_SHAPES,this.numShapes=0,this.parent=null,this.contactList=null,this.jointList=null,this.numJoints=0,this.addedToIsland=!1,this.sleeping=!1,u=f*f+e*e+o*o,this.position=new OIMO.Vec3,u>0&&(u=1/Math.sqrt(u),f*=u,e*=u,o*=u),s=Math.sin(h*.5),c=Math.cos(h*.5),this.orientation=new OIMO.Quat(c,s*f,s*e,s*o),this.linearVelocity=new OIMO.Vec3,this.angularVelocity=new OIMO.Vec3,this.sleepPosition=new OIMO.Vec3,this.sleepOrientation=new OIMO.Quat,this.rotation=new OIMO.Mat33,this.invertInertia=new OIMO.Mat33,this.localInertia=new OIMO.Mat33,this.invertLocalInertia=new OIMO.Mat33,this.matrix=new OIMO.Mat44,this.allowSleep=!0,this.sleepTime=0},OIMO.RigidBody.prototype={constructor:OIMO.RigidBody,addShape:function(n){if(this.numShapes==OIMO.MAX_SHAPES)throw new Error("It is not possible to add more shape to the rigid");if(n.parent)throw new Error("It is not possible that you add to the multi-rigid body the shape of one");this.shapes[this.numShapes++]=n,n.parent=this,this.parent&&this.parent.addShape(n)},removeShape:function(n,t){var i,u,r;if(arguments.length<2&&(t=-1),t<0){for(i=0;i<this.numShapes;i++)if(n==this.shapes[i]){t=i;break}if(t==-1)return}else if(t>=this.numShapes)throw new Error("The index of the shape you want to delete is out of range");for(u=this.shapes[t],u.parent=null,this.parent&&this.parent.removeShape(u),this.numShapes--,r=t;r<this.numShapes;r++)this.shapes[r]=this.shapes[r+1];this.shapes[this.numShapes]=null},setupMass:function(n){var r,w,k,i,d,t;this.type=n||OIMO.BODY_DYNAMIC,this.position.init(),this.mass=0,this.localInertia.init(0,0,0,0,0,0,0,0,0),r=this.localInertia.elements,w=new OIMO.Mat33,w.transpose(this.rotation);var b=new OIMO.Mat33,ni=new OIMO.Vec3,gt=0;for(k=0;k<this.numShapes;k++)i=this.shapes[k],i.relativeRotation.mul(w,i.rotation),this.position.add(this.position,ni.scale(i.position,i.mass)),gt+=i.mass,this.mass+=i.mass,b.mul(i.relativeRotation,b.mul(i.localInertia,b.transpose(i.relativeRotation))),this.localInertia.add(this.localInertia,b);this.position.scale(this.position,1/gt),this.invertMass=1/this.mass;var g=0,nt=0,tt=0;for(d=0;d<this.numShapes;d++)i=this.shapes[d],t=i.localRelativePosition,t.sub(i.position,this.position).mulMat(w,t),i.updateProxy(),r[0]+=i.mass*(t.y*t.y+t.z*t.z),r[4]+=i.mass*(t.x*t.x+t.z*t.z),r[8]+=i.mass*(t.x*t.x+t.y*t.y),g-=i.mass*t.x*t.y,nt-=i.mass*t.y*t.z,tt-=i.mass*t.z*t.x;r[1]=g,r[3]=g,r[2]=tt,r[6]=tt,r[5]=nt,r[7]=nt,this.invertLocalInertia.invert(this.localInertia),n==OIMO.BODY_STATIC&&(this.invertMass=0,this.invertLocalInertia.init(0,0,0,0,0,0,0,0,0));var u=this.rotation.elements,f=this.invertLocalInertia.elements,o=u[0],s=u[1],h=u[2],c=u[3],l=u[4],a=u[5],v=u[6],y=u[7],p=u[8],it=f[0],rt=f[1],ut=f[2],ft=f[3],et=f[4],ot=f[5],st=f[6],ht=f[7],ct=f[8],lt=o*it+s*ft+h*st,at=o*rt+s*et+h*ht,vt=o*ut+s*ot+h*ct,yt=c*it+l*ft+a*st,pt=c*rt+l*et+a*ht,wt=c*ut+l*ot+a*ct,bt=v*it+y*ft+p*st,kt=v*rt+y*et+p*ht,dt=v*ut+y*ot+p*ct,e=this.invertInertia.elements;e[0]=lt*o+at*s+vt*h,e[1]=lt*c+at*l+vt*a,e[2]=lt*v+at*y+vt*p,e[3]=yt*o+pt*s+wt*h,e[4]=yt*c+pt*l+wt*a,e[5]=yt*v+pt*y+wt*p,e[6]=bt*o+kt*s+dt*h,e[7]=bt*c+kt*l+dt*a,e[8]=bt*v+kt*y+dt*p,this.syncShapes(),this.awake()},awake:function(){var n,t;if(this.allowSleep){if(this.sleepTime=0,this.sleeping){for(n=this.contactList;n!=null;)n.connectedBody.sleepTime=0,n.connectedBody.sleeping=!1,n.parent.sleeping=!1,n=n.next;for(t=this.jointList;t!=null;)t.connected.sleepTime=0,t.connected.sleeping=!1,t.parent.sleeping=!1,t=t.next}this.sleeping=!1}},sleep:function(){this.allowSleep&&(this.linearVelocity.init(),this.angularVelocity.init(),this.sleepPosition.copy(this.position),this.sleepOrientation.copy(this.orientation),this.sleepTime=0,this.sleeping=!0)},updateVelocity:function(n,t){this.type==OIMO.BODY_DYNAMIC&&(this.linearVelocity.x+=t.x*n,this.linearVelocity.y+=t.y*n,this.linearVelocity.z+=t.z*n)},updatePosition:function(n){if(this.allowSleep||(this.sleepTime=0),this.type==OIMO.BODY_STATIC)this.linearVelocity.x=0,this.linearVelocity.y=0,this.linearVelocity.z=0,this.angularVelocity.x=0,this.angularVelocity.y=0,this.angularVelocity.z=0;else if(this.type==OIMO.BODY_DYNAMIC){var t=this.linearVelocity.x,i=this.linearVelocity.y,r=this.linearVelocity.z;t*t+i*i+r*r>.01&&(this.sleepTime=0),this.position.x+=t*n,this.position.y+=i*n,this.position.z+=r*n,t=this.angularVelocity.x,i=this.angularVelocity.y,r=this.angularVelocity.z,t*t+i*i+r*r>.025&&(this.sleepTime=0);var u=this.orientation.s,f=this.orientation.x,e=this.orientation.y,o=this.orientation.z;n*=.5;var s=(-t*f-i*e-r*o)*n,h=(t*u+i*o-r*e)*n,c=(-t*o+i*u+r*f)*n,l=(t*e-i*f+r*u)*n;u+=s,f+=h,e+=c,o+=l,s=1/Math.sqrt(u*u+f*f+e*e+o*o),this.orientation.s=u*s,this.orientation.x=f*s,this.orientation.y=e*s,this.orientation.z=o*s}else throw new Error("The type of rigid body of undefined");this.syncShapes()},syncShapes:function(){var ot=this.orientation.s,ut=this.orientation.x,st=this.orientation.y,ii=this.orientation.z,ri=2*ut,ht=2*st,ft=2*ii,ui=ut*ri,fi=st*ht,ei=ii*ft,oi=ut*ht,si=st*ft,hi=ut*ft,ci=ot*ri,li=ot*ht,ai=ot*ft,n=this.rotation.elements,c=this.invertLocalInertia.elements,et;n[0]=1-fi-ei,n[1]=oi-ai,n[2]=hi+li,n[3]=oi+ai,n[4]=1-ui-ei,n[5]=si-ci,n[6]=hi-li,n[7]=si+ci,n[8]=1-ui-fi;var t=n[0],i=n[1],r=n[2],u=n[3],f=n[4],e=n[5],o=n[6],s=n[7],h=n[8],ct=c[0],lt=c[1],at=c[2],vt=c[3],yt=c[4],pt=c[5],wt=c[6],bt=c[7],kt=c[8],p=t*ct+i*vt+r*wt,w=t*lt+i*yt+r*bt,b=t*at+i*pt+r*kt,k=u*ct+f*vt+e*wt,d=u*lt+f*yt+e*bt,g=u*at+f*pt+e*kt,nt=o*ct+s*vt+h*wt,tt=o*lt+s*yt+h*bt,it=o*at+s*pt+h*kt,l=this.invertInertia.elements;for(l[0]=p*t+w*i+b*r,l[1]=p*u+w*f+b*e,l[2]=p*o+w*s+b*h,l[3]=k*t+d*i+g*r,l[4]=k*u+d*f+g*e,l[5]=k*o+d*s+g*h,l[6]=nt*t+tt*i+it*r,l[7]=nt*u+tt*f+it*e,l[8]=nt*o+tt*s+it*h,et=0;et<this.numShapes;et++){var y=this.shapes[et],rt=y.relativePosition,dt=y.localRelativePosition,a=y.relativeRotation.elements,v=y.rotation.elements,gt=dt.x,ni=dt.y,ti=dt.z;rt.x=gt*t+ni*i+ti*r,rt.y=gt*u+ni*f+ti*e,rt.z=gt*o+ni*s+ti*h,y.position.x=this.position.x+rt.x,y.position.y=this.position.y+rt.y,y.position.z=this.position.z+rt.z,p=a[0],w=a[1],b=a[2],k=a[3],d=a[4],g=a[5],nt=a[6],tt=a[7],it=a[8],v[0]=t*p+i*k+r*nt,v[1]=t*w+i*d+r*tt,v[2]=t*b+i*g+r*it,v[3]=u*p+f*k+e*nt,v[4]=u*w+f*d+e*tt,v[5]=u*b+f*g+e*it,v[6]=o*p+s*k+h*nt,v[7]=o*w+s*d+h*tt,v[8]=o*b+s*g+h*it,y.updateProxy()}},applyImpulse:function(n,t){this.linearVelocity.x+=t.x*this.invertMass,this.linearVelocity.y+=t.y*this.invertMass,this.linearVelocity.z+=t.z*this.invertMass;var i=new OIMO.Vec3;i.sub(n,this.position).cross(i,t).mulMat(this.invertInertia,i),this.angularVelocity.x+=i.x,this.angularVelocity.y+=i.y,this.angularVelocity.z+=i.z},setPosition:function(n,t,i){this.position.init(n*OIMO.INV_SCALE,t*OIMO.INV_SCALE,i*OIMO.INV_SCALE),this.linearVelocity.init(),this.angularVelocity.init()},getMatrix:function(){var n=this.matrix.elements,t,i;return this.sleeping?n[15]=1:(t=this.rotation.elements,n[0]=t[0],n[1]=t[3],n[2]=t[6],n[3]=0,n[4]=t[1],n[5]=t[4],n[6]=t[7],n[7]=0,n[8]=t[2],n[9]=t[5],n[10]=t[8],n[11]=0,i=this.position,n[12]=i.x*OIMO.WORLD_SCALE,n[13]=i.y*OIMO.WORLD_SCALE,n[14]=i.z*OIMO.WORLD_SCALE,n[15]=0),n}},OIMO.Pair=function(){this.shape1=null,this.shape2=null},OIMO.Proxy=function(n,t,i,r,u,f){this.minX=n||0,this.maxX=t||0,this.minY=i||0,this.maxY=r||0,this.minZ=u||0,this.maxZ=f||0,this.parent=null},OIMO.Proxy.prototype={constructor:OIMO.Proxy,init:function(n,t,i,r,u,f){this.minX=n||0,this.maxX=t||0,this.minY=i||0,this.maxY=r||0,this.minZ=u||0,this.maxZ=f||0},intersect:function(n){return this.maxX>n.minX&&this.minX<n.maxX&&this.maxY>n.minY&&this.minY<n.maxY&&this.maxZ>n.minZ&&this.minZ<n.maxZ}},OIMO.BroadPhase=function(){this.numPairChecks=0,this.numPairs=0,this.bufferSize=256,this.pairs=[],this.pairs.length=this.bufferSize;for(var n=0;n<this.bufferSize;n++)this.pairs[n]=new OIMO.Pair},OIMO.BroadPhase.prototype={constructor:OIMO.BroadPhase,createProxy:function(){throw new Error("Inheritance error.");},addProxy:function(){throw new Error("Inheritance error.");},removeProxy:function(){throw new Error("Inheritance error.");},isAvailablePair:function(n,t){var i=n.parent,r=t.parent,u,f;if(i==r||(i.type==OIMO.BODY_STATIC||i.sleeping)&&(r.type==OIMO.BODY_STATIC||r.sleeping))return!1;for(u=i.numJoints<r.numJoints?i.jointList:r.jointList;u!=null;){if(f=u.parent,!f.allowCollision&&(f.body1==i&&f.body2==r||f.body1==r&&f.body2==i))return!1;u=u.next}return!0},detectPairs:function(){while(this.numPairs>0){var n=this.pairs[--this.numPairs];n.shape1=null,n.shape2=null}this.collectPairs()},collectPairs:function(){throw new Error("Inheritance error.");},addPair:function(n,t){var u,r,i,f;if(this.numPairs==this.bufferSize){for(u=this.bufferSize<<1,r=[],i=0;i<this.bufferSize;i++)r[i]=this.pairs[i];for(i=this.bufferSize;i<u;i++)r[i]=new OIMO.Pair;this.pairs=r,this.bufferSize=u}f=this.pairs[this.numPairs++],f.shape1=n,f.shape2=t}},OIMO.BruteForceBroadPhase=function(){OIMO.BroadPhase.call(this),this.numProxies=0,this.proxyPool=[],this.proxyPool.length=OIMO.WORLD_MAX_SHAPES},OIMO.BruteForceBroadPhase.prototype=Object.create(OIMO.BroadPhase.prototype),OIMO.BruteForceBroadPhase.prototype.addProxy=function(n){this.proxyPool[this.numProxies]=n,this.numProxies++},OIMO.BruteForceBroadPhase.prototype.removeProxy=function(n){for(var r=-1,i,t=0;t<this.numProxies;t++)if(this.proxyPool[t]==n){r=t;break}if(r!=-1){for(i=r;i<this.numProxies-1;i++)this.proxyPool[i]=this.proxyPool[i+1];this.proxyPool[this.numProxies]=null,this.numProxies--}},OIMO.BruteForceBroadPhase.prototype.collectPairs=function(){var i,n,u,r,t,f;for(this.numPairChecks=this.numProxies*(this.numProxies-1)>>1,i=0;i<this.numProxies;i++)for(n=this.proxyPool[i],u=n.parent,r=i+1;r<this.numProxies;r++)(t=this.proxyPool[r],f=t.parent,n.maxX<t.minX||n.minX>t.maxX||n.maxY<t.minY||n.minY>t.maxY||n.maxZ<t.minZ||n.minZ>t.maxZ||!this.isAvailablePair(u,f))||this.addPair(u,f)},OIMO.SweepAndPruneBroadPhase=function(){OIMO.BroadPhase.call(this),this.numProxies=0,this.sortAxis=0,this.proxyPoolAxis=[],this.proxyPoolAxis.length=3,this.proxyPoolAxis[0]=[],this.proxyPoolAxis[1]=[],this.proxyPoolAxis[2]=[],this.proxyPoolAxis[0].length=OIMO.WORLD_MAX_SHAPES,this.proxyPoolAxis[1].length=OIMO.WORLD_MAX_SHAPES,this.proxyPoolAxis[2].length=OIMO.WORLD_MAX_SHAPES},OIMO.SweepAndPruneBroadPhase.prototype=Object.create(OIMO.BroadPhase.prototype),OIMO.SweepAndPruneBroadPhase.prototype.addProxy=function(n){this.proxyPoolAxis[0][this.numProxies]=n,this.proxyPoolAxis[1][this.numProxies]=n,this.proxyPoolAxis[2][this.numProxies]=n,this.numProxies++},OIMO.SweepAndPruneBroadPhase.prototype.removeProxy=function(n){this.removeProxyAxis(n,this.proxyPoolAxis[0]),this.removeProxyAxis(n,this.proxyPoolAxis[1]),this.removeProxyAxis(n,this.proxyPoolAxis[2]),this.numProxies--},OIMO.SweepAndPruneBroadPhase.prototype.collectPairs=function(){this.numPairChecks=0;var n=this.proxyPoolAxis[this.sortAxis],t;this.sortAxis==0?(this.insertionSortX(n),this.sweepX(n)):this.sortAxis==1?(this.insertionSortY(n),this.sweepY(n)):(this.insertionSortZ(n),this.sweepZ(n))},OIMO.SweepAndPruneBroadPhase.prototype.sweepX=function(n){for(var i,u=0,v=0,f=0,y=0,e=0,p=0,h=1/this.numProxies,w=OIMO.BODY_STATIC,t,l,s,r,a,o=0,c=this.numProxies;o<c;o++)for(t=n[o],i=t.minX+t.maxX,u+=i,v+=i*i,i=t.minY+t.maxY,f+=i,y+=i*i,i=t.minZ+t.maxZ,e+=i,p+=i*i,l=t.parent,s=o+1;s<c;s++){if(r=n[s],this.numPairChecks++,t.maxX<r.minX)break;(a=r.parent,t.maxY<r.minY||t.minY>r.maxY||t.maxZ<r.minZ||t.minZ>r.maxZ||!this.isAvailablePair(l,a))||this.addPair(l,a)}u=v-u*u*h,f=y-f*f*h,e=p-e*e*h,this.sortAxis=u>f?u>e?0:2:f>e?1:2},OIMO.SweepAndPruneBroadPhase.prototype.sweepY=function(n){for(var i,u=0,v=0,f=0,y=0,e=0,p=0,h=1/this.numProxies,w=OIMO.BODY_STATIC,t,l,s,r,a,o=0,c=this.numProxies;o<c;o++)for(t=n[o],i=t.minX+t.maxX,u+=i,v+=i*i,i=t.minY+t.maxY,f+=i,y+=i*i,i=t.minZ+t.maxZ,e+=i,p+=i*i,l=t.parent,s=o+1;s<c;s++){if(r=n[s],this.numPairChecks++,t.maxY<r.minY)break;(a=r.parent,t.maxX<r.minX||t.minX>r.maxX||t.maxZ<r.minZ||t.minZ>r.maxZ||!this.isAvailablePair(l,a))||this.addPair(l,a)}u=v-u*u*h,f=y-f*f*h,e=p-e*e*h,this.sortAxis=u>f?u>e?0:2:f>e?1:2},OIMO.SweepAndPruneBroadPhase.prototype.sweepZ=function(n){for(var i,u=0,v=0,f=0,y=0,e=0,p=0,h=1/this.numProxies,w=OIMO.BODY_STATIC,t,l,s,r,a,o=0,c=this.numProxies;o<c;o++)for(t=n[o],i=t.minX+t.maxX,u+=i,v+=i*i,i=t.minY+t.maxY,f+=i,y+=i*i,i=t.minZ+t.maxZ,e+=i,p+=i*i,l=t.parent,s=o+1;s<c;s++){if(r=n[s],this.numPairChecks++,t.maxZ<r.minZ)break;(a=r.parent,t.maxX<r.minX||t.minX>r.maxX||t.maxY<r.minY||t.minY>r.maxY||!this.isAvailablePair(l,a))||this.addPair(l,a)}u=v-u*u*h,f=y-f*f*h,e=p-e*e*h,this.sortAxis=u>f?u>e?0:2:f>e?1:2},OIMO.SweepAndPruneBroadPhase.prototype.removeProxyAxis=function(n,t){for(var u=-1,r,i=0,f=this.numProxies;i<f;i++)if(t[i]==n){u=i;break}if(u!=-1){for(r=u;r<f-1;r++)t[r]=t[r+1];t[this.numProxies]=null}},OIMO.SweepAndPruneBroadPhase.prototype.insertionSortX=function(n){var i,u,r,t;if(this.numProxies!=1)for(i=1,u=this.numProxies;i<u;i++)if(r=n[i],n[i-1].minX>r.minX){t=i;do n[t]=n[t-1],t--;while(t>0&&n[t-1].minX>r.minX);n[t]=r}},OIMO.SweepAndPruneBroadPhase.prototype.insertionSortY=function(n){var i,u,r,t;if(this.numProxies!=1)for(i=1,u=this.numProxies;i<u;i++)if(r=n[i],n[i-1].minY>r.minY){t=i;do n[t]=n[t-1],t--;while(t>0&&n[t-1].minY>r.minY);n[t]=r}},OIMO.SweepAndPruneBroadPhase.prototype.insertionSortZ=function(n){var i,u,r,t;if(this.numProxies!=1)for(i=1,u=this.numProxies;i<u;i++)if(r=n[i],n[i-1].minZ>r.minZ){t=i;do n[t]=n[t-1],t--;while(t>0&&n[t-1].minZ>r.minZ);n[t]=r}},OIMO.CollisionDetector=function(){this.flip=!1},OIMO.CollisionDetector.prototype={constructor:OIMO.CollisionDetector,detectCollision:function(){throw new Error("detectCollision Function is not inherited");}},OIMO.CollisionResult=function(n){this.numContactInfos=0,this.maxContactInfos=n,this.contactInfos=[]},OIMO.CollisionResult.prototype={constructor:OIMO.CollisionResult,addContactInfo:function(n,t,i,r,u,f,e,o,s,h,c,l){if(this.numContactInfos!=this.maxContactInfos){this.contactInfos[this.numContactInfos]||(this.contactInfos[this.numContactInfos]=new OIMO.ContactInfo);var a=this.contactInfos[this.numContactInfos++];a.position.x=n,a.position.y=t,a.position.z=i,a.normal.x=r,a.normal.y=u,a.normal.z=f,a.overlap=e,a.shape1=o,a.shape2=s,a.id.data1=h,a.id.data2=c,a.id.flip=l}}},OIMO.ContactID=function(){this.data1=0,this.data2=0,this.flip=!1},OIMO.ContactID.prototype={constructor:OIMO.ContactID,equals:function(n){return this.flip==n.flip?this.data1==n.data1&&this.data2==n.data2:this.data2==n.data1&&this.data1==n.data2}},OIMO.ContactInfo=function(){this.overlap=NaN,this.shape1=null,this.shape2=null,this.position=new OIMO.Vec3,this.normal=new OIMO.Vec3,this.id=new OIMO.ContactID},OIMO.BoxBoxCollisionDetector=function(){OIMO.CollisionDetector.call(this),this.clipVertices1=[],this.clipVertices2=[],this.clipVertices1.length=24,this.clipVertices2.length=24,this.used=[],this.INF=1/0},OIMO.BoxBoxCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype),OIMO.BoxBoxCollisionDetector.prototype.detectCollision=function(n,t,i){var s,h,r,g,et,b,k,d,br,kr,dr,lu,au,vu,tt,gi,nt,o,y,p,w,st,ht,ct,it,oh;n.id<t.id?(s=n,h=t):(s=t,h=n);var hs=s.position,cs=h.position,ne=hs.x,te=hs.y,ie=hs.z,re=cs.x,ue=cs.y,fe=cs.z,tr=re-ne,ir=ue-te,rr=fe-ie,gr=s.halfWidth,nu=s.halfHeight,tu=s.halfDepth,iu=h.halfWidth,ru=h.halfHeight,uu=h.halfDepth,to=s.halfDirectionWidth.x,io=s.halfDirectionWidth.y,ro=s.halfDirectionWidth.z,uo=s.halfDirectionHeight.x,fo=s.halfDirectionHeight.y,eo=s.halfDirectionHeight.z,oo=s.halfDirectionDepth.x,so=s.halfDirectionDepth.y,ho=s.halfDirectionDepth.z,co=h.halfDirectionWidth.x,lo=h.halfDirectionWidth.y,ao=h.halfDirectionWidth.z,vo=h.halfDirectionHeight.x,yo=h.halfDirectionHeight.y,po=h.halfDirectionHeight.z,wo=h.halfDirectionDepth.x,bo=h.halfDirectionDepth.y,ko=h.halfDirectionDepth.z,lt=s.normalDirectionWidth.x,at=s.normalDirectionWidth.y,vt=s.normalDirectionWidth.z,yt=s.normalDirectionHeight.x,pt=s.normalDirectionHeight.y,wt=s.normalDirectionHeight.z,bt=s.normalDirectionDepth.x,kt=s.normalDirectionDepth.y,dt=s.normalDirectionDepth.z,gt=h.normalDirectionWidth.x,ni=h.normalDirectionWidth.y,ti=h.normalDirectionWidth.z,ii=h.normalDirectionHeight.x,ri=h.normalDirectionHeight.y,ui=h.normalDirectionHeight.z,fi=h.normalDirectionDepth.x,ei=h.normalDirectionDepth.y,oi=h.normalDirectionDepth.z,yu=at*ti-vt*ni,pu=vt*gt-lt*ti,wu=lt*ni-at*gt,bu=at*ui-vt*ri,ku=vt*ii-lt*ui,du=lt*ri-at*ii,gu=at*oi-vt*ei,nf=vt*fi-lt*oi,tf=lt*ei-at*fi,rf=pt*ti-wt*ni,uf=wt*gt-yt*ti,ff=yt*ni-pt*gt,ef=pt*ui-wt*ri,of=wt*ii-yt*ui,sf=yt*ri-pt*ii,hf=pt*oi-wt*ei,cf=wt*fi-yt*oi,lf=yt*ei-pt*fi,af=kt*ti-dt*ni,vf=dt*gt-bt*ti,yf=bt*ni-kt*gt,pf=kt*ui-dt*ri,wf=dt*ii-bt*ui,bf=bt*ri-kt*ii,kf=kt*oi-dt*ei,df=dt*fi-bt*oi,gf=bt*ei-kt*fi,ls,as,vs,ys,ps,ws,go,ns,ts,is,rs,us,fs,es,os,ss,ye,pe,we,be,ke,ee,oe,se,he,ce,le,ae,ve,de,ds=!1,gs=!1,nh=!1,th=!1,ih=!1,rh=!1,uh=!1,fh=!1,eh=!1,e,rt,ut,u,f,ft;if((e=lt*tr+at*ir+vt*rr,ls=e>0,ls||(e=-e),rt=gr,u=lt*gt+at*ni+vt*ti,f=lt*ii+at*ri+vt*ui,ft=lt*fi+at*ei+vt*oi,u<0&&(u=-u),f<0&&(f=-f),ft<0&&(ft=-ft),ut=u*iu+f*ru+ft*uu,ss=e-rt-ut,!(ss>0))&&(e=yt*tr+pt*ir+wt*rr,as=e>0,as||(e=-e),rt=nu,u=yt*gt+pt*ni+wt*ti,f=yt*ii+pt*ri+wt*ui,ft=yt*fi+pt*ei+wt*oi,u<0&&(u=-u),f<0&&(f=-f),ft<0&&(ft=-ft),ut=u*iu+f*ru+ft*uu,ye=e-rt-ut,!(ye>0))&&(e=bt*tr+kt*ir+dt*rr,vs=e>0,vs||(e=-e),rt=tu,u=bt*gt+kt*ni+dt*ti,f=bt*ii+kt*ri+dt*ui,ft=bt*fi+kt*ei+dt*oi,u<0&&(u=-u),f<0&&(f=-f),ft<0&&(ft=-ft),ut=u*iu+f*ru+ft*uu,pe=e-rt-ut,!(pe>0))&&(e=gt*tr+ni*ir+ti*rr,ys=e>0,ys||(e=-e),u=gt*lt+ni*at+ti*vt,f=gt*yt+ni*pt+ti*wt,ft=gt*bt+ni*kt+ti*dt,u<0&&(u=-u),f<0&&(f=-f),ft<0&&(ft=-ft),rt=u*gr+f*nu+ft*tu,ut=iu,we=(e-rt-ut)*1,!(we>0))&&(e=ii*tr+ri*ir+ui*rr,ps=e>0,ps||(e=-e),u=ii*lt+ri*at+ui*vt,f=ii*yt+ri*pt+ui*wt,ft=ii*bt+ri*kt+ui*dt,u<0&&(u=-u),f<0&&(f=-f),ft<0&&(ft=-ft),rt=u*gr+f*nu+ft*tu,ut=ru,be=(e-rt-ut)*1,!(be>0))&&(e=fi*tr+ei*ir+oi*rr,ws=e>0,ws||(e=-e),u=fi*lt+ei*at+oi*vt,f=fi*yt+ei*pt+oi*wt,ft=fi*bt+ei*kt+oi*dt,u<0&&(u=-u),f<0&&(f=-f),ft<0&&(ft=-ft),rt=u*gr+f*nu+ft*tu,ut=uu,ke=(e-rt-ut)*1,!(ke>0))){if(e=yu*yu+pu*pu+wu*wu,e>1e-5){if(e=1/Math.sqrt(e),yu*=e,pu*=e,wu*=e,e=yu*tr+pu*ir+wu*rr,go=e>0,go||(e=-e),u=yu*yt+pu*pt+wu*wt,f=yu*bt+pu*kt+wu*dt,u<0&&(u=-u),f<0&&(f=-f),rt=u*nu+f*tu,u=yu*ii+pu*ri+wu*ui,f=yu*fi+pu*ei+wu*oi,u<0&&(u=-u),f<0&&(f=-f),ut=u*ru+f*uu,ee=e-rt-ut,ee>0)return}else go=!1,ee=0,ds=!0;if(e=bu*bu+ku*ku+du*du,e>1e-5){if(e=1/Math.sqrt(e),bu*=e,ku*=e,du*=e,e=bu*tr+ku*ir+du*rr,ns=e>0,ns||(e=-e),u=bu*yt+ku*pt+du*wt,f=bu*bt+ku*kt+du*dt,u<0&&(u=-u),f<0&&(f=-f),rt=u*nu+f*tu,u=bu*gt+ku*ni+du*ti,f=bu*fi+ku*ei+du*oi,u<0&&(u=-u),f<0&&(f=-f),ut=u*iu+f*uu,oe=e-rt-ut,oe>0)return}else ns=!1,oe=0,gs=!0;if(e=gu*gu+nf*nf+tf*tf,e>1e-5){if(e=1/Math.sqrt(e),gu*=e,nf*=e,tf*=e,e=gu*tr+nf*ir+tf*rr,ts=e>0,ts||(e=-e),u=gu*yt+nf*pt+tf*wt,f=gu*bt+nf*kt+tf*dt,u<0&&(u=-u),f<0&&(f=-f),rt=u*nu+f*tu,u=gu*gt+nf*ni+tf*ti,f=gu*ii+nf*ri+tf*ui,u<0&&(u=-u),f<0&&(f=-f),ut=u*iu+f*ru,se=e-rt-ut,se>0)return}else ts=!1,se=0,nh=!0;if(e=rf*rf+uf*uf+ff*ff,e>1e-5){if(e=1/Math.sqrt(e),rf*=e,uf*=e,ff*=e,e=rf*tr+uf*ir+ff*rr,is=e>0,is||(e=-e),u=rf*lt+uf*at+ff*vt,f=rf*bt+uf*kt+ff*dt,u<0&&(u=-u),f<0&&(f=-f),rt=u*gr+f*tu,u=rf*ii+uf*ri+ff*ui,f=rf*fi+uf*ei+ff*oi,u<0&&(u=-u),f<0&&(f=-f),ut=u*ru+f*uu,he=e-rt-ut,he>0)return}else is=!1,he=0,th=!0;if(e=ef*ef+of*of+sf*sf,e>1e-5){if(e=1/Math.sqrt(e),ef*=e,of*=e,sf*=e,e=ef*tr+of*ir+sf*rr,rs=e>0,rs||(e=-e),u=ef*lt+of*at+sf*vt,f=ef*bt+of*kt+sf*dt,u<0&&(u=-u),f<0&&(f=-f),rt=u*gr+f*tu,u=ef*gt+of*ni+sf*ti,f=ef*fi+of*ei+sf*oi,u<0&&(u=-u),f<0&&(f=-f),ut=u*iu+f*uu,ce=e-rt-ut,ce>0)return}else rs=!1,ce=0,ih=!0;if(e=hf*hf+cf*cf+lf*lf,e>1e-5){if(e=1/Math.sqrt(e),hf*=e,cf*=e,lf*=e,e=hf*tr+cf*ir+lf*rr,us=e>0,us||(e=-e),u=hf*lt+cf*at+lf*vt,f=hf*bt+cf*kt+lf*dt,u<0&&(u=-u),f<0&&(f=-f),rt=u*gr+f*tu,u=hf*gt+cf*ni+lf*ti,f=hf*ii+cf*ri+lf*ui,u<0&&(u=-u),f<0&&(f=-f),ut=u*iu+f*ru,le=e-rt-ut,le>0)return}else us=!1,le=0,rh=!0;if(e=af*af+vf*vf+yf*yf,e>1e-5){if(e=1/Math.sqrt(e),af*=e,vf*=e,yf*=e,e=af*tr+vf*ir+yf*rr,fs=e>0,fs||(e=-e),u=af*lt+vf*at+yf*vt,f=af*yt+vf*pt+yf*wt,u<0&&(u=-u),f<0&&(f=-f),rt=u*gr+f*nu,u=af*ii+vf*ri+yf*ui,f=af*fi+vf*ei+yf*oi,u<0&&(u=-u),f<0&&(f=-f),ut=u*ru+f*uu,ae=e-rt-ut,ae>0)return}else fs=!1,ae=0,uh=!0;if(e=pf*pf+wf*wf+bf*bf,e>1e-5){if(e=1/Math.sqrt(e),pf*=e,wf*=e,bf*=e,e=pf*tr+wf*ir+bf*rr,es=e>0,es||(e=-e),u=pf*lt+wf*at+bf*vt,f=pf*yt+wf*pt+bf*wt,u<0&&(u=-u),f<0&&(f=-f),rt=u*gr+f*nu,u=pf*gt+wf*ni+bf*ti,f=pf*fi+wf*ei+bf*oi,u<0&&(u=-u),f<0&&(f=-f),ut=u*iu+f*uu,ve=e-rt-ut,ve>0)return}else es=!1,ve=0,fh=!0;if(e=kf*kf+df*df+gf*gf,e>1e-5){if(e=1/Math.sqrt(e),kf*=e,df*=e,gf*=e,e=kf*tr+df*ir+gf*rr,os=e>0,os||(e=-e),u=kf*lt+df*at+gf*vt,f=kf*yt+df*pt+gf*wt,u<0&&(u=-u),f<0&&(f=-f),rt=u*gr+f*nu,u=kf*gt+df*ni+gf*ti,f=kf*ii+df*ri+gf*ui,u<0&&(u=-u),f<0&&(f=-f),ut=u*iu+f*ru,de=e-rt-ut,de>0)return}else os=!1,de=0,eh=!0;var di=ss,si=ss,nr=0,ki=ls;ye>si&&(di=ye,si=ye,nr=1,ki=as),pe>si&&(di=pe,si=pe,nr=2,ki=vs),we-.005>si&&(di=we,si=we-.005,nr=3,ki=ys),be-.005>si&&(di=be,si=be-.005,nr=4,ki=ps),ke-.005>si&&(di=ke,si=ke-.005,nr=5,ki=ws),ee-.01>si&&!ds&&(di=ee,si=ee-.01,nr=6,ki=go),oe-.01>si&&!gs&&(di=oe,si=oe-.01,nr=7,ki=ns),se-.01>si&&!nh&&(di=se,si=se-.01,nr=8,ki=ts),he-.01>si&&!th&&(di=he,si=he-.01,nr=9,ki=is),ce-.01>si&&!ih&&(di=ce,si=ce-.01,nr=10,ki=rs),le-.01>si&&!rh&&(di=le,si=le-.01,nr=11,ki=us),ae-.01>si&&!uh&&(di=ae,si=ae-.01,nr=12,ki=fs),ve-.01>si&&!fh&&(di=ve,si=ve-.01,nr=13,ki=es),de-.01>si&&!eh&&(di=de,nr=14,ki=os);var c=0,l=0,a=0,ai=0,vi=0,yi=0,pi=0,wi=0,bi=0,hi=0,ci=0,li=0,fu=0,eu=0,ou=0,su=0,hu=0,cu=0,ge=!1;switch(nr){case 0:ki?(hi=ne+to,ci=te+io,li=ie+ro,c=lt,l=at,a=vt):(hi=ne-to,ci=te-io,li=ie-ro,c=-lt,l=-at,a=-vt),fu=uo,eu=fo,ou=eo,ai=-yt,vi=-pt,yi=-wt,su=oo,hu=so,cu=ho,pi=-bt,wi=-kt,bi=-dt;break;case 1:ki?(hi=ne+uo,ci=te+fo,li=ie+eo,c=yt,l=pt,a=wt):(hi=ne-uo,ci=te-fo,li=ie-eo,c=-yt,l=-pt,a=-wt),fu=to,eu=io,ou=ro,ai=-lt,vi=-at,yi=-vt,su=oo,hu=so,cu=ho,pi=-bt,wi=-kt,bi=-dt;break;case 2:ki?(hi=ne+oo,ci=te+so,li=ie+ho,c=bt,l=kt,a=dt):(hi=ne-oo,ci=te-so,li=ie-ho,c=-bt,l=-kt,a=-dt),fu=to,eu=io,ou=ro,ai=-lt,vi=-at,yi=-vt,su=uo,hu=fo,cu=eo,pi=-yt,wi=-pt,bi=-wt;break;case 3:ge=!0,ki?(hi=re-co,ci=ue-lo,li=fe-ao,c=-gt,l=-ni,a=-ti):(hi=re+co,ci=ue+lo,li=fe+ao,c=gt,l=ni,a=ti),fu=vo,eu=yo,ou=po,ai=-ii,vi=-ri,yi=-ui,su=wo,hu=bo,cu=ko,pi=-fi,wi=-ei,bi=-oi;break;case 4:ge=!0,ki?(hi=re-vo,ci=ue-yo,li=fe-po,c=-ii,l=-ri,a=-ui):(hi=re+vo,ci=ue+yo,li=fe+po,c=ii,l=ri,a=ui),fu=co,eu=lo,ou=ao,ai=-gt,vi=-ni,yi=-ti,su=wo,hu=bo,cu=ko,pi=-fi,wi=-ei,bi=-oi;break;case 5:ge=!0,ki?(hi=re-wo,ci=ue-bo,li=fe-ko,c=-fi,l=-ei,a=-oi):(hi=re+wo,ci=ue+bo,li=fe+ko,c=fi,l=ei,a=oi),fu=co,eu=lo,ou=ao,ai=-gt,vi=-ni,yi=-ti,su=vo,hu=yo,cu=po,pi=-ii,wi=-ri,bi=-ui;break;case 6:c=yu,l=pu,a=wu,ai=lt,vi=at,yi=vt,pi=gt,wi=ni,bi=ti;break;case 7:c=bu,l=ku,a=du,ai=lt,vi=at,yi=vt,pi=ii,wi=ri,bi=ui;break;case 8:c=gu,l=nf,a=tf,ai=lt,vi=at,yi=vt,pi=fi,wi=ei,bi=oi;break;case 9:c=rf,l=uf,a=ff,ai=yt,vi=pt,yi=wt,pi=gt,wi=ni,bi=ti;break;case 10:c=ef,l=of,a=sf,ai=yt,vi=pt,yi=wt,pi=ii,wi=ri,bi=ui;break;case 11:c=hf,l=cf,a=lf,ai=yt,vi=pt,yi=wt,pi=fi,wi=ei,bi=oi;break;case 12:c=af,l=vf,a=yf,ai=bt,vi=kt,yi=dt,pi=gt,wi=ni,bi=ti;break;case 13:c=pf,l=wf,a=bf,ai=bt,vi=kt,yi=dt,pi=ii,wi=ri,bi=ui;break;case 14:c=kf,l=df,a=gf,ai=bt,vi=kt,yi=dt,pi=fi,wi=ei,bi=oi}if(nr>5){ki||(c=-c,l=-l,a=-a),r=s.vertex1,br=r.x,kr=r.y,dr=r.z,et=c*br+l*kr+a*dr,r=s.vertex2,b=r.x,k=r.y,d=r.z,g=c*b+l*k+a*d,g>et&&(et=g,br=b,kr=k,dr=d),r=s.vertex3,b=r.x,k=r.y,d=r.z,g=c*b+l*k+a*d,g>et&&(et=g,br=b,kr=k,dr=d),r=s.vertex4,b=r.x,k=r.y,d=r.z,g=c*b+l*k+a*d,g>et&&(et=g,br=b,kr=k,dr=d),r=s.vertex5,b=r.x,k=r.y,d=r.z,g=c*b+l*k+a*d,g>et&&(et=g,br=b,kr=k,dr=d),r=s.vertex6,b=r.x,k=r.y,d=r.z,g=c*b+l*k+a*d,g>et&&(et=g,br=b,kr=k,dr=d),r=s.vertex7,b=r.x,k=r.y,d=r.z,g=c*b+l*k+a*d,g>et&&(et=g,br=b,kr=k,dr=d),r=s.vertex8,b=r.x,k=r.y,d=r.z,g=c*b+l*k+a*d,g>et&&(et=g,br=b,kr=k,dr=d),r=h.vertex1,lu=r.x,au=r.y,vu=r.z,et=c*lu+l*au+a*vu,r=h.vertex2,b=r.x,k=r.y,d=r.z,g=c*b+l*k+a*d,g<et&&(et=g,lu=b,au=k,vu=d),r=h.vertex3,b=r.x,k=r.y,d=r.z,g=c*b+l*k+a*d,g<et&&(et=g,lu=b,au=k,vu=d),r=h.vertex4,b=r.x,k=r.y,d=r.z,g=c*b+l*k+a*d,g<et&&(et=g,lu=b,au=k,vu=d),r=h.vertex5,b=r.x,k=r.y,d=r.z,g=c*b+l*k+a*d,g<et&&(et=g,lu=b,au=k,vu=d),r=h.vertex6,b=r.x,k=r.y,d=r.z,g=c*b+l*k+a*d,g<et&&(et=g,lu=b,au=k,vu=d),r=h.vertex7,b=r.x,k=r.y,d=r.z,g=c*b+l*k+a*d,g<et&&(et=g,lu=b,au=k,vu=d),r=h.vertex8,b=r.x,k=r.y,d=r.z,g=c*b+l*k+a*d,g<et&&(et=g,lu=b,au=k,vu=d),b=lu-br,k=au-kr,d=vu-dr,u=ai*pi+vi*wi+yi*bi,tt=(b*(ai-pi*u)+k*(vi-wi*u)+d*(yi-bi*u))/(1-u*u),i.addContactInfo(br+ai*tt+c*di*.5,kr+vi*tt+l*di*.5,dr+yi*tt+a*di*.5,c,l,a,di,s,h,0,0,!1);return}var ur,fr,er,or,sr,hr,cr,lr,ar,vr,yr,pr,ot=1,v=0,wr=0;if(ge){v=lt*c+at*l+vt*a,v<ot&&(ot=v,wr=0),-v<ot&&(ot=-v,wr=1),v=yt*c+pt*l+wt*a,v<ot&&(ot=v,wr=2),-v<ot&&(ot=-v,wr=3),v=bt*c+kt*l+dt*a,v<ot&&(ot=v,wr=4),-v<ot&&(ot=-v,wr=5);switch(wr){case 0:r=s.vertex1,ur=r.x,fr=r.y,er=r.z,r=s.vertex3,or=r.x,sr=r.y,hr=r.z,r=s.vertex4,cr=r.x,lr=r.y,ar=r.z,r=s.vertex2,vr=r.x,yr=r.y,pr=r.z;break;case 1:r=s.vertex6,ur=r.x,fr=r.y,er=r.z,r=s.vertex8,or=r.x,sr=r.y,hr=r.z,r=s.vertex7,cr=r.x,lr=r.y,ar=r.z,r=s.vertex5,vr=r.x,yr=r.y,pr=r.z;break;case 2:r=s.vertex5,ur=r.x,fr=r.y,er=r.z,r=s.vertex1,or=r.x,sr=r.y,hr=r.z,r=s.vertex2,cr=r.x,lr=r.y,ar=r.z,r=s.vertex6,vr=r.x,yr=r.y,pr=r.z;break;case 3:r=s.vertex8,ur=r.x,fr=r.y,er=r.z,r=s.vertex4,or=r.x,sr=r.y,hr=r.z,r=s.vertex3,cr=r.x,lr=r.y,ar=r.z,r=s.vertex7,vr=r.x,yr=r.y,pr=r.z;break;case 4:r=s.vertex5,ur=r.x,fr=r.y,er=r.z,r=s.vertex7,or=r.x,sr=r.y,hr=r.z,r=s.vertex3,cr=r.x,lr=r.y,ar=r.z,r=s.vertex1,vr=r.x,yr=r.y,pr=r.z;break;case 5:r=s.vertex2,ur=r.x,fr=r.y,er=r.z,r=s.vertex4,or=r.x,sr=r.y,hr=r.z,r=s.vertex8,cr=r.x,lr=r.y,ar=r.z,r=s.vertex6,vr=r.x,yr=r.y,pr=r.z}}else{v=gt*c+ni*l+ti*a,v<ot&&(ot=v,wr=0),-v<ot&&(ot=-v,wr=1),v=ii*c+ri*l+ui*a,v<ot&&(ot=v,wr=2),-v<ot&&(ot=-v,wr=3),v=fi*c+ei*l+oi*a,v<ot&&(ot=v,wr=4),-v<ot&&(ot=-v,wr=5);switch(wr){case 0:r=h.vertex1,ur=r.x,fr=r.y,er=r.z,r=h.vertex3,or=r.x,sr=r.y,hr=r.z,r=h.vertex4,cr=r.x,lr=r.y,ar=r.z,r=h.vertex2,vr=r.x,yr=r.y,pr=r.z;break;case 1:r=h.vertex6,ur=r.x,fr=r.y,er=r.z,r=h.vertex8,or=r.x,sr=r.y,hr=r.z,r=h.vertex7,cr=r.x,lr=r.y,ar=r.z,r=h.vertex5,vr=r.x,yr=r.y,pr=r.z;break;case 2:r=h.vertex5,ur=r.x,fr=r.y,er=r.z,r=h.vertex1,or=r.x,sr=r.y,hr=r.z,r=h.vertex2,cr=r.x,lr=r.y,ar=r.z,r=h.vertex6,vr=r.x,yr=r.y,pr=r.z;break;case 3:r=h.vertex8,ur=r.x,fr=r.y,er=r.z,r=h.vertex4,or=r.x,sr=r.y,hr=r.z,r=h.vertex3,cr=r.x,lr=r.y,ar=r.z,r=h.vertex7,vr=r.x,yr=r.y,pr=r.z;break;case 4:r=h.vertex5,ur=r.x,fr=r.y,er=r.z,r=h.vertex7,or=r.x,sr=r.y,hr=r.z,r=h.vertex3,cr=r.x,lr=r.y,ar=r.z,r=h.vertex1,vr=r.x,yr=r.y,pr=r.z;break;case 5:r=h.vertex2,ur=r.x,fr=r.y,er=r.z,r=h.vertex4,or=r.x,sr=r.y,hr=r.z,r=h.vertex8,cr=r.x,lr=r.y,ar=r.z,r=h.vertex6,vr=r.x,yr=r.y,pr=r.z}}for(this.clipVertices1[0]=ur,this.clipVertices1[1]=fr,this.clipVertices1[2]=er,this.clipVertices1[3]=or,this.clipVertices1[4]=sr,this.clipVertices1[5]=hr,this.clipVertices1[6]=cr,this.clipVertices1[7]=lr,this.clipVertices1[8]=ar,this.clipVertices1[9]=vr,this.clipVertices1[10]=yr,this.clipVertices1[11]=pr,nt=0,y=this.clipVertices1[9],p=this.clipVertices1[10],w=this.clipVertices1[11],u=(y-hi-fu)*ai+(p-ci-eu)*vi+(w-li-ou)*yi,it=0;it<4;it++)o=it*3,st=this.clipVertices1[o],ht=this.clipVertices1[o+1],ct=this.clipVertices1[o+2],f=(st-hi-fu)*ai+(ht-ci-eu)*vi+(ct-li-ou)*yi,u>0?f>0?(o=nt*3,nt++,this.clipVertices2[o]=st,this.clipVertices2[o+1]=ht,this.clipVertices2[o+2]=ct):(o=nt*3,nt++,tt=u/(u-f),this.clipVertices2[o]=y+(st-y)*tt,this.clipVertices2[o+1]=p+(ht-p)*tt,this.clipVertices2[o+2]=w+(ct-w)*tt):f>0&&(o=nt*3,nt++,tt=u/(u-f),this.clipVertices2[o]=y+(st-y)*tt,this.clipVertices2[o+1]=p+(ht-p)*tt,this.clipVertices2[o+2]=w+(ct-w)*tt,o=nt*3,nt++,this.clipVertices2[o]=st,this.clipVertices2[o+1]=ht,this.clipVertices2[o+2]=ct),y=st,p=ht,w=ct,u=f;if(gi=nt,gi!=0){for(nt=0,o=(gi-1)*3,y=this.clipVertices2[o],p=this.clipVertices2[o+1],w=this.clipVertices2[o+2],u=(y-hi-su)*pi+(p-ci-hu)*wi+(w-li-cu)*bi,it=0;it<gi;it++)o=it*3,st=this.clipVertices2[o],ht=this.clipVertices2[o+1],ct=this.clipVertices2[o+2],f=(st-hi-su)*pi+(ht-ci-hu)*wi+(ct-li-cu)*bi,u>0?f>0?(o=nt*3,nt++,this.clipVertices1[o]=st,this.clipVertices1[o+1]=ht,this.clipVertices1[o+2]=ct):(o=nt*3,nt++,tt=u/(u-f),this.clipVertices1[o]=y+(st-y)*tt,this.clipVertices1[o+1]=p+(ht-p)*tt,this.clipVertices1[o+2]=w+(ct-w)*tt):f>0&&(o=nt*3,nt++,tt=u/(u-f),this.clipVertices1[o]=y+(st-y)*tt,this.clipVertices1[o+1]=p+(ht-p)*tt,this.clipVertices1[o+2]=w+(ct-w)*tt,o=nt*3,nt++,this.clipVertices1[o]=st,this.clipVertices1[o+1]=ht,this.clipVertices1[o+2]=ct),y=st,p=ht,w=ct,u=f;if(gi=nt,gi!=0){for(nt=0,o=(gi-1)*3,y=this.clipVertices1[o],p=this.clipVertices1[o+1],w=this.clipVertices1[o+2],u=(y-hi+fu)*-ai+(p-ci+eu)*-vi+(w-li+ou)*-yi,it=0;it<gi;it++)o=it*3,st=this.clipVertices1[o],ht=this.clipVertices1[o+1],ct=this.clipVertices1[o+2],f=(st-hi+fu)*-ai+(ht-ci+eu)*-vi+(ct-li+ou)*-yi,u>0?f>0?(o=nt*3,nt++,this.clipVertices2[o]=st,this.clipVertices2[o+1]=ht,this.clipVertices2[o+2]=ct):(o=nt*3,nt++,tt=u/(u-f),this.clipVertices2[o]=y+(st-y)*tt,this.clipVertices2[o+1]=p+(ht-p)*tt,this.clipVertices2[o+2]=w+(ct-w)*tt):f>0&&(o=nt*3,nt++,tt=u/(u-f),this.clipVertices2[o]=y+(st-y)*tt,this.clipVertices2[o+1]=p+(ht-p)*tt,this.clipVertices2[o+2]=w+(ct-w)*tt,o=nt*3,nt++,this.clipVertices2[o]=st,this.clipVertices2[o+1]=ht,this.clipVertices2[o+2]=ct),y=st,p=ht,w=ct,u=f;if(gi=nt,gi!=0){for(nt=0,o=(gi-1)*3,y=this.clipVertices2[o],p=this.clipVertices2[o+1],w=this.clipVertices2[o+2],u=(y-hi+su)*-pi+(p-ci+hu)*-wi+(w-li+cu)*-bi,it=0;it<gi;it++)o=it*3,st=this.clipVertices2[o],ht=this.clipVertices2[o+1],ct=this.clipVertices2[o+2],f=(st-hi+su)*-pi+(ht-ci+hu)*-wi+(ct-li+cu)*-bi,u>0?f>0?(o=nt*3,nt++,this.clipVertices1[o]=st,this.clipVertices1[o+1]=ht,this.clipVertices1[o+2]=ct):(o=nt*3,nt++,tt=u/(u-f),this.clipVertices1[o]=y+(st-y)*tt,this.clipVertices1[o+1]=p+(ht-p)*tt,this.clipVertices1[o+2]=w+(ct-w)*tt):f>0&&(o=nt*3,nt++,tt=u/(u-f),this.clipVertices1[o]=y+(st-y)*tt,this.clipVertices1[o+1]=p+(ht-p)*tt,this.clipVertices1[o+2]=w+(ct-w)*tt,o=nt*3,nt++,this.clipVertices1[o]=st,this.clipVertices1[o+1]=ht,this.clipVertices1[o+2]=ct),y=st,p=ht,w=ct,u=f;if(gi=nt,ge&&(oh=s,s=h,h=oh),gi!=0)if(gi>4){y=(ur+or+cr+vr)*.25,p=(fr+sr+lr+yr)*.25,w=(er+hr+ar+pr)*.25,ai=ur-y,vi=fr-p,yi=er-w,pi=or-y,wi=sr-p,bi=hr-w;var bs=0,sh=0,ks=0,hh=0,no=-this.INF;for(ot=this.INF,it=0;it<gi;it++)this.used[it]=!1,o=it*3,y=this.clipVertices1[o],p=this.clipVertices1[o+1],w=this.clipVertices1[o+2],v=y*ai+p*vi+w*yi,v<ot&&(ot=v,bs=it),v>no&&(no=v,ks=it);for(this.used[bs]=!0,this.used[ks]=!0,no=-this.INF,ot=this.INF,it=0;it<gi;it++)this.used[it]||(o=it*3,y=this.clipVertices1[o],p=this.clipVertices1[o+1],w=this.clipVertices1[o+2],v=y*pi+p*wi+w*bi,v<ot&&(ot=v,sh=it),v>no&&(no=v,hh=it));o=bs*3,y=this.clipVertices1[o],p=this.clipVertices1[o+1],w=this.clipVertices1[o+2],v=(y-hi)*c+(p-ci)*l+(w-li)*a,v<0&&i.addContactInfo(y,p,w,c,l,a,v,s,h,0,0,!1),o=sh*3,y=this.clipVertices1[o],p=this.clipVertices1[o+1],w=this.clipVertices1[o+2],v=(y-hi)*c+(p-ci)*l+(w-li)*a,v<0&&i.addContactInfo(y,p,w,c,l,a,v,s,h,1,0,!1),o=ks*3,y=this.clipVertices1[o],p=this.clipVertices1[o+1],w=this.clipVertices1[o+2],v=(y-hi)*c+(p-ci)*l+(w-li)*a,v<0&&i.addContactInfo(y,p,w,c,l,a,v,s,h,2,0,!1),o=hh*3,y=this.clipVertices1[o],p=this.clipVertices1[o+1],w=this.clipVertices1[o+2],v=(y-hi)*c+(p-ci)*l+(w-li)*a,v<0&&i.addContactInfo(y,p,w,c,l,a,v,s,h,3,0,!1)}else for(it=0;it<gi;it++)o=it*3,y=this.clipVertices1[o],p=this.clipVertices1[o+1],w=this.clipVertices1[o+2],v=(y-hi)*c+(p-ci)*l+(w-li)*a,v<0&&i.addContactInfo(y,p,w,c,l,a,v,s,h,it,0,!1)}}}}},OIMO.SphereBoxCollisionDetector=function(n){OIMO.CollisionDetector.call(this),this.flip=n},OIMO.SphereBoxCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype),OIMO.SphereBoxCollisionDetector.prototype.detectCollision=function(n,t,i){var k,y;this.flip?(k=t,y=n):(k=n,y=t);var d=k.position,tt=d.x,it=d.y,rt=d.z,ut=y.position,ft=ut.x,et=ut.y,ot=ut.z,b=k.radius,c=y.normalDirectionWidth,l=y.normalDirectionHeight,e=y.normalDirectionDepth,p=y.halfWidth,w=y.halfHeight,a=y.halfDepth,u=tt-ft,f=it-et,r=rt-ot,s=c.x*u+c.y*f+c.z*r,h=l.x*u+l.y*f+l.z*r,o=e.x*u+e.y*f+e.z*r,st,ht,ct,v,g,lt,nt=0;s>p?s=p:s<-p?s=-p:nt=1,h>w?h=w:h<-w?h=-w:nt|=2,o>a?o=a:o<-a?o=-a:nt|=4,nt==7?(u=s<0?p+s:p-s,f=h<0?w+h:w-h,r=o<0?a+o:a-o,u<f?u<r?(v=u-p,s<0?(s=-p,u=c.x,f=c.y,r=c.z):(s=p,u=-c.x,f=-c.y,r=-c.z)):(v=r-a,o<0?(o=-a,u=e.x,f=e.y,r=e.z):(o=a,u=-e.x,f=-e.y,r=-e.z)):f<r?(v=f-w,h<0?(h=-w,u=l.x,f=l.y,r=l.z):(h=w,u=-l.x,f=-l.y,r=-l.z)):(v=r-a,o<0?(o=-a,u=e.x,f=e.y,r=e.z):(o=a,u=-e.x,f=-e.y,r=-e.z)),st=ft+s*c.x+h*l.x+o*e.x,ht=et+s*c.y+h*l.y+o*e.y,ct=ot+s*c.z+h*l.z+o*e.z,i.addContactInfo(tt+b*u,it+b*f,rt+b*r,u,f,r,v,k,y,0,0,!1)):(st=ft+s*c.x+h*l.x+o*e.x,ht=et+s*c.y+h*l.y+o*e.y,ct=ot+s*c.z+h*l.z+o*e.z,u=st-d.x,f=ht-d.y,r=ct-d.z,v=u*u+f*f+r*r,v>0&&v<b*b&&(v=Math.sqrt(v),g=1/v,u*=g,f*=g,r*=g,i.addContactInfo(tt+b*u,it+b*f,rt+b*r,u,f,r,v,k,y,0,0,!1)))},OIMO.BoxCylinderCollisionDetector=function(n){OIMO.CollisionDetector.call(this),this.flip=n},OIMO.BoxCylinderCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype),OIMO.BoxCylinderCollisionDetector.prototype.getSep=function(n,t,i,r,u){var nt,tt,it,rt,ut,ft,f=new OIMO.Vec3,bi,gi,nr,tr,ir,rr,ur,fr=n.position.x,er=n.position.y,or=n.position.z,sr=t.position.x,hr=t.position.y,cr=t.position.z,w=sr-fr,p=hr-er,b=cr-or,lr,ki,dt;w*w+p*p+b*b==0&&(p=.001);var e=-w,o=-p,s=-b;this.supportPointB(n,-e,-o,-s,f);var at=f.x,vt=f.y,yt=f.z;this.supportPointC(t,e,o,s,f);var pt=f.x,wt=f.y,bt=f.z,h=pt-at,c=wt-vt,l=bt-yt;if(h*e+c*o+l*s<=0)return!1;if(e=c*b-l*p,o=l*w-h*b,s=h*p-c*w,e*e+o*o+s*s==0)return i.init(h-w,c-p,l-b),i.normalize(i),r.init((at+pt)*.5,(vt+wt)*.5,(yt+bt)*.5),!0;this.supportPointB(n,-e,-o,-s,f);var gt=f.x,ni=f.y,ti=f.z;this.supportPointC(t,e,o,s,f);var ii=f.x,ri=f.y,ui=f.z,a=ii-gt,v=ri-ni,y=ui-ti;if(a*e+v*o+y*s<=0)return!1;for(nt=h-w,tt=c-p,it=l-b,rt=a-w,ut=v-p,ft=y-b,e=tt*ft-it*ut,o=it*rt-nt*ft,s=nt*ut-tt*rt,e*w+o*p+s*b>0&&(nt=h,tt=c,it=l,h=a,c=v,l=y,a=nt,v=tt,y=it,nt=at,tt=vt,it=yt,at=gt,vt=ni,yt=ti,gt=nt,ni=tt,ti=it,nt=pt,tt=wt,it=bt,pt=ii,wt=ri,bt=ui,ii=nt,ri=tt,ui=it,e=-e,o=-o,s=-s),lr=0;;){if(++lr>100)return!1;this.supportPointB(n,-e,-o,-s,f);var fi=f.x,ei=f.y,oi=f.z;this.supportPointC(t,e,o,s,f);var si=f.x,hi=f.y,ci=f.z,k=si-fi,d=hi-ei,g=ci-oi;if(k*e+d*o+g*s<=0)return!1;if((c*g-l*d)*w+(l*k-h*g)*p+(h*d-c*k)*b<0){a=k,v=d,y=g,gt=fi,ni=ei,ti=oi,ii=si,ri=hi,ui=ci,nt=h-w,tt=c-p,it=l-b,rt=k-w,ut=d-p,ft=g-b,e=tt*ft-it*ut,o=it*rt-nt*ft,s=nt*ut-tt*rt;continue}if((d*y-g*v)*w+(g*a-k*y)*p+(k*v-d*a)*b<0){h=k,c=d,l=g,at=fi,vt=ei,yt=oi,pt=si,wt=hi,bt=ci,nt=k-w,tt=d-p,it=g-b,rt=a-w,ut=v-p,ft=y-b,e=tt*ft-it*ut,o=it*rt-nt*ft,s=nt*ut-tt*rt;continue}for(ki=!1;;){if(nt=a-h,tt=v-c,it=y-l,rt=k-h,ut=d-c,ft=g-l,e=tt*ft-it*ut,o=it*rt-nt*ft,s=nt*ut-tt*rt,bi=1/Math.sqrt(e*e+o*o+s*s),e*=bi,o*=bi,s*=bi,e*h+o*c+s*l>=0&&!ki){var kt=(c*y-l*v)*k+(l*a-h*y)*d+(h*v-c*a)*g,ht=(d*y-g*v)*w+(g*a-k*y)*p+(k*v-d*a)*b,ct=(p*l-b*c)*k+(b*h-w*l)*d+(w*c-p*h)*g,lt=(v*l-y*c)*w+(y*h-a*l)*p+(a*c-v*h)*b,di=kt+ht+ct+lt;di<=0&&(kt=0,ht=(v*g-y*d)*e+(y*k-a*g)*o+(a*d-v*k)*s,ct=(d*y-g*v)*e+(g*a-k*y)*o+(k*v-d*a)*s,lt=(c*y-l*v)*e+(l*a-h*y)*o+(h*v-c*a)*s,di=ht+ct+lt),dt=1/di,gi=(fr*kt+at*ht+gt*ct+fi*lt)*dt,nr=(er*kt+vt*ht+ni*ct+ei*lt)*dt,tr=(or*kt+yt*ht+ti*ct+oi*lt)*dt,ir=(sr*kt+pt*ht+ii*ct+si*lt)*dt,rr=(hr*kt+wt*ht+ri*ct+hi*lt)*dt,ur=(cr*kt+bt*ht+ui*ct+ci*lt)*dt,ki=!0}this.supportPointB(n,-e,-o,-s,f);var li=f.x,ai=f.y,vi=f.z;this.supportPointC(t,e,o,s,f);var yi=f.x,pi=f.y,wi=f.z,et=yi-li,ot=pi-ai,st=wi-vi,ar=-(et*e+ot*o+st*s);if((et-k)*e+(ot-d)*o+(st-g)*s<=.01||ar>=0)return ki?(i.init(-e,-o,-s),r.init((gi+ir)*.5,(nr+rr)*.5,(tr+ur)*.5),u.x=ar,!0):!1;(ot*l-st*c)*w+(st*h-et*l)*p+(et*c-ot*h)*b<0?(ot*y-st*v)*w+(st*a-et*y)*p+(et*v-ot*a)*b<0?(h=et,c=ot,l=st,at=li,vt=ai,yt=vi,pt=yi,wt=pi,bt=wi):(k=et,d=ot,g=st,fi=li,ei=ai,oi=vi,si=yi,hi=pi,ci=wi):(ot*g-st*d)*w+(st*k-et*g)*p+(et*d-ot*k)*b<0?(a=et,v=ot,y=st,gt=li,ni=ai,ti=vi,ii=yi,ri=pi,ui=wi):(h=et,c=ot,l=st,at=li,vt=ai,yt=vi,pt=yi,wt=pi,bt=wi)}}return!1},OIMO.BoxCylinderCollisionDetector.prototype.supportPointB=function(n,t,i,r,u){var f=n.rotation.elements,h=f[0]*t+f[3]*i+f[6]*r,c=f[1]*t+f[4]*i+f[7]*r,l=f[2]*t+f[5]*i+f[8]*r,a=n.halfWidth,v=n.halfHeight,y=n.halfDepth,e,o,s;e=h<0?-a:a,o=c<0?-v:v,s=l<0?-y:y,h=f[0]*e+f[1]*o+f[2]*s+n.position.x,c=f[3]*e+f[4]*o+f[5]*s+n.position.y,l=f[6]*e+f[7]*o+f[8]*s+n.position.z,u.init(h,c,l)},OIMO.BoxCylinderCollisionDetector.prototype.supportPointC=function(n,t,i,r,u){var f=n.rotation.elements,y=f[0]*t+f[3]*i+f[6]*r,c=f[1]*t+f[4]*i+f[7]*r,p=f[2]*t+f[5]*i+f[8]*r,l=y,a=p,e=l*l+a*a,w=n.radius,v=n.halfHeight,o,s,h;e==0?c<0?(o=w,s=-v,h=0):(o=w,s=v,h=0):(e=n.radius/Math.sqrt(e),c<0?(o=l*e,s=-v,h=a*e):(o=l*e,s=v,h=a*e)),y=f[0]*o+f[1]*s+f[2]*h+n.position.x,c=f[3]*o+f[4]*s+f[5]*h+n.position.y,p=f[6]*o+f[7]*s+f[8]*h+n.position.z,u.init(y,c,p)},OIMO.BoxCylinderCollisionDetector.prototype.detectCollision=function(n,t,i){var u,tt,it,d,g,nt,si,hi,ci,hu,cu,lu,au,vu,yu,pu,wu,bu,ot,st,ht,p,at,vt,l,a,v,bt,gt,ni,ti,ai,vi,yi,pi,wi,bi,w,b,k,f,rt,ut,ft,h,y,et,c,kf,ii,ri,ui,fi,ei,oi,ct,lt,ki,di,gi,nr,tr,ir,rr,ur,fr,er,or,sr,r;this.flip?(u=t,tt=n):(u=n,tt=t);var tu=new OIMO.Vec3,iu=new OIMO.Vec3,ku=new OIMO.Vec3,bf;if(this.getSep(u,tt,tu,iu,ku)){var hr=u.position.x,cr=u.position.y,lr=u.position.z,eu=tt.position.x,ou=tt.position.y,su=tt.position.z,du=u.halfWidth,gu=u.halfHeight,nf=u.halfDepth,tf=tt.halfHeight,wf=tt.radius,ar=u.normalDirectionWidth.x,vr=u.normalDirectionWidth.y,yr=u.normalDirectionWidth.z,pr=u.normalDirectionHeight.x,wr=u.normalDirectionHeight.y,br=u.normalDirectionHeight.z,kr=u.normalDirectionDepth.x,dr=u.normalDirectionDepth.y,gr=u.normalDirectionDepth.z,rf=u.halfDirectionWidth.x,uf=u.halfDirectionWidth.y,ff=u.halfDirectionWidth.z,ef=u.halfDirectionHeight.x,of=u.halfDirectionHeight.y,sf=u.halfDirectionHeight.z,hf=u.halfDirectionDepth.x,cf=u.halfDirectionDepth.y,lf=u.halfDirectionDepth.z,yt=tt.normalDirection.x,pt=tt.normalDirection.y,wt=tt.normalDirection.z,ru=tt.halfDirection.x,uu=tt.halfDirection.y,fu=tt.halfDirection.z,e=tu.x,o=tu.y,s=tu.z,kt=e*ar+o*vr+s*yr,dt=e*pr+o*wr+s*br,nu=e*kr+o*dr+s*gr,li=e*yt+o*pt+s*wt,af=kt>0,vf=dt>0,yf=nu>0,pf=li>0;if(af||(kt=-kt),vf||(dt=-dt),yf||(nu=-nu),pf||(li=-li),it=0,li>.999?it=kt>.999?kt>li?1:4:dt>.999?dt>li?2:4:nu>.999?nu>li?3:4:4:kt>.999?it=1:dt>.999?it=2:nu>.999&&(it=3),it==0)i.addContactInfo(iu.x,iu.y,iu.z,e,o,s,ku.x,u,tt,0,0,!1);else if(it==4){pf?(si=eu-ru,hi=ou-uu,ci=su-fu,e=-yt,o=-pt,s=-wt):(si=eu+ru,hi=ou+uu,ci=su+fu,e=yt,o=pt,s=wt),at=1,it=0,y=ar*e+vr*o+yr*s,y<at&&(at=y,it=0),-y<at&&(at=-y,it=1),y=pr*e+wr*o+br*s,y<at&&(at=y,it=2),-y<at&&(at=-y,it=3),y=kr*e+dr*o+gr*s,y<at&&(at=y,it=4),-y<at&&(at=-y,it=5);switch(it){case 0:r=u.vertex1,ki=r.x,di=r.y,gi=r.z,r=u.vertex3,nr=r.x,tr=r.y,ir=r.z,r=u.vertex4,rr=r.x,ur=r.y,fr=r.z,r=u.vertex2,er=r.x,or=r.y,sr=r.z;break;case 1:r=u.vertex6,ki=r.x,di=r.y,gi=r.z,r=u.vertex8,nr=r.x,tr=r.y,ir=r.z,r=u.vertex7,rr=r.x,ur=r.y,fr=r.z,r=u.vertex5,er=r.x,or=r.y,sr=r.z;break;case 2:r=u.vertex5,ki=r.x,di=r.y,gi=r.z,r=u.vertex1,nr=r.x,tr=r.y,ir=r.z,r=u.vertex2,rr=r.x,ur=r.y,fr=r.z,r=u.vertex6,er=r.x,or=r.y,sr=r.z;break;case 3:r=u.vertex8,ki=r.x,di=r.y,gi=r.z,r=u.vertex4,nr=r.x,tr=r.y,ir=r.z,r=u.vertex3,rr=r.x,ur=r.y,fr=r.z,r=u.vertex7,er=r.x,or=r.y,sr=r.z;break;case 4:r=u.vertex5,ki=r.x,di=r.y,gi=r.z,r=u.vertex7,nr=r.x,tr=r.y,ir=r.z,r=u.vertex3,rr=r.x,ur=r.y,fr=r.z,r=u.vertex1,er=r.x,or=r.y,sr=r.z;break;case 5:r=u.vertex2,ki=r.x,di=r.y,gi=r.z,r=u.vertex4,nr=r.x,tr=r.y,ir=r.z,r=u.vertex8,rr=r.x,ur=r.y,fr=r.z,r=u.vertex6,er=r.x,or=r.y,sr=r.z}p=e*(ki-si)+o*(di-hi)+s*(gi-ci),p<=0&&i.addContactInfo(ki,di,gi,-e,-o,-s,p,u,tt,5,0,!1),p=e*(nr-si)+o*(tr-hi)+s*(ir-ci),p<=0&&i.addContactInfo(nr,tr,ir,-e,-o,-s,p,u,tt,6,0,!1),p=e*(rr-si)+o*(ur-hi)+s*(fr-ci),p<=0&&i.addContactInfo(rr,ur,fr,-e,-o,-s,p,u,tt,7,0,!1),p=e*(er-si)+o*(or-hi)+s*(sr-ci),p<=0&&i.addContactInfo(er,or,sr,-e,-o,-s,p,u,tt,8,0,!1)}else{switch(it){case 1:af?(d=hr+rf,g=cr+uf,nt=lr+ff,e=ar,o=vr,s=yr):(d=hr-rf,g=cr-uf,nt=lr-ff,e=-ar,o=-vr,s=-yr),ii=pr,ri=wr,ui=br,ct=gu,fi=kr,ei=dr,oi=gr,lt=nf;break;case 2:vf?(d=hr+ef,g=cr+of,nt=lr+sf,e=pr,o=wr,s=br):(d=hr-ef,g=cr-of,nt=lr-sf,e=-pr,o=-wr,s=-br),ii=ar,ri=vr,ui=yr,ct=du,fi=kr,ei=dr,oi=gr,lt=nf;break;case 3:yf?(d=hr+hf,g=cr+cf,nt=lr+lf,e=kr,o=dr,s=gr):(d=hr-hf,g=cr-cf,nt=lr-lf,e=-kr,o=-dr,s=-gr),ii=ar,ri=vr,ui=yr,ct=du,fi=pr,ei=wr,oi=br,lt=gu}if(at=e*yt+o*pt+s*wt,vt=at<0?tf:-tf,si=eu+vt*yt,hi=ou+vt*pt,ci=su+vt*wt,li>=.999999?(l=-o,a=s,v=e):(l=e,a=o,v=s),vt=l*yt+a*pt+v*wt,gt=vt*yt-l,ni=vt*pt-a,ti=vt*wt-v,vt=Math.sqrt(gt*gt+ni*ni+ti*ti),vt==0)return;if(vt=wf/vt,gt*=vt,ni*=vt,ti*=vt,l=si+gt,a=hi+ni,v=ci+ti,at<-.96||at>.96)hu=yt*yt*1.5-.5,cu=yt*pt*1.5-wt*.866025403,lu=yt*wt*1.5+pt*.866025403,au=pt*yt*1.5+wt*.866025403,vu=pt*pt*1.5-.5,yu=pt*wt*1.5-yt*.866025403,pu=wt*yt*1.5-pt*.866025403,wu=wt*pt*1.5+yt*.866025403,bu=wt*wt*1.5-.5,ot=l,st=a,ht=v,p=e*(ot-d)+o*(st-g)+s*(ht-nt),l=ot-p*e-d,a=st-p*o-g,v=ht-p*s-nt,f=ii*l+ri*a+ui*v,h=fi*l+ei*a+oi*v,f<-ct?f=-ct:f>ct&&(f=ct),h<-lt?h=-lt:h>lt&&(h=lt),l=f*ii+h*fi,a=f*ri+h*ei,v=f*ui+h*oi,ot=d+l,st=g+a,ht=nt+v,i.addContactInfo(ot,st,ht,e,o,s,p,u,tt,1,0,!1),ot=gt*hu+ni*cu+ti*lu,st=gt*au+ni*vu+ti*yu,ht=gt*pu+ni*wu+ti*bu,ot=(gt=ot)+si,st=(ni=st)+hi,ht=(ti=ht)+ci,p=e*(ot-d)+o*(st-g)+s*(ht-nt),p<=0&&(l=ot-p*e-d,a=st-p*o-g,v=ht-p*s-nt,f=ii*l+ri*a+ui*v,h=fi*l+ei*a+oi*v,f<-ct?f=-ct:f>ct&&(f=ct),h<-lt?h=-lt:h>lt&&(h=lt),l=f*ii+h*fi,a=f*ri+h*ei,v=f*ui+h*oi,ot=d+l,st=g+a,ht=nt+v,i.addContactInfo(ot,st,ht,e,o,s,p,u,tt,2,0,!1)),ot=gt*hu+ni*cu+ti*lu,st=gt*au+ni*vu+ti*yu,ht=gt*pu+ni*wu+ti*bu,ot=(gt=ot)+si,st=(ni=st)+hi,ht=(ti=ht)+ci,p=e*(ot-d)+o*(st-g)+s*(ht-nt),p<=0&&(l=ot-p*e-d,a=st-p*o-g,v=ht-p*s-nt,f=ii*l+ri*a+ui*v,h=fi*l+ei*a+oi*v,f<-ct?f=-ct:f>ct&&(f=ct),h<-lt?h=-lt:h>lt&&(h=lt),l=f*ii+h*fi,a=f*ri+h*ei,v=f*ui+h*oi,ot=d+l,st=g+a,ht=nt+v,i.addContactInfo(ot,st,ht,e,o,s,p,u,tt,3,0,!1));else{if(w=l,b=a,k=v,f=e*(w-d)+o*(b-g)+s*(k-nt),w-=f*e,b-=f*o,k-=f*s,at>0?(rt=l+ru*2,ut=a+uu*2,ft=v+fu*2):(rt=l-ru*2,ut=a-uu*2,ft=v-fu*2),h=e*(rt-d)+o*(ut-g)+s*(ft-nt),rt-=h*e,ut-=h*o,ft-=h*s,ai=w-d,vi=b-g,yi=k-nt,pi=rt-d,wi=ut-g,bi=ft-nt,l=rt-w,a=ut-b,v=ft-k,bt=h-f,kt=ai*ii+vi*ri+yi*ui,dt=pi*ii+wi*ri+bi*ui,y=kt-ct,et=dt-ct,y>0){if(et>0)return;c=y/(y-et),w=w+l*c,b=b+a*c,k=k+v*c,f=f+bt*c,ai=w-d,vi=b-g,yi=k-nt,kt=ai*ii+vi*ri+yi*ui,l=rt-w,a=ut-b,v=ft-k,bt=h-f}else et>0&&(c=y/(y-et),rt=w+l*c,ut=b+a*c,ft=k+v*c,h=f+bt*c,pi=rt-d,wi=ut-g,bi=ft-nt,dt=pi*ii+wi*ri+bi*ui,l=rt-w,a=ut-b,v=ft-k,bt=h-f);if(y=kt+ct,et=dt+ct,y<0){if(et<0)return;c=y/(y-et),w=w+l*c,b=b+a*c,k=k+v*c,f=f+bt*c,ai=w-d,vi=b-g,yi=k-nt,l=rt-w,a=ut-b,v=ft-k,bt=h-f}else et<0&&(c=y/(y-et),rt=w+l*c,ut=b+a*c,ft=k+v*c,h=f+bt*c,pi=rt-d,wi=ut-g,bi=ft-nt,l=rt-w,a=ut-b,v=ft-k,bt=h-f);if(kt=ai*fi+vi*ei+yi*oi,dt=pi*fi+wi*ei+bi*oi,y=kt-lt,et=dt-lt,y>0){if(et>0)return;c=y/(y-et),w=w+l*c,b=b+a*c,k=k+v*c,f=f+bt*c,ai=w-d,vi=b-g,yi=k-nt,kt=ai*fi+vi*ei+yi*oi,l=rt-w,a=ut-b,v=ft-k,bt=h-f}else et>0&&(c=y/(y-et),rt=w+l*c,ut=b+a*c,ft=k+v*c,h=f+bt*c,pi=rt-d,wi=ut-g,bi=ft-nt,dt=pi*fi+wi*ei+bi*oi,l=rt-w,a=ut-b,v=ft-k,bt=h-f);if(y=kt+lt,et=dt+lt,y<0){if(et<0)return;c=y/(y-et),w=w+l*c,b=b+a*c,k=k+v*c,f=f+bt*c}else et<0&&(c=y/(y-et),rt=w+l*c,ut=b+a*c,ft=k+v*c,h=f+bt*c);f<0&&i.addContactInfo(w,b,k,e,o,s,f,u,tt,1,0,!1),h<0&&i.addContactInfo(rt,ut,ft,e,o,s,h,u,tt,4,0,!1)}}}},OIMO.CylinderCylinderCollisionDetector=function(){OIMO.CollisionDetector.call(this)},OIMO.CylinderCylinderCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype),OIMO.CylinderCylinderCollisionDetector.prototype.getSep=function(n,t,i,r,u){var nt,tt,it,rt,ut,ft,f=new OIMO.Vec3,bi,gi,nr,tr,ir,rr,ur,fr=n.position.x,er=n.position.y,or=n.position.z,sr=t.position.x,hr=t.position.y,cr=t.position.z,w=sr-fr,p=hr-er,b=cr-or,lr,ki,dt;w*w+p*p+b*b==0&&(p=.001);var e=-w,o=-p,s=-b;this.supportPoint(n,-e,-o,-s,f);var at=f.x,vt=f.y,yt=f.z;this.supportPoint(t,e,o,s,f);var pt=f.x,wt=f.y,bt=f.z,h=pt-at,c=wt-vt,l=bt-yt;if(h*e+c*o+l*s<=0)return!1;if(e=c*b-l*p,o=l*w-h*b,s=h*p-c*w,e*e+o*o+s*s==0)return i.init(h-w,c-p,l-b),i.normalize(i),r.init((at+pt)*.5,(vt+wt)*.5,(yt+bt)*.5),!0;this.supportPoint(n,-e,-o,-s,f);var gt=f.x,ni=f.y,ti=f.z;this.supportPoint(t,e,o,s,f);var ii=f.x,ri=f.y,ui=f.z,a=ii-gt,v=ri-ni,y=ui-ti;if(a*e+v*o+y*s<=0)return!1;for(nt=h-w,tt=c-p,it=l-b,rt=a-w,ut=v-p,ft=y-b,e=tt*ft-it*ut,o=it*rt-nt*ft,s=nt*ut-tt*rt,e*w+o*p+s*b>0&&(nt=h,tt=c,it=l,h=a,c=v,l=y,a=nt,v=tt,y=it,nt=at,tt=vt,it=yt,at=gt,vt=ni,yt=ti,gt=nt,ni=tt,ti=it,nt=pt,tt=wt,it=bt,pt=ii,wt=ri,bt=ui,ii=nt,ri=tt,ui=it,e=-e,o=-o,s=-s),lr=0;;){if(++lr>100)return!1;this.supportPoint(n,-e,-o,-s,f);var fi=f.x,ei=f.y,oi=f.z;this.supportPoint(t,e,o,s,f);var si=f.x,hi=f.y,ci=f.z,k=si-fi,d=hi-ei,g=ci-oi;if(k*e+d*o+g*s<=0)return!1;if((c*g-l*d)*w+(l*k-h*g)*p+(h*d-c*k)*b<0){a=k,v=d,y=g,gt=fi,ni=ei,ti=oi,ii=si,ri=hi,ui=ci,nt=h-w,tt=c-p,it=l-b,rt=k-w,ut=d-p,ft=g-b,e=tt*ft-it*ut,o=it*rt-nt*ft,s=nt*ut-tt*rt;continue}if((d*y-g*v)*w+(g*a-k*y)*p+(k*v-d*a)*b<0){h=k,c=d,l=g,at=fi,vt=ei,yt=oi,pt=si,wt=hi,bt=ci,nt=k-w,tt=d-p,it=g-b,rt=a-w,ut=v-p,ft=y-b,e=tt*ft-it*ut,o=it*rt-nt*ft,s=nt*ut-tt*rt;continue}for(ki=!1;;){if(nt=a-h,tt=v-c,it=y-l,rt=k-h,ut=d-c,ft=g-l,e=tt*ft-it*ut,o=it*rt-nt*ft,s=nt*ut-tt*rt,bi=1/Math.sqrt(e*e+o*o+s*s),e*=bi,o*=bi,s*=bi,e*h+o*c+s*l>=0&&!ki){var kt=(c*y-l*v)*k+(l*a-h*y)*d+(h*v-c*a)*g,ht=(d*y-g*v)*w+(g*a-k*y)*p+(k*v-d*a)*b,ct=(p*l-b*c)*k+(b*h-w*l)*d+(w*c-p*h)*g,lt=(v*l-y*c)*w+(y*h-a*l)*p+(a*c-v*h)*b,di=kt+ht+ct+lt;di<=0&&(kt=0,ht=(v*g-y*d)*e+(y*k-a*g)*o+(a*d-v*k)*s,ct=(d*y-g*v)*e+(g*a-k*y)*o+(k*v-d*a)*s,lt=(c*y-l*v)*e+(l*a-h*y)*o+(h*v-c*a)*s,di=ht+ct+lt),dt=1/di,gi=(fr*kt+at*ht+gt*ct+fi*lt)*dt,nr=(er*kt+vt*ht+ni*ct+ei*lt)*dt,tr=(or*kt+yt*ht+ti*ct+oi*lt)*dt,ir=(sr*kt+pt*ht+ii*ct+si*lt)*dt,rr=(hr*kt+wt*ht+ri*ct+hi*lt)*dt,ur=(cr*kt+bt*ht+ui*ct+ci*lt)*dt,ki=!0}this.supportPoint(n,-e,-o,-s,f);var li=f.x,ai=f.y,vi=f.z;this.supportPoint(t,e,o,s,f);var yi=f.x,pi=f.y,wi=f.z,et=yi-li,ot=pi-ai,st=wi-vi,ar=-(et*e+ot*o+st*s);if((et-k)*e+(ot-d)*o+(st-g)*s<=.01||ar>=0)return ki?(i.init(-e,-o,-s),r.init((gi+ir)*.5,(nr+rr)*.5,(tr+ur)*.5),u.x=ar,!0):!1;(ot*l-st*c)*w+(st*h-et*l)*p+(et*c-ot*h)*b<0?(ot*y-st*v)*w+(st*a-et*y)*p+(et*v-ot*a)*b<0?(h=et,c=ot,l=st,at=li,vt=ai,yt=vi,pt=yi,wt=pi,bt=wi):(k=et,d=ot,g=st,fi=li,ei=ai,oi=vi,si=yi,hi=pi,ci=wi):(ot*g-st*d)*w+(st*k-et*g)*p+(et*d-ot*k)*b<0?(a=et,v=ot,y=st,gt=li,ni=ai,ti=vi,ii=yi,ri=pi,ui=wi):(h=et,c=ot,l=st,at=li,vt=ai,yt=vi,pt=yi,wt=pi,bt=wi)}}return!1},OIMO.CylinderCylinderCollisionDetector.prototype.supportPoint=function(n,t,i,r,u){var f=n.rotation.elements,y=f[0]*t+f[3]*i+f[6]*r,c=f[1]*t+f[4]*i+f[7]*r,p=f[2]*t+f[5]*i+f[8]*r,l=y,a=p,e=l*l+a*a,w=n.radius,v=n.halfHeight,o,s,h;e==0?c<0?(o=w,s=-v,h=0):(o=w,s=v,h=0):(e=n.radius/Math.sqrt(e),c<0?(o=l*e,s=-v,h=a*e):(o=l*e,s=v,h=a*e)),y=f[0]*o+f[1]*s+f[2]*h+n.position.x,c=f[3]*o+f[4]*s+f[5]*h+n.position.y,p=f[6]*o+f[7]*s+f[8]*h+n.position.z,u.init(y,c,p)},OIMO.CylinderCylinderCollisionDetector.prototype.detectCollision=function(n,t,i){var it,rt,fr,o,s,h,tu,ci,li,ai,vi,yi,pi,wi,bi,ki,c,l,a,v,er,ui,oi,ti;n.id<t.id?(it=n,rt=t):(it=t,rt=n);var or=it.position,sr=rt.position,di=or.x,gi=or.y,nr=or.z,tr=sr.x,ir=sr.y,rr=sr.z,fi=it.halfHeight,ei=rt.halfHeight,hr=it.normalDirection,cr=rt.normalDirection,lr=it.halfDirection,ar=rt.halfDirection,gt=it.radius,ni=rt.radius,vt=hr.x,yt=hr.y,pt=hr.z,wt=cr.x,bt=cr.y,kt=cr.z,vr=lr.x,yr=lr.y,pr=lr.z,wr=ar.x,br=ar.y,kr=ar.z,y=di-tr,p=gi-ir,w=nr-rr,r,iu,ru,uu,ut,ft,et,ot,st,ht,u,f,e,b,k,d,ct,lt,at,g,dt,ii,nt,tt,ri=new OIMO.Vec3,ur=new OIMO.Vec3,dr=new OIMO.Vec3;if(this.getSep(it,rt,ri,ur,dr)){var si=ri.x*vt+ri.y*yt+ri.z*pt,hi=ri.x*wt+ri.y*bt+ri.z*kt,gr=si>0,nu=hi>0;gr||(si=-si),nu||(hi=-hi),fr=0,(si>.999||hi>.999)&&(fr=si>hi?1:2),tu=dr.x,o=ri.x,s=ri.y,h=ri.z;switch(fr){case 0:i.addContactInfo(ur.x,ur.y,ur.z,o,s,h,tu,it,rt,0,0,!1);break;case 1:if(gr?(ut=di+vr,ft=gi+yr,et=nr+pr,o=vt,s=yt,h=pt):(ut=di-vr,ft=gi-yr,et=nr-pr,o=-vt,s=-yt,h=-pt),ii=o*wt+s*bt+h*kt,r=ii<0?ei:-ei,ot=tr+r*wt,st=ir+r*bt,ht=rr+r*kt,hi>=.999999?(u=-s,f=h,e=o):(u=o,f=s,e=h),r=u*wt+f*bt+e*kt,y=r*wt-u,p=r*bt-f,w=r*kt-e,r=Math.sqrt(y*y+p*p+w*w),r==0)break;if(r=ni/r,y*=r,p*=r,w*=r,u=ot+y,f=st+p,e=ht+w,ii<-.96||ii>.96)ci=wt*wt*1.5-.5,li=wt*bt*1.5-kt*.866025403,ai=wt*kt*1.5+bt*.866025403,vi=bt*wt*1.5+kt*.866025403,yi=bt*bt*1.5-.5,pi=bt*kt*1.5-wt*.866025403,wi=kt*wt*1.5-bt*.866025403,bi=kt*bt*1.5+wt*.866025403,ki=kt*kt*1.5-.5,c=u,l=f,a=e,v=o*(c-ut)+s*(l-ft)+h*(a-et),u=c-v*o-ut,f=l-v*s-ft,e=a-v*h-et,r=u*u+f*f+e*e,r>gt*gt&&(r=gt/Math.sqrt(r),u*=r,f*=r,e*=r),c=ut+u,l=ft+f,a=et+e,i.addContactInfo(c,l,a,o,s,h,v,it,rt,1,0,!1),c=y*ci+p*li+w*ai,l=y*vi+p*yi+w*pi,a=y*wi+p*bi+w*ki,c=(y=c)+ot,l=(p=l)+st,a=(w=a)+ht,v=o*(c-ut)+s*(l-ft)+h*(a-et),v<=0&&(u=c-v*o-ut,f=l-v*s-ft,e=a-v*h-et,r=u*u+f*f+e*e,r>gt*gt&&(r=gt/Math.sqrt(r),u*=r,f*=r,e*=r),c=ut+u,l=ft+f,a=et+e,i.addContactInfo(c,l,a,o,s,h,v,it,rt,2,0,!1)),c=y*ci+p*li+w*ai,l=y*vi+p*yi+w*pi,a=y*wi+p*bi+w*ki,c=(y=c)+ot,l=(p=l)+st,a=(w=a)+ht,v=o*(c-ut)+s*(l-ft)+h*(a-et),v<=0&&(u=c-v*o-ut,f=l-v*s-ft,e=a-v*h-et,r=u*u+f*f+e*e,r>gt*gt&&(r=gt/Math.sqrt(r),u*=r,f*=r,e*=r),c=ut+u,l=ft+f,a=et+e,i.addContactInfo(c,l,a,o,s,h,v,it,rt,3,0,!1));else{if(b=u,k=f,d=e,g=o*(b-ut)+s*(k-ft)+h*(d-et),b-=g*o,k-=g*s,d-=g*h,ii>0?(ct=u+wt*ei*2,lt=f+bt*ei*2,at=e+kt*ei*2):(ct=u-wt*ei*2,lt=f-bt*ei*2,at=e-kt*ei*2),dt=o*(ct-ut)+s*(lt-ft)+h*(at-et),ct-=dt*o,lt-=dt*s,at-=dt*h,y=ut-b,p=ft-k,w=et-d,u=ct-b,f=lt-k,e=at-d,er=y*y+p*p+w*w,ui=y*u+p*f+w*e,oi=u*u+f*f+e*e,ti=ui*ui-oi*(er-gt*gt),ti<0)break;ti=Math.sqrt(ti),nt=(ui+ti)/oi,tt=(ui-ti)/oi,tt<nt&&(r=nt,nt=tt,tt=r),tt>1&&(tt=1),nt<0&&(nt=0),u=b+(ct-b)*nt,f=k+(lt-k)*nt,e=d+(at-d)*nt,ct=b+(ct-b)*tt,lt=k+(lt-k)*tt,at=d+(at-d)*tt,b=u,k=f,d=e,r=g+(dt-g)*nt,dt=g+(dt-g)*tt,g=r,g<0&&i.addContactInfo(b,k,d,o,s,h,v,it,rt,1,0,!1),dt<0&&i.addContactInfo(ct,lt,at,o,s,h,v,it,rt,4,0,!1)}break;case 2:if(nu?(ot=tr-wr,st=ir-br,ht=rr-kr,o=-wt,s=-bt,h=-kt):(ot=tr+wr,st=ir+br,ht=rr+kr,o=wt,s=bt,h=kt),ii=o*vt+s*yt+h*pt,r=ii<0?fi:-fi,ut=di+r*vt,ft=gi+r*yt,et=nr+r*pt,si>=.999999?(u=-s,f=h,e=o):(u=o,f=s,e=h),r=u*vt+f*yt+e*pt,y=r*vt-u,p=r*yt-f,w=r*pt-e,r=Math.sqrt(y*y+p*p+w*w),r==0)break;if(r=gt/r,y*=r,p*=r,w*=r,u=ut+y,f=ft+p,e=et+w,ii<-.96||ii>.96)ci=vt*vt*1.5-.5,li=vt*yt*1.5-pt*.866025403,ai=vt*pt*1.5+yt*.866025403,vi=yt*vt*1.5+pt*.866025403,yi=yt*yt*1.5-.5,pi=yt*pt*1.5-vt*.866025403,wi=pt*vt*1.5-yt*.866025403,bi=pt*yt*1.5+vt*.866025403,ki=pt*pt*1.5-.5,c=u,l=f,a=e,v=o*(c-ot)+s*(l-st)+h*(a-ht),u=c-v*o-ot,f=l-v*s-st,e=a-v*h-ht,r=u*u+f*f+e*e,r>ni*ni&&(r=ni/Math.sqrt(r),u*=r,f*=r,e*=r),c=ot+u,l=st+f,a=ht+e,i.addContactInfo(c,l,a,-o,-s,-h,v,it,rt,1,0,!1),c=y*ci+p*li+w*ai,l=y*vi+p*yi+w*pi,a=y*wi+p*bi+w*ki,c=(y=c)+ut,l=(p=l)+ft,a=(w=a)+et,v=o*(c-ot)+s*(l-st)+h*(a-ht),v<=0&&(u=c-v*o-ot,f=l-v*s-st,e=a-v*h-ht,r=u*u+f*f+e*e,r>ni*ni&&(r=ni/Math.sqrt(r),u*=r,f*=r,e*=r),c=ot+u,l=st+f,a=ht+e,i.addContactInfo(c,l,a,-o,-s,-h,v,it,rt,2,0,!1)),c=y*ci+p*li+w*ai,l=y*vi+p*yi+w*pi,a=y*wi+p*bi+w*ki,c=(y=c)+ut,l=(p=l)+ft,a=(w=a)+et,v=o*(c-ot)+s*(l-st)+h*(a-ht),v<=0&&(u=c-v*o-ot,f=l-v*s-st,e=a-v*h-ht,r=u*u+f*f+e*e,r>ni*ni&&(r=ni/Math.sqrt(r),u*=r,f*=r,e*=r),c=ot+u,l=st+f,a=ht+e,i.addContactInfo(c,l,a,-o,-s,-h,v,it,rt,3,0,!1));else{if(b=u,k=f,d=e,g=o*(b-ot)+s*(k-st)+h*(d-ht),b-=g*o,k-=g*s,d-=g*h,ii>0?(ct=u+vt*fi*2,lt=f+yt*fi*2,at=e+pt*fi*2):(ct=u-vt*fi*2,lt=f-yt*fi*2,at=e-pt*fi*2),dt=o*(ct-ot)+s*(lt-st)+h*(at-ht),ct-=dt*o,lt-=dt*s,at-=dt*h,y=ot-b,p=st-k,w=ht-d,u=ct-b,f=lt-k,e=at-d,er=y*y+p*p+w*w,ui=y*u+p*f+w*e,oi=u*u+f*f+e*e,ti=ui*ui-oi*(er-ni*ni),ti<0)break;ti=Math.sqrt(ti),nt=(ui+ti)/oi,tt=(ui-ti)/oi,tt<nt&&(r=nt,nt=tt,tt=r),tt>1&&(tt=1),nt<0&&(nt=0),u=b+(ct-b)*nt,f=k+(lt-k)*nt,e=d+(at-d)*nt,ct=b+(ct-b)*tt,lt=k+(lt-k)*tt,at=d+(at-d)*tt,b=u,k=f,d=e,r=g+(dt-g)*nt,dt=g+(dt-g)*tt,g=r,g<0&&i.addContactInfo(b,k,d,-o,-s,-h,g,it,rt,1,0,!1),dt<0&&i.addContactInfo(ct,lt,at,-o,-s,-h,dt,it,rt,4,0,!1)}}}},OIMO.SphereCylinderCollisionDetector=function(n){OIMO.CollisionDetector.call(this),this.flip=n},OIMO.SphereCylinderCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype),OIMO.SphereCylinderCollisionDetector.prototype.detectCollision=function(n,t,i){var l,f,d;this.flip?(l=t,f=n):(l=n,f=t);var g=l.position,a=g.x,v=g.y,y=g.z,nt=f.position,tt=nt.x,it=nt.y,rt=nt.z,ut=f.normalDirection.x,ft=f.normalDirection.y,et=f.normalDirection.z,e=l.radius,p=f.radius,ct=e+p,c=f.halfHeight,o=a-tt,s=v-it,h=y-rt,u=o*ut+s*ft+h*et;if(!(u<-c-e)&&!(u>c+e)){var ot=tt+u*ut,st=it+u*ft,ht=rt+u*et,w=a-ot,b=v-st,k=y-ht,r=w*w+b*b+k*k;r>ct*ct||(r>p*p&&(r=p/Math.sqrt(r),w*=r,b*=r,k*=r),u<-c?u=-c:u>c&&(u=c),ot=tt+u*ut+w,st=it+u*ft+b,ht=rt+u*et+k,o=ot-a,s=st-v,h=ht-y,r=o*o+s*s+h*h,r>0&&r<e*e&&(r=Math.sqrt(r),d=1/r,o*=d,s*=d,h*=d,i.addContactInfo(a+o*e,v+s*e,y+h*e,o,s,h,r-e,l,f,0,0,!1)))}},OIMO.SphereSphereCollisionDetector=function(){OIMO.CollisionDetector.call(this)},OIMO.SphereSphereCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype),OIMO.SphereSphereCollisionDetector.prototype.detectCollision=function(n,t,i){var c=n,l=t,r=c.position,a=l.position,f=a.x-r.x,e=a.y-r.y,o=a.z-r.z,u=f*f+e*e+o*o,s=c.radius,y=l.radius,v=s+y,h;u>0&&u<v*v&&(u=Math.sqrt(u),h=1/u,f*=h,e*=h,o*=h,i.addContactInfo(r.x+f*s,r.y+e*s,r.z+o*s,f,e,o,u-v,c,l,0,0,!1))},OIMO.nextID=0,OIMO.Shape=function(){this.type=0,this.mass=NaN,this.friction=NaN,this.restitution=NaN,this.parent=null,this.contactList=null,this.numContacts=0,this.id=OIMO.nextID++,this.position=new OIMO.Vec3,this.relativePosition=new OIMO.Vec3,this.localRelativePosition=new OIMO.Vec3,this.rotation=new OIMO.Mat33,this.relativeRotation=new OIMO.Mat33,this.localInertia=new OIMO.Mat33,this.proxy=new OIMO.Proxy,this.proxy.parent=this},OIMO.Shape.prototype={constructor:OIMO.Shape,updateProxy:function(){throw new Error("Inheritance error.");}},OIMO.ShapeConfig=function(){this.position=new OIMO.Vec3,this.rotation=new OIMO.Mat33,this.friction=.5,this.restitution=.5,this.density=1},OIMO.MassInfo=function(){this.mass=0,this.inertia=new OIMO.Mat33},OIMO.BoxShape=function(n,t,i,r){OIMO.Shape.call(this),this.width=t,this.halfWidth=t*.5,this.height=i,this.halfHeight=i*.5,this.depth=r,this.halfDepth=r*.5,this.position.copy(n.position),this.rotation.copy(n.rotation),this.friction=n.friction,this.restitution=n.restitution,this.mass=t*i*r*n.density;var u=this.mass/12;this.localInertia.init(u*(i*i+r*r),0,0,0,u*(t*t+r*r),0,0,0,u*(t*t+i*i)),this.normalDirectionWidth=new OIMO.Vec3,this.normalDirectionHeight=new OIMO.Vec3,this.normalDirectionDepth=new OIMO.Vec3,this.halfDirectionWidth=new OIMO.Vec3,this.halfDirectionHeight=new OIMO.Vec3,this.halfDirectionDepth=new OIMO.Vec3,this.vertex1=new OIMO.Vec3,this.vertex2=new OIMO.Vec3,this.vertex3=new OIMO.Vec3,this.vertex4=new OIMO.Vec3,this.vertex5=new OIMO.Vec3,this.vertex6=new OIMO.Vec3,this.vertex7=new OIMO.Vec3,this.vertex8=new OIMO.Vec3,this.type=OIMO.SHAPE_BOX},OIMO.BoxShape.prototype=Object.create(OIMO.Shape.prototype),OIMO.BoxShape.prototype.updateProxy=function(){var n=this.rotation.elements,v,y,p;this.normalDirectionWidth.x=n[0],this.normalDirectionWidth.y=n[3],this.normalDirectionWidth.z=n[6],this.normalDirectionHeight.x=n[1],this.normalDirectionHeight.y=n[4],this.normalDirectionHeight.z=n[7],this.normalDirectionDepth.x=n[2],this.normalDirectionDepth.y=n[5],this.normalDirectionDepth.z=n[8],this.halfDirectionWidth.x=n[0]*this.halfWidth,this.halfDirectionWidth.y=n[3]*this.halfWidth,this.halfDirectionWidth.z=n[6]*this.halfWidth,this.halfDirectionHeight.x=n[1]*this.halfHeight,this.halfDirectionHeight.y=n[4]*this.halfHeight,this.halfDirectionHeight.z=n[7]*this.halfHeight,this.halfDirectionDepth.x=n[2]*this.halfDepth,this.halfDirectionDepth.y=n[5]*this.halfDepth,this.halfDirectionDepth.z=n[8]*this.halfDepth;var t=this.halfDirectionWidth.x,i=this.halfDirectionWidth.y,r=this.halfDirectionWidth.z,u=this.halfDirectionHeight.x,f=this.halfDirectionHeight.y,e=this.halfDirectionHeight.z,o=this.halfDirectionDepth.x,s=this.halfDirectionDepth.y,h=this.halfDirectionDepth.z,c=this.position.x,l=this.position.y,a=this.position.z;this.vertex1.x=c+t+u+o,this.vertex1.y=l+i+f+s,this.vertex1.z=a+r+e+h,this.vertex2.x=c+t+u-o,this.vertex2.y=l+i+f-s,this.vertex2.z=a+r+e-h,this.vertex3.x=c+t-u+o,this.vertex3.y=l+i-f+s,this.vertex3.z=a+r-e+h,this.vertex4.x=c+t-u-o,this.vertex4.y=l+i-f-s,this.vertex4.z=a+r-e-h,this.vertex5.x=c-t+u+o,this.vertex5.y=l-i+f+s,this.vertex5.z=a-r+e+h,this.vertex6.x=c-t+u-o,this.vertex6.y=l-i+f-s,this.vertex6.z=a-r+e-h,this.vertex7.x=c-t-u+o,this.vertex7.y=l-i-f+s,this.vertex7.z=a-r-e+h,this.vertex8.x=c-t-u-o,this.vertex8.y=l-i-f-s,this.vertex8.z=a-r-e-h,v=this.halfDirectionWidth.x<0?-this.halfDirectionWidth.x:this.halfDirectionWidth.x,y=this.halfDirectionWidth.y<0?-this.halfDirectionWidth.y:this.halfDirectionWidth.y,p=this.halfDirectionWidth.z<0?-this.halfDirectionWidth.z:this.halfDirectionWidth.z,this.halfDirectionHeight.x<0?v-=this.halfDirectionHeight.x:v+=this.halfDirectionHeight.x,this.halfDirectionHeight.y<0?y-=this.halfDirectionHeight.y:y+=this.halfDirectionHeight.y,this.halfDirectionHeight.z<0?p-=this.halfDirectionHeight.z:p+=this.halfDirectionHeight.z,this.halfDirectionDepth.x<0?v-=this.halfDirectionDepth.x:v+=this.halfDirectionDepth.x,this.halfDirectionDepth.y<0?y-=this.halfDirectionDepth.y:y+=this.halfDirectionDepth.y,this.halfDirectionDepth.z<0?p-=this.halfDirectionDepth.z:p+=this.halfDirectionDepth.z,this.proxy.init(this.position.x-v,this.position.x+v,this.position.y-y,this.position.y+y,this.position.z-p,this.position.z+p)},OIMO.CylinderShape=function(n,t,i){OIMO.Shape.call(this),this.radius=t,this.height=i,this.halfHeight=i*.5,this.position.copy(n.position),this.rotation.copy(n.rotation),this.friction=n.friction,this.restitution=n.restitution,this.mass=Math.PI*t*t*i*n.density;var r=(1/4*t*t+1/12*i*i)*this.mass,u=1/2*t*t;this.localInertia.init(r,0,0,0,u,0,0,0,r),this.normalDirection=new OIMO.Vec3,this.halfDirection=new OIMO.Vec3,this.type=OIMO.SHAPE_CYLINDER},OIMO.CylinderShape.prototype=Object.create(OIMO.Shape.prototype),OIMO.CylinderShape.prototype.updateProxy=function(){var v=this.rotation.elements,n,t,i,r,u=v[1],f=v[4],e=v[7],c=u*u,l=f*f,a=e*e,o,s,h;this.normalDirection.x=u,this.normalDirection.y=f,this.normalDirection.z=e,this.halfDirection.x=u*this.halfHeight,this.halfDirection.y=f*this.halfHeight,this.halfDirection.z=e*this.halfHeight,t=1-u*u,n=Math.sqrt(t*t+c*l+c*a),n>0&&(n=this.radius/n),t*=n,i=1-f*f,n=Math.sqrt(l*c+i*i+l*a),n>0&&(n=this.radius/n),i*=n,r=1-e*e,n=Math.sqrt(a*c+a*l+r*r),n>0&&(n=this.radius/n),r*=n,o=this.halfDirection.x<0?-this.halfDirection.x:this.halfDirection.x,s=this.halfDirection.y<0?-this.halfDirection.y:this.halfDirection.y,h=this.halfDirection.z<0?-this.halfDirection.z:this.halfDirection.z,t<0?o-=t:o+=t,i<0?s-=i:s+=i,r<0?h-=r:h+=r,this.proxy.init(this.position.x-o,this.position.x+o,this.position.y-s,this.position.y+s,this.position.z-h,this.position.z+h)},OIMO.SphereShape=function(n,t){OIMO.Shape.call(this),this.radius=t,this.position.copy(n.position),this.rotation.copy(n.rotation),this.friction=n.friction,this.restitution=n.restitution,this.mass=4/3*Math.PI*t*t*t*n.density;var i=2/5*t*t*this.mass;this.localInertia.init(i,0,0,0,i,0,0,0,i),this.type=OIMO.SHAPE_SPHERE},OIMO.SphereShape.prototype=Object.create(OIMO.Shape.prototype),OIMO.SphereShape.prototype.updateProxy=function(){this.proxy.init(this.position.x-this.radius,this.position.x+this.radius,this.position.y-this.radius,this.position.y+this.radius,this.position.z-this.radius,this.position.z+this.radius)},OIMO.Constraint=function(){this.parent=null,this.body1=null,this.body2=null,this.addedToIsland=!1,this.sleeping=!1},OIMO.Constraint.prototype={constructor:OIMO.Constraint,preSolve:function(){throw new Error("preSolve Method is not inherited");},solve:function(){throw new Error("solve Method is not inherited");},postSolve:function(){throw new Error("postSolve Method is not inherited");}},OIMO.ContactConnection=function(n){this.prev=null,this.next=null,this.connectedShape=null,this.connectedBody=null,this.parent=n},OIMO.Contact=function(){OIMO.Constraint.call(this),this.overlap=NaN,this.normalDenominator=NaN,this.tangentDenominator=NaN,this.binormalDenominator=NaN,this.shape1=null,this.shape2=null,this.warmStarted=!1,this.lVel1=null,this.lVel2=null,this.aVel1=null,this.aVel2=null,this.relPos1X=NaN,this.relPos1Y=NaN,this.relPos1Z=NaN,this.relPos2X=NaN,this.relPos2Y=NaN,this.relPos2Z=NaN,this.relVelX=NaN,this.relVelY=NaN,this.relVelZ=NaN,this.norX=NaN,this.norY=NaN,this.norZ=NaN,this.tanX=NaN,this.tanY=NaN,this.tanZ=NaN,this.binX=NaN,this.binY=NaN,this.binZ=NaN,this.norTorque1X=NaN,this.norTorque1Y=NaN,this.norTorque1Z=NaN,this.norTorque2X=NaN,this.norTorque2Y=NaN,this.norTorque2Z=NaN,this.tanTorque1X=NaN,this.tanTorque1Y=NaN,this.tanTorque1Z=NaN,this.tanTorque2X=NaN,this.tanTorque2Y=NaN,this.tanTorque2Z=NaN,this.binTorque1X=NaN,this.binTorque1Y=NaN,this.binTorque1Z=NaN,this.binTorque2X=NaN,this.binTorque2Y=NaN,this.binTorque2Z=NaN,this.norTorqueUnit1X=NaN,this.norTorqueUnit1Y=NaN,this.norTorqueUnit1Z=NaN,this.norTorqueUnit2X=NaN,this.norTorqueUnit2Y=NaN,this.norTorqueUnit2Z=NaN,this.tanTorqueUnit1X=NaN,this.tanTorqueUnit1Y=NaN,this.tanTorqueUnit1Z=NaN,this.tanTorqueUnit2X=NaN,this.tanTorqueUnit2Y=NaN,this.tanTorqueUnit2Z=NaN,this.binTorqueUnit1X=NaN,this.binTorqueUnit1Y=NaN,this.binTorqueUnit1Z=NaN,this.binTorqueUnit2X=NaN,this.binTorqueUnit2Y=NaN,this.binTorqueUnit2Z=NaN,this.invM1=NaN,this.invM2=NaN,this.invI1e00=NaN,this.invI1e01=NaN,this.invI1e02=NaN,this.invI1e10=NaN,this.invI1e11=NaN,this.invI1e12=NaN,this.invI1e20=NaN,this.invI1e21=NaN,this.invI1e22=NaN,this.invI2e00=NaN,this.invI2e01=NaN,this.invI2e02=NaN,this.invI2e10=NaN,this.invI2e11=NaN,this.invI2e12=NaN,this.invI2e20=NaN,this.invI2e21=NaN,this.invI2e22=NaN,this.targetNormalVelocity=NaN,this.targetSeparateVelocity=NaN,this.friction=NaN,this.restitution=NaN,this.position=new OIMO.Vec3,this.relativePosition1=new OIMO.Vec3,this.relativePosition2=new OIMO.Vec3,this.normal=new OIMO.Vec3,this.tangent=new OIMO.Vec3,this.binormal=new OIMO.Vec3,this.shapeConnection1=new OIMO.ContactConnection(this),this.shapeConnection2=new OIMO.ContactConnection(this),this.bodyConnection1=new OIMO.ContactConnection(this),this.bodyConnection2=new OIMO.ContactConnection(this),this.id=new OIMO.ContactID,this.normalImpulse=0,this.tangentImpulse=0,this.binormalImpulse=0},OIMO.Contact.prototype=Object.create(OIMO.Constraint.prototype),OIMO.Contact.prototype.setupFromContactInfo=function(n){this.position.x=n.position.x,this.position.y=n.position.y,this.position.z=n.position.z,this.norX=n.normal.x,this.norY=n.normal.y,this.norZ=n.normal.z,this.overlap=n.overlap,this.shape1=n.shape1,this.shape2=n.shape2,this.body1=this.shape1.parent,this.body2=this.shape2.parent,this.bodyConnection1.connectedBody=this.body2,this.bodyConnection1.connectedShape=this.shape2,this.shapeConnection1.connectedBody=this.body2,this.shapeConnection1.connectedShape=this.shape2,this.bodyConnection2.connectedBody=this.body1,this.bodyConnection2.connectedShape=this.shape1,this.shapeConnection2.connectedBody=this.body1,this.shapeConnection2.connectedShape=this.shape1,this.relPos1X=this.position.x-this.body1.position.x,this.relPos1Y=this.position.y-this.body1.position.y,this.relPos1Z=this.position.z-this.body1.position.z,this.relPos2X=this.position.x-this.body2.position.x,this.relPos2Y=this.position.y-this.body2.position.y,this.relPos2Z=this.position.z-this.body2.position.z,this.lVel1=this.body1.linearVelocity,this.lVel2=this.body2.linearVelocity,this.aVel1=this.body1.angularVelocity,this.aVel2=this.body2.angularVelocity,this.invM1=this.body1.invertMass,this.invM2=this.body2.invertMass;var t;t=this.body1.invertInertia.elements,this.invI1e00=t[0],this.invI1e01=t[1],this.invI1e02=t[2],this.invI1e10=t[3],this.invI1e11=t[4],this.invI1e12=t[5],this.invI1e20=t[6],this.invI1e21=t[7],this.invI1e22=t[8],t=this.body2.invertInertia.elements,this.invI2e00=t[0],this.invI2e01=t[1],this.invI2e02=t[2],this.invI2e10=t[3],this.invI2e11=t[4],this.invI2e12=t[5],this.invI2e20=t[6],this.invI2e21=t[7],this.invI2e22=t[8],this.id.data1=n.id.data1,this.id.data2=n.id.data2,this.id.flip=n.id.flip,this.friction=this.shape1.friction*this.shape2.friction,this.restitution=this.shape1.restitution*this.shape2.restitution,this.overlap=n.overlap,this.normalImpulse=0,this.tangentImpulse=0,this.binormalImpulse=0,this.warmStarted=!1},OIMO.Contact.prototype.removeReferences=function(){this.shape1=null,this.shape2=null,this.body1=null,this.body2=null,this.bodyConnection1.connectedBody=null,this.bodyConnection1.connectedShape=null,this.shapeConnection1.connectedBody=null,this.shapeConnection1.connectedShape=null,this.bodyConnection2.connectedBody=null,this.bodyConnection2.connectedShape=null,this.shapeConnection2.connectedBody=null,this.shapeConnection2.connectedShape=null},OIMO.Contact.prototype.preSolve=function(n,t){var s,h,i,r,u,f,e,o,c;this.relVelX=this.lVel2.x+this.aVel2.y*this.relPos2Z-this.aVel2.z*this.relPos2Y-(this.lVel1.x+this.aVel1.y*this.relPos1Z-this.aVel1.z*this.relPos1Y),this.relVelY=this.lVel2.y+this.aVel2.z*this.relPos2X-this.aVel2.x*this.relPos2Z-(this.lVel1.y+this.aVel1.z*this.relPos1X-this.aVel1.x*this.relPos1Z),this.relVelZ=this.lVel2.z+this.aVel2.x*this.relPos2Y-this.aVel2.y*this.relPos2X-(this.lVel1.z+this.aVel1.x*this.relPos1Y-this.aVel1.y*this.relPos1X),s=this.norX*this.relVelX+this.norY*this.relVelY+this.norZ*this.relVelZ,this.tanX=this.relVelX-s*this.norX,this.tanY=this.relVelY-s*this.norY,this.tanZ=this.relVelZ-s*this.norZ,h=this.tanX*this.tanX+this.tanY*this.tanY+this.tanZ*this.tanZ,h>.01?h=1/Math.sqrt(h):(this.tanX=this.norY*this.norX-this.norZ*this.norZ,this.tanY=-this.norZ*this.norY-this.norX*this.norX,this.tanZ=this.norX*this.norZ+this.norY*this.norY,h=1/Math.sqrt(this.tanX*this.tanX+this.tanY*this.tanY+this.tanZ*this.tanZ)),this.tanX*=h,this.tanY*=h,this.tanZ*=h,this.binX=this.norY*this.tanZ-this.norZ*this.tanY,this.binY=this.norZ*this.tanX-this.norX*this.tanZ,this.binZ=this.norX*this.tanY-this.norY*this.tanX,this.norTorque1X=this.relPos1Y*this.norZ-this.relPos1Z*this.norY,this.norTorque1Y=this.relPos1Z*this.norX-this.relPos1X*this.norZ,this.norTorque1Z=this.relPos1X*this.norY-this.relPos1Y*this.norX,this.norTorque2X=this.relPos2Y*this.norZ-this.relPos2Z*this.norY,this.norTorque2Y=this.relPos2Z*this.norX-this.relPos2X*this.norZ,this.norTorque2Z=this.relPos2X*this.norY-this.relPos2Y*this.norX,this.tanTorque1X=this.relPos1Y*this.tanZ-this.relPos1Z*this.tanY,this.tanTorque1Y=this.relPos1Z*this.tanX-this.relPos1X*this.tanZ,this.tanTorque1Z=this.relPos1X*this.tanY-this.relPos1Y*this.tanX,this.tanTorque2X=this.relPos2Y*this.tanZ-this.relPos2Z*this.tanY,this.tanTorque2Y=this.relPos2Z*this.tanX-this.relPos2X*this.tanZ,this.tanTorque2Z=this.relPos2X*this.tanY-this.relPos2Y*this.tanX,this.binTorque1X=this.relPos1Y*this.binZ-this.relPos1Z*this.binY,this.binTorque1Y=this.relPos1Z*this.binX-this.relPos1X*this.binZ,this.binTorque1Z=this.relPos1X*this.binY-this.relPos1Y*this.binX,this.binTorque2X=this.relPos2Y*this.binZ-this.relPos2Z*this.binY,this.binTorque2Y=this.relPos2Z*this.binX-this.relPos2X*this.binZ,this.binTorque2Z=this.relPos2X*this.binY-this.relPos2Y*this.binX,this.norTorqueUnit1X=this.norTorque1X*this.invI1e00+this.norTorque1Y*this.invI1e01+this.norTorque1Z*this.invI1e02,this.norTorqueUnit1Y=this.norTorque1X*this.invI1e10+this.norTorque1Y*this.invI1e11+this.norTorque1Z*this.invI1e12,this.norTorqueUnit1Z=this.norTorque1X*this.invI1e20+this.norTorque1Y*this.invI1e21+this.norTorque1Z*this.invI1e22,this.norTorqueUnit2X=this.norTorque2X*this.invI2e00+this.norTorque2Y*this.invI2e01+this.norTorque2Z*this.invI2e02,this.norTorqueUnit2Y=this.norTorque2X*this.invI2e10+this.norTorque2Y*this.invI2e11+this.norTorque2Z*this.invI2e12,this.norTorqueUnit2Z=this.norTorque2X*this.invI2e20+this.norTorque2Y*this.invI2e21+this.norTorque2Z*this.invI2e22,this.tanTorqueUnit1X=this.tanTorque1X*this.invI1e00+this.tanTorque1Y*this.invI1e01+this.tanTorque1Z*this.invI1e02,this.tanTorqueUnit1Y=this.tanTorque1X*this.invI1e10+this.tanTorque1Y*this.invI1e11+this.tanTorque1Z*this.invI1e12,this.tanTorqueUnit1Z=this.tanTorque1X*this.invI1e20+this.tanTorque1Y*this.invI1e21+this.tanTorque1Z*this.invI1e22,this.tanTorqueUnit2X=this.tanTorque2X*this.invI2e00+this.tanTorque2Y*this.invI2e01+this.tanTorque2Z*this.invI2e02,this.tanTorqueUnit2Y=this.tanTorque2X*this.invI2e10+this.tanTorque2Y*this.invI2e11+this.tanTorque2Z*this.invI2e12,this.tanTorqueUnit2Z=this.tanTorque2X*this.invI2e20+this.tanTorque2Y*this.invI2e21+this.tanTorque2Z*this.invI2e22,this.binTorqueUnit1X=this.binTorque1X*this.invI1e00+this.binTorque1Y*this.invI1e01+this.binTorque1Z*this.invI1e02,this.binTorqueUnit1Y=this.binTorque1X*this.invI1e10+this.binTorque1Y*this.invI1e11+this.binTorque1Z*this.invI1e12,this.binTorqueUnit1Z=this.binTorque1X*this.invI1e20+this.binTorque1Y*this.invI1e21+this.binTorque1Z*this.invI1e22,this.binTorqueUnit2X=this.binTorque2X*this.invI2e00+this.binTorque2Y*this.invI2e01+this.binTorque2Z*this.invI2e02,this.binTorqueUnit2Y=this.binTorque2X*this.invI2e10+this.binTorque2Y*this.invI2e11+this.binTorque2Z*this.invI2e12,this.binTorqueUnit2Z=this.binTorque2X*this.invI2e20+this.binTorque2Y*this.invI2e21+this.binTorque2Z*this.invI2e22,i=this.norTorque1X*this.invI1e00+this.norTorque1Y*this.invI1e01+this.norTorque1Z*this.invI1e02,r=this.norTorque1X*this.invI1e10+this.norTorque1Y*this.invI1e11+this.norTorque1Z*this.invI1e12,u=this.norTorque1X*this.invI1e20+this.norTorque1Y*this.invI1e21+this.norTorque1Z*this.invI1e22,f=r*this.relPos1Z-u*this.relPos1Y,e=u*this.relPos1X-i*this.relPos1Z,o=i*this.relPos1Y-r*this.relPos1X,i=this.norTorque2X*this.invI2e00+this.norTorque2Y*this.invI2e01+this.norTorque2Z*this.invI2e02,r=this.norTorque2X*this.invI2e10+this.norTorque2Y*this.invI2e11+this.norTorque2Z*this.invI2e12,u=this.norTorque2X*this.invI2e20+this.norTorque2Y*this.invI2e21+this.norTorque2Z*this.invI2e22,f+=r*this.relPos2Z-u*this.relPos2Y,e+=u*this.relPos2X-i*this.relPos2Z,o+=i*this.relPos2Y-r*this.relPos2X,this.normalDenominator=1/(this.invM1+this.invM2+this.norX*f+this.norY*e+this.norZ*o),i=this.tanTorque1X*this.invI1e00+this.tanTorque1Y*this.invI1e01+this.tanTorque1Z*this.invI1e02,r=this.tanTorque1X*this.invI1e10+this.tanTorque1Y*this.invI1e11+this.tanTorque1Z*this.invI1e12,u=this.tanTorque1X*this.invI1e20+this.tanTorque1Y*this.invI1e21+this.tanTorque1Z*this.invI1e22,f=r*this.relPos1Z-u*this.relPos1Y,e=u*this.relPos1X-i*this.relPos1Z,o=i*this.relPos1Y-r*this.relPos1X,i=this.tanTorque2X*this.invI2e00+this.tanTorque2Y*this.invI2e01+this.tanTorque2Z*this.invI2e02,r=this.tanTorque2X*this.invI2e10+this.tanTorque2Y*this.invI2e11+this.tanTorque2Z*this.invI2e12,u=this.tanTorque2X*this.invI2e20+this.tanTorque2Y*this.invI2e21+this.tanTorque2Z*this.invI2e22,f+=r*this.relPos2Z-u*this.relPos2Y,e+=u*this.relPos2X-i*this.relPos2Z,o+=i*this.relPos2Y-r*this.relPos2X,this.tangentDenominator=1/(this.invM1+this.invM2+this.tanX*f+this.tanY*e+this.tanZ*o),i=this.binTorque1X*this.invI1e00+this.binTorque1Y*this.invI1e01+this.binTorque1Z*this.invI1e02,r=this.binTorque1X*this.invI1e10+this.binTorque1Y*this.invI1e11+this.binTorque1Z*this.invI1e12,u=this.binTorque1X*this.invI1e20+this.binTorque1Y*this.invI1e21+this.binTorque1Z*this.invI1e22,f=r*this.relPos1Z-u*this.relPos1Y,e=u*this.relPos1X-i*this.relPos1Z,o=i*this.relPos1Y-r*this.relPos1X,i=this.binTorque2X*this.invI2e00+this.binTorque2Y*this.invI2e01+this.binTorque2Z*this.invI2e02,r=this.binTorque2X*this.invI2e10+this.binTorque2Y*this.invI2e11+this.binTorque2Z*this.invI2e12,u=this.binTorque2X*this.invI2e20+this.binTorque2Y*this.invI2e21+this.binTorque2Z*this.invI2e22,f+=r*this.relPos2Z-u*this.relPos2Y,e+=u*this.relPos2X-i*this.relPos2Z,o+=i*this.relPos2Y-r*this.relPos2X,this.binormalDenominator=1/(this.invM1+this.invM2+this.binX*f+this.binY*e+this.binZ*o),this.warmStarted&&(this.tangentImpulse*=.95,this.binormalImpulse*=.95,i=this.norX*this.normalImpulse+this.tanX*this.tangentImpulse+this.binX*this.binormalImpulse,r=this.norY*this.normalImpulse+this.tanY*this.tangentImpulse+this.binY*this.binormalImpulse,u=this.norZ*this.normalImpulse+this.tanZ*this.tangentImpulse+this.binZ*this.binormalImpulse,this.lVel1.x+=i*this.invM1,this.lVel1.y+=r*this.invM1,this.lVel1.z+=u*this.invM1,this.aVel1.x+=this.norTorqueUnit1X*this.normalImpulse+this.tanTorqueUnit1X*this.tangentImpulse+this.binTorqueUnit1X*this.binormalImpulse,this.aVel1.y+=this.norTorqueUnit1Y*this.normalImpulse+this.tanTorqueUnit1Y*this.tangentImpulse+this.binTorqueUnit1Y*this.binormalImpulse,this.aVel1.z+=this.norTorqueUnit1Z*this.normalImpulse+this.tanTorqueUnit1Z*this.tangentImpulse+this.binTorqueUnit1Z*this.binormalImpulse,this.lVel2.x-=i*this.invM2,this.lVel2.y-=r*this.invM2,this.lVel2.z-=u*this.invM2,this.aVel2.x-=this.norTorqueUnit2X*this.normalImpulse+this.tanTorqueUnit2X*this.tangentImpulse+this.binTorqueUnit2X*this.binormalImpulse,this.aVel2.y-=this.norTorqueUnit2Y*this.normalImpulse+this.tanTorqueUnit2Y*this.tangentImpulse+this.binTorqueUnit2Y*this.binormalImpulse,this.aVel2.z-=this.norTorqueUnit2Z*this.normalImpulse+this.tanTorqueUnit2Z*this.tangentImpulse+this.binTorqueUnit2Z*this.binormalImpulse,s=0),s>-1&&(s=0),this.targetNormalVelocity=this.restitution*-s,c=-this.overlap-.005,c>0&&(c*=t*.05,this.targetNormalVelocity<c&&(this.targetNormalVelocity=c))},OIMO.Contact.prototype.solve=function(){var c,o,n,h,t,i,r,u,f,l,a,v,s,e;i=(this.lVel2.x-this.lVel1.x)*this.norX+(this.lVel2.y-this.lVel1.y)*this.norY+(this.lVel2.z-this.lVel1.z)*this.norZ+this.aVel2.x*this.norTorque2X+this.aVel2.y*this.norTorque2Y+this.aVel2.z*this.norTorque2Z-this.aVel1.x*this.norTorque1X-this.aVel1.y*this.norTorque1Y-this.aVel1.z*this.norTorque1Z,o=this.normalImpulse,n=(i-this.targetNormalVelocity)*this.normalDenominator*1.4,this.normalImpulse+=n,this.normalImpulse>0&&(this.normalImpulse=0),n=this.normalImpulse-o,r=this.norX*n,u=this.norY*n,f=this.norZ*n,this.lVel1.x+=r*this.invM1,this.lVel1.y+=u*this.invM1,this.lVel1.z+=f*this.invM1,this.aVel1.x+=this.norTorqueUnit1X*n,this.aVel1.y+=this.norTorqueUnit1Y*n,this.aVel1.z+=this.norTorqueUnit1Z*n,this.lVel2.x-=r*this.invM2,this.lVel2.y-=u*this.invM2,this.lVel2.z-=f*this.invM2,this.aVel2.x-=this.norTorqueUnit2X*n,this.aVel2.y-=this.norTorqueUnit2Y*n,this.aVel2.z-=this.norTorqueUnit2Z*n,s=-this.normalImpulse*this.friction,this.relVelX=this.lVel2.x-this.lVel1.x,this.relVelY=this.lVel2.y-this.lVel1.y,this.relVelZ=this.lVel2.z-this.lVel1.z,i=this.relVelX*this.tanX+this.relVelY*this.tanY+this.relVelZ*this.tanZ+this.aVel2.x*this.tanTorque2X+this.aVel2.y*this.tanTorque2Y+this.aVel2.z*this.tanTorque2Z-this.aVel1.x*this.tanTorque1X-this.aVel1.y*this.tanTorque1Y-this.aVel1.z*this.tanTorque1Z,o=this.tangentImpulse,n=i*this.tangentDenominator,this.tangentImpulse+=n,i=this.relVelX*this.binX+this.relVelY*this.binY+this.relVelZ*this.binZ+this.aVel2.x*this.binTorque2X+this.aVel2.y*this.binTorque2Y+this.aVel2.z*this.binTorque2Z-this.aVel1.x*this.binTorque1X-this.aVel1.y*this.binTorque1Y-this.aVel1.z*this.binTorque1Z,h=this.binormalImpulse,t=i*this.binormalDenominator,this.binormalImpulse+=t,e=this.tangentImpulse*this.tangentImpulse+this.binormalImpulse*this.binormalImpulse,e>s*s&&(e=s/Math.sqrt(e),this.tangentImpulse*=e,this.binormalImpulse*=e),n=this.tangentImpulse-o,t=this.binormalImpulse-h,r=this.tanX*n+this.binX*t,u=this.tanY*n+this.binY*t,f=this.tanZ*n+this.binZ*t,this.lVel1.x+=r*this.invM1,this.lVel1.y+=u*this.invM1,this.lVel1.z+=f*this.invM1,this.aVel1.x+=this.tanTorqueUnit1X*n+this.binTorqueUnit1X*t,this.aVel1.y+=this.tanTorqueUnit1Y*n+this.binTorqueUnit1Y*t,this.aVel1.z+=this.tanTorqueUnit1Z*n+this.binTorqueUnit1Z*t,this.lVel2.x-=r*this.invM2,this.lVel2.y-=u*this.invM2,this.lVel2.z-=f*this.invM2,this.aVel2.x-=this.tanTorqueUnit2X*n+this.binTorqueUnit2X*t,this.aVel2.y-=this.tanTorqueUnit2Y*n+this.binTorqueUnit2Y*t,this.aVel2.z-=this.tanTorqueUnit2Z*n+this.binTorqueUnit2Z*t},OIMO.Contact.prototype.postSolve=function(){this.relativePosition1.x=this.relPos1X,this.relativePosition1.y=this.relPos1Y,this.relativePosition1.z=this.relPos1Z,this.relativePosition2.x=this.relPos2X,this.relativePosition2.y=this.relPos2Y,this.relativePosition2.z=this.relPos2Z,this.normal.x=this.norX,this.normal.y=this.norY,this.normal.z=this.norZ,this.tangent.x=this.tanX,this.tangent.y=this.tanY,this.tangent.z=this.tanZ,this.binormal.x=this.binX,this.binormal.y=this.binY,this.binormal.z=this.binZ},OIMO.JointConnection=function(n){this.prev=null,this.next=null,this.connected=null,this.parent=n},OIMO.JointConfig=function(){this.localRelativeAnchorPosition1=new OIMO.Vec3,this.localRelativeAnchorPosition2=new OIMO.Vec3,this.localAxis1=new OIMO.Vec3,this.localAxis2=new OIMO.Vec3,this.allowCollision=!1},OIMO.Joint=function(){OIMO.Constraint.call(this),this.JOINT_NULL=0,this.JOINT_DISTANCE=1,this.JOINT_BALL=2,this.JOINT_HINGE=3,this.JOINT_HINGE2=4,this.name="",this.type=0,this.allowCollision=!1,this.localRelativeAnchorPosition1=new OIMO.Vec3,this.localRelativeAnchorPosition2=new OIMO.Vec3,this.relativeAnchorPosition1=new OIMO.Vec3,this.relativeAnchorPosition2=new OIMO.Vec3,this.anchorPosition1=new OIMO.Vec3,this.anchorPosition2=new OIMO.Vec3,this.connection1=new OIMO.JointConnection(this),this.connection2=new OIMO.JointConnection(this),this.matrix=new OIMO.Mat44},OIMO.Joint.prototype=Object.create(OIMO.Constraint.prototype),OIMO.Joint.prototype.preSolve=function(){},OIMO.Joint.prototype.solve=function(){},OIMO.Joint.prototype.postSolve=function(){},OIMO.Joint.prototype.getMatrix=function(){var n=this.matrix.elements,t=this.anchorPosition1,i=this.anchorPosition2;return n[0]=t.x*OIMO.WORLD_SCALE,n[1]=t.y*OIMO.WORLD_SCALE,n[2]=t.z*OIMO.WORLD_SCALE,n[3]=0,n[4]=i.x*OIMO.WORLD_SCALE,n[5]=i.y*OIMO.WORLD_SCALE,n[6]=i.z*OIMO.WORLD_SCALE,n[7]=0,n},OIMO.BallJoint=function(n,t,i){OIMO.Joint.call(this),this.relPos1X=NaN,this.relPos1Y=NaN,this.relPos1Z=NaN,this.relPos2X=NaN,this.relPos2Y=NaN,this.relPos2Z=NaN,this.xTorqueUnit1X=NaN,this.xTorqueUnit1Y=NaN,this.xTorqueUnit1Z=NaN,this.xTorqueUnit2X=NaN,this.xTorqueUnit2Y=NaN,this.xTorqueUnit2Z=NaN,this.yTorqueUnit1X=NaN,this.yTorqueUnit1Y=NaN,this.yTorqueUnit1Z=NaN,this.yTorqueUnit2X=NaN,this.yTorqueUnit2Y=NaN,this.yTorqueUnit2Z=NaN,this.zTorqueUnit1X=NaN,this.zTorqueUnit1Y=NaN,this.zTorqueUnit1Z=NaN,this.zTorqueUnit2X=NaN,this.zTorqueUnit2Y=NaN,this.zTorqueUnit2Z=NaN,this.invI1e00=NaN,this.invI1e01=NaN,this.invI1e02=NaN,this.invI1e10=NaN,this.invI1e11=NaN,this.invI1e12=NaN,this.invI1e20=NaN,this.invI1e21=NaN,this.invI1e22=NaN,this.invI2e00=NaN,this.invI2e01=NaN,this.invI2e02=NaN,this.invI2e10=NaN,this.invI2e11=NaN,this.invI2e12=NaN,this.invI2e20=NaN,this.invI2e21=NaN,this.invI2e22=NaN,this.d00=NaN,this.d01=NaN,this.d02=NaN,this.d10=NaN,this.d11=NaN,this.d12=NaN,this.d20=NaN,this.d21=NaN,this.d22=NaN,this.targetVelX=NaN,this.targetVelY=NaN,this.targetVelZ=NaN,this.type=this.JOINT_BALL,this.body1=t,this.body2=i,this.connection1.connected=i,this.connection2.connected=t,this.allowCollision=n.allowCollision,this.localRelativeAnchorPosition1.copy(n.localRelativeAnchorPosition1),this.localRelativeAnchorPosition2.copy(n.localRelativeAnchorPosition2),this.lVel1=this.body1.linearVelocity,this.lVel2=this.body2.linearVelocity,this.aVel1=this.body1.angularVelocity,this.aVel2=this.body2.angularVelocity,this.invM1=this.body1.invertMass,this.invM2=this.body2.invertMass,this.impulse=new OIMO.Vec3,this.impulseX=0,this.impulseY=0,this.impulseZ=0},OIMO.BallJoint.prototype=Object.create(OIMO.Joint.prototype),OIMO.BallJoint.prototype.preSolve=function(n,t){var i,r,c,l,rt,ut,ft,nt,u,f,e,tt,o,s,h,it,a,v,y,p,w,b,k,d,g;i=this.body1.rotation.elements,r=this.localRelativeAnchorPosition1.x,c=this.localRelativeAnchorPosition1.y,l=this.localRelativeAnchorPosition1.z,this.relPos1X=this.relativeAnchorPosition1.x=r*i[0]+c*i[1]+l*i[2],this.relPos1Y=this.relativeAnchorPosition1.y=r*i[3]+c*i[4]+l*i[5],this.relPos1Z=this.relativeAnchorPosition1.z=r*i[6]+c*i[7]+l*i[8],i=this.body2.rotation.elements,r=this.localRelativeAnchorPosition2.x,c=this.localRelativeAnchorPosition2.y,l=this.localRelativeAnchorPosition2.z,this.relPos2X=this.relativeAnchorPosition2.x=r*i[0]+c*i[1]+l*i[2],this.relPos2Y=this.relativeAnchorPosition2.y=r*i[3]+c*i[4]+l*i[5],this.relPos2Z=this.relativeAnchorPosition2.z=r*i[6]+c*i[7]+l*i[8],this.anchorPosition1.x=this.relPos1X+this.body1.position.x,this.anchorPosition1.y=this.relPos1Y+this.body1.position.y,this.anchorPosition1.z=this.relPos1Z+this.body1.position.z,this.anchorPosition2.x=this.relPos2X+this.body2.position.x,this.anchorPosition2.y=this.relPos2Y+this.body2.position.y,this.anchorPosition2.z=this.relPos2Z+this.body2.position.z,i=this.body1.invertInertia.elements,this.invI1e00=i[0],this.invI1e01=i[1],this.invI1e02=i[2],this.invI1e10=i[3],this.invI1e11=i[4],this.invI1e12=i[5],this.invI1e20=i[6],this.invI1e21=i[7],this.invI1e22=i[8],i=this.body2.invertInertia.elements,this.invI2e00=i[0],this.invI2e01=i[1],this.invI2e02=i[2],this.invI2e10=i[3],this.invI2e11=i[4],this.invI2e12=i[5],this.invI2e20=i[6],this.invI2e21=i[7],this.invI2e22=i[8],this.xTorqueUnit1X=this.relPos1Z*this.invI1e01-this.relPos1Y*this.invI1e02,this.xTorqueUnit1Y=this.relPos1Z*this.invI1e11-this.relPos1Y*this.invI1e12,this.xTorqueUnit1Z=this.relPos1Z*this.invI1e21-this.relPos1Y*this.invI1e22,this.xTorqueUnit2X=this.relPos2Z*this.invI2e01-this.relPos2Y*this.invI2e02,this.xTorqueUnit2Y=this.relPos2Z*this.invI2e11-this.relPos2Y*this.invI2e12,this.xTorqueUnit2Z=this.relPos2Z*this.invI2e21-this.relPos2Y*this.invI2e22,this.yTorqueUnit1X=-this.relPos1Z*this.invI1e00+this.relPos1X*this.invI1e02,this.yTorqueUnit1Y=-this.relPos1Z*this.invI1e10+this.relPos1X*this.invI1e12,this.yTorqueUnit1Z=-this.relPos1Z*this.invI1e20+this.relPos1X*this.invI1e22,this.yTorqueUnit2X=-this.relPos2Z*this.invI2e00+this.relPos2X*this.invI2e02,this.yTorqueUnit2Y=-this.relPos2Z*this.invI2e10+this.relPos2X*this.invI2e12,this.yTorqueUnit2Z=-this.relPos2Z*this.invI2e20+this.relPos2X*this.invI2e22,this.zTorqueUnit1X=this.relPos1Y*this.invI1e00-this.relPos1X*this.invI1e01,this.zTorqueUnit1Y=this.relPos1Y*this.invI1e10-this.relPos1X*this.invI1e11,this.zTorqueUnit1Z=this.relPos1Y*this.invI1e20-this.relPos1X*this.invI1e21,this.zTorqueUnit2X=this.relPos2Y*this.invI2e00-this.relPos2X*this.invI2e01,this.zTorqueUnit2Y=this.relPos2Y*this.invI2e10-this.relPos2X*this.invI2e11,this.zTorqueUnit2Z=this.relPos2Y*this.invI2e20-this.relPos2X*this.invI2e21,this.d00=this.invM1+this.invM2,this.d01=0,this.d02=0,this.d10=0,this.d11=this.d00,this.d12=0,this.d20=0,this.d21=0,this.d22=this.d00,u=-this.relPos1Z,f=this.relPos1Y,e=this.relPos1Z,o=-this.relPos1X,s=-this.relPos1Y,h=this.relPos1X,a=this.invI1e01*e+this.invI1e02*s,v=this.invI1e00*u+this.invI1e02*h,y=this.invI1e00*f+this.invI1e01*o,p=this.invI1e11*e+this.invI1e12*s,w=this.invI1e10*u+this.invI1e12*h,b=this.invI1e10*f+this.invI1e11*o,k=this.invI1e21*e+this.invI1e22*s,d=this.invI1e20*u+this.invI1e22*h,g=this.invI1e20*f+this.invI1e21*o,this.d00-=u*p+f*k,this.d01-=u*w+f*d,this.d02-=u*b+f*g,this.d10-=e*a+o*k,this.d11-=e*v+o*d,this.d12-=e*y+o*g,this.d20-=s*a+h*p,this.d21-=s*v+h*w,this.d22-=s*y+h*b,u=-this.relPos2Z,f=this.relPos2Y,e=this.relPos2Z,o=-this.relPos2X,s=-this.relPos2Y,h=this.relPos2X,a=this.invI2e01*e+this.invI2e02*s,v=this.invI2e00*u+this.invI2e02*h,y=this.invI2e00*f+this.invI2e01*o,p=this.invI2e11*e+this.invI2e12*s,w=this.invI2e10*u+this.invI2e12*h,b=this.invI2e10*f+this.invI2e11*o,k=this.invI2e21*e+this.invI2e22*s,d=this.invI2e20*u+this.invI2e22*h,g=this.invI2e20*f+this.invI2e21*o,this.d00-=u*p+f*k,this.d01-=u*w+f*d,this.d02-=u*b+f*g,this.d10-=e*a+o*k,this.d11-=e*v+o*d,this.d12-=e*y+o*g,this.d20-=s*a+h*p,this.d21-=s*v+h*w,this.d22-=s*y+h*b,r=1/(this.d00*(this.d11*this.d22-this.d21*this.d12)+this.d10*(this.d21*this.d02-this.d01*this.d22)+this.d20*(this.d01*this.d12-this.d11*this.d02)),nt=(this.d11*this.d22-this.d12*this.d21)*r,u=(this.d02*this.d21-this.d01*this.d22)*r,f=(this.d01*this.d12-this.d02*this.d11)*r,e=(this.d12*this.d20-this.d10*this.d22)*r,tt=(this.d00*this.d22-this.d02*this.d20)*r,o=(this.d02*this.d10-this.d00*this.d12)*r,s=(this.d10*this.d21-this.d11*this.d20)*r,h=(this.d01*this.d20-this.d00*this.d21)*r,it=(this.d00*this.d11-this.d01*this.d10)*r,this.d00=nt,this.d01=u,this.d02=f,this.d10=e,this.d11=tt,this.d12=o,this.d20=s,this.d21=h,this.d22=it,this.lVel1.x+=this.impulseX*this.invM1,this.lVel1.y+=this.impulseY*this.invM1,this.lVel1.z+=this.impulseZ*this.invM1,this.aVel1.x+=this.xTorqueUnit1X*this.impulseX+this.yTorqueUnit1X*this.impulseY+this.zTorqueUnit1X*this.impulseZ,this.aVel1.y+=this.xTorqueUnit1Y*this.impulseX+this.yTorqueUnit1Y*this.impulseY+this.zTorqueUnit1Y*this.impulseZ,this.aVel1.z+=this.xTorqueUnit1Z*this.impulseX+this.yTorqueUnit1Z*this.impulseY+this.zTorqueUnit1Z*this.impulseZ,this.lVel2.x-=this.impulseX*this.invM2,this.lVel2.y-=this.impulseY*this.invM2,this.lVel2.z-=this.impulseZ*this.invM2,this.aVel2.x-=this.xTorqueUnit2X*this.impulseX+this.yTorqueUnit2X*this.impulseY+this.zTorqueUnit2X*this.impulseZ,this.aVel2.y-=this.xTorqueUnit2Y*this.impulseX+this.yTorqueUnit2Y*this.impulseY+this.zTorqueUnit2Y*this.impulseZ,this.aVel2.z-=this.xTorqueUnit2Z*this.impulseX+this.yTorqueUnit2Z*this.impulseY+this.zTorqueUnit2Z*this.impulseZ,this.targetVelX=this.anchorPosition2.x-this.anchorPosition1.x,this.targetVelY=this.anchorPosition2.y-this.anchorPosition1.y,this.targetVelZ=this.anchorPosition2.z-this.anchorPosition1.z,r=Math.sqrt(this.targetVelX*this.targetVelX+this.targetVelY*this.targetVelY+this.targetVelZ*this.targetVelZ),r<.005?(this.targetVelX=0,this.targetVelY=0,this.targetVelZ=0):(r=(.005-r)/r*t*.05,this.targetVelX*=r,this.targetVelY*=r,this.targetVelZ*=r)},OIMO.BallJoint.prototype.solve=function(){var r,u,f,n,t,i;r=this.lVel2.x-this.lVel1.x+this.aVel2.y*this.relPos2Z-this.aVel2.z*this.relPos2Y-this.aVel1.y*this.relPos1Z+this.aVel1.z*this.relPos1Y-this.targetVelX,u=this.lVel2.y-this.lVel1.y+this.aVel2.z*this.relPos2X-this.aVel2.x*this.relPos2Z-this.aVel1.z*this.relPos1X+this.aVel1.x*this.relPos1Z-this.targetVelY,f=this.lVel2.z-this.lVel1.z+this.aVel2.x*this.relPos2Y-this.aVel2.y*this.relPos2X-this.aVel1.x*this.relPos1Y+this.aVel1.y*this.relPos1X-this.targetVelZ,n=r*this.d00+u*this.d01+f*this.d02,t=r*this.d10+u*this.d11+f*this.d12,i=r*this.d20+u*this.d21+f*this.d22,this.impulseX+=n,this.impulseY+=t,this.impulseZ+=i,this.lVel1.x+=n*this.invM1,this.lVel1.y+=t*this.invM1,this.lVel1.z+=i*this.invM1,this.aVel1.x+=this.xTorqueUnit1X*n+this.yTorqueUnit1X*t+this.zTorqueUnit1X*i,this.aVel1.y+=this.xTorqueUnit1Y*n+this.yTorqueUnit1Y*t+this.zTorqueUnit1Y*i,this.aVel1.z+=this.xTorqueUnit1Z*n+this.yTorqueUnit1Z*t+this.zTorqueUnit1Z*i,this.lVel2.x-=n*this.invM2,this.lVel2.y-=t*this.invM2,this.lVel2.z-=i*this.invM2,this.aVel2.x-=this.xTorqueUnit2X*n+this.yTorqueUnit2X*t+this.zTorqueUnit2X*i,this.aVel2.y-=this.xTorqueUnit2Y*n+this.yTorqueUnit2Y*t+this.zTorqueUnit2Y*i,this.aVel2.z-=this.xTorqueUnit2Z*n+this.yTorqueUnit2Z*t+this.zTorqueUnit2Z*i},OIMO.BallJoint.prototype.postSolve=function(){this.impulse.x=this.impulseX,this.impulse.y=this.impulseY,this.impulse.z=this.impulseZ},OIMO.DistanceJoint=function(n,t,i,r){OIMO.Joint.call(this),this.posError=NaN,this.norX=NaN,this.norY=NaN,this.norZ=NaN,this.relPos1X=NaN,this.relPos1Y=NaN,this.relPos1Z=NaN,this.relPos2X=NaN,this.relPos2Y=NaN,this.relPos2Z=NaN,this.norTorque1X=NaN,this.norTorque1Y=NaN,this.norTorque1Z=NaN,this.norTorque2X=NaN,this.norTorque2Y=NaN,this.norTorque2Z=NaN,this.norTorqueUnit1X=NaN,this.norTorqueUnit1Y=NaN,this.norTorqueUnit1Z=NaN,this.norTorqueUnit2X=NaN,this.norTorqueUnit2Y=NaN,this.norTorqueUnit2Z=NaN,this.invI1e00=NaN,this.invI1e01=NaN,this.invI1e02=NaN,this.invI1e10=NaN,this.invI1e11=NaN,this.invI1e12=NaN,this.invI1e20=NaN,this.invI1e21=NaN,this.invI1e22=NaN,this.invI2e00=NaN,this.invI2e01=NaN,this.invI2e02=NaN,this.invI2e10=NaN,this.invI2e11=NaN,this.invI2e12=NaN,this.invI2e20=NaN,this.invI2e21=NaN,this.invI2e22=NaN,this.normalDenominator=NaN,this.targetNormalVelocity=NaN,this.body1=t,this.body2=i,this.connection1.connected=i,this.connection2.connected=t,this.distance=r,this.allowCollision=n.allowCollision,this.localRelativeAnchorPosition1.copy(n.localRelativeAnchorPosition1),this.localRelativeAnchorPosition2.copy(n.localRelativeAnchorPosition2),this.type=this.JOINT_DISTANCE,this.lVel1=this.body1.linearVelocity,this.lVel2=this.body2.linearVelocity,this.aVel1=this.body1.angularVelocity,this.aVel2=this.body2.angularVelocity,this.invM1=this.body1.invertMass,this.invM2=this.body2.invertMass,this.impulse=0},OIMO.DistanceJoint.prototype=Object.create(OIMO.Joint.prototype),OIMO.DistanceJoint.prototype.preSolve=function(n,t){var i,r,u,f,e,o,s;i=this.body1.rotation.elements,r=this.localRelativeAnchorPosition1.x,u=this.localRelativeAnchorPosition1.y,f=this.localRelativeAnchorPosition1.z,this.relPos1X=this.relativeAnchorPosition1.x=r*i[0]+u*i[1]+f*i[2],this.relPos1Y=this.relativeAnchorPosition1.y=r*i[3]+u*i[4]+f*i[5],this.relPos1Z=this.relativeAnchorPosition1.z=r*i[6]+u*i[7]+f*i[8],i=this.body2.rotation.elements,r=this.localRelativeAnchorPosition2.x,u=this.localRelativeAnchorPosition2.y,f=this.localRelativeAnchorPosition2.z,this.relPos2X=this.relativeAnchorPosition2.x=r*i[0]+u*i[1]+f*i[2],this.relPos2Y=this.relativeAnchorPosition2.y=r*i[3]+u*i[4]+f*i[5],this.relPos2Z=this.relativeAnchorPosition2.z=r*i[6]+u*i[7]+f*i[8],this.norX=(this.anchorPosition2.x=this.relPos2X+this.body2.position.x)-(this.anchorPosition1.x=this.relPos1X+this.body1.position.x),this.norY=(this.anchorPosition2.y=this.relPos2Y+this.body2.position.y)-(this.anchorPosition1.y=this.relPos1Y+this.body1.position.y),this.norZ=(this.anchorPosition2.z=this.relPos2Z+this.body2.position.z)-(this.anchorPosition1.z=this.relPos1Z+this.body1.position.z),r=Math.sqrt(this.norX*this.norX+this.norY*this.norY+this.norZ*this.norZ),this.posError=this.distance-r,r>0&&(r=1/r),this.norX*=r,this.norY*=r,this.norZ*=r,i=this.body1.invertInertia.elements,this.invI1e00=i[0],this.invI1e01=i[1],this.invI1e02=i[2],this.invI1e10=i[3],this.invI1e11=i[4],this.invI1e12=i[5],this.invI1e20=i[6],this.invI1e21=i[7],this.invI1e22=i[8],i=this.body2.invertInertia.elements,this.invI2e00=i[0],this.invI2e01=i[1],this.invI2e02=i[2],this.invI2e10=i[3],this.invI2e11=i[4],this.invI2e12=i[5],this.invI2e20=i[6],this.invI2e21=i[7],this.invI2e22=i[8],this.norTorque1X=this.relPos1Y*this.norZ-this.relPos1Z*this.norY,this.norTorque1Y=this.relPos1Z*this.norX-this.relPos1X*this.norZ,this.norTorque1Z=this.relPos1X*this.norY-this.relPos1Y*this.norX,this.norTorque2X=this.relPos2Y*this.norZ-this.relPos2Z*this.norY,this.norTorque2Y=this.relPos2Z*this.norX-this.relPos2X*this.norZ,this.norTorque2Z=this.relPos2X*this.norY-this.relPos2Y*this.norX,this.norTorqueUnit1X=this.norTorque1X*this.invI1e00+this.norTorque1Y*this.invI1e01+this.norTorque1Z*this.invI1e02,this.norTorqueUnit1Y=this.norTorque1X*this.invI1e10+this.norTorque1Y*this.invI1e11+this.norTorque1Z*this.invI1e12,this.norTorqueUnit1Z=this.norTorque1X*this.invI1e20+this.norTorque1Y*this.invI1e21+this.norTorque1Z*this.invI1e22,this.norTorqueUnit2X=this.norTorque2X*this.invI2e00+this.norTorque2Y*this.invI2e01+this.norTorque2Z*this.invI2e02,this.norTorqueUnit2Y=this.norTorque2X*this.invI2e10+this.norTorque2Y*this.invI2e11+this.norTorque2Z*this.invI2e12,this.norTorqueUnit2Z=this.norTorque2X*this.invI2e20+this.norTorque2Y*this.invI2e21+this.norTorque2Z*this.invI2e22,r=this.norTorque1X*this.invI1e00+this.norTorque1Y*this.invI1e01+this.norTorque1Z*this.invI1e02,u=this.norTorque1X*this.invI1e10+this.norTorque1Y*this.invI1e11+this.norTorque1Z*this.invI1e12,f=this.norTorque1X*this.invI1e20+this.norTorque1Y*this.invI1e21+this.norTorque1Z*this.invI1e22,e=u*this.relPos1Z-f*this.relPos1Y,o=f*this.relPos1X-r*this.relPos1Z,s=r*this.relPos1Y-u*this.relPos1X,r=this.norTorque2X*this.invI2e00+this.norTorque2Y*this.invI2e01+this.norTorque2Z*this.invI2e02,u=this.norTorque2X*this.invI2e10+this.norTorque2Y*this.invI2e11+this.norTorque2Z*this.invI2e12,f=this.norTorque2X*this.invI2e20+this.norTorque2Y*this.invI2e21+this.norTorque2Z*this.invI2e22,e+=u*this.relPos2Z-f*this.relPos2Y,o+=f*this.relPos2X-r*this.relPos2Z,s+=r*this.relPos2Y-u*this.relPos2X,this.normalDenominator=1/(this.invM1+this.invM2+this.norX*e+this.norY*o+this.norZ*s),r=this.norX*this.impulse,u=this.norY*this.impulse,f=this.norZ*this.impulse,this.lVel1.x+=r*this.invM1,this.lVel1.y+=u*this.invM1,this.lVel1.z+=f*this.invM1,this.aVel1.x+=this.norTorqueUnit1X*this.impulse,this.aVel1.y+=this.norTorqueUnit1Y*this.impulse,this.aVel1.z+=this.norTorqueUnit1Z*this.impulse,this.lVel2.x-=r*this.invM2,this.lVel2.y-=u*this.invM2,this.lVel2.z-=f*this.invM2,this.aVel2.x-=this.norTorqueUnit2X*this.impulse,this.aVel2.y-=this.norTorqueUnit2Y*this.impulse,this.aVel2.z-=this.norTorqueUnit2Z*this.impulse,this.posError<-.005?this.posError+=.005:this.posError>.005?this.posError-=.005:this.posError=0,this.targetNormalVelocity=this.posError*t*.05},OIMO.DistanceJoint.prototype.solve=function(){var n,u,t,i,r,f,e,o;u=(this.lVel2.x-this.lVel1.x)*this.norX+(this.lVel2.y-this.lVel1.y)*this.norY+(this.lVel2.z-this.lVel1.z)*this.norZ+this.aVel2.x*this.norTorque2X+this.aVel2.y*this.norTorque2Y+this.aVel2.z*this.norTorque2Z-this.aVel1.x*this.norTorque1X-this.aVel1.y*this.norTorque1Y-this.aVel1.z*this.norTorque1Z,n=(u-this.targetNormalVelocity)*this.normalDenominator,this.impulse+=n,t=this.norX*n,i=this.norY*n,r=this.norZ*n,this.lVel1.x+=t*this.invM1,this.lVel1.y+=i*this.invM1,this.lVel1.z+=r*this.invM1,this.aVel1.x+=this.norTorqueUnit1X*n,this.aVel1.y+=this.norTorqueUnit1Y*n,this.aVel1.z+=this.norTorqueUnit1Z*n,this.lVel2.x-=t*this.invM2,this.lVel2.y-=i*this.invM2,this.lVel2.z-=r*this.invM2,this.aVel2.x-=this.norTorqueUnit2X*n,this.aVel2.y-=this.norTorqueUnit2Y*n,this.aVel2.z-=this.norTorqueUnit2Z*n},OIMO.DistanceJoint.prototype.postSolve=function(){},OIMO.HingeJoint=function(n,t,i){OIMO.Joint.call(this),this.enableLimits=!1,this.lowerLimit=NaN,this.upperLimit=NaN,this.limitSign=0,this.enableMotor=!1,this.motorSpeed=NaN,this.maxMotorTorque=NaN,this.stepMotorTorque=NaN,this.axis1X=NaN,this.axis1Y=NaN,this.axis1Z=NaN,this.axis2X=NaN,this.axis2Y=NaN,this.axis2Z=NaN,this.angAxis1X=NaN,this.angAxis1Y=NaN,this.angAxis1Z=NaN,this.angAxis2X=NaN,this.angAxis2Y=NaN,this.angAxis2Z=NaN,this.norX=NaN,this.norY=NaN,this.norZ=NaN,this.tanX=NaN,this.tanY=NaN,this.tanZ=NaN,this.binX=NaN,this.binY=NaN,this.binZ=NaN,this.hingeAngle=NaN,this.relPos1X=NaN,this.relPos1Y=NaN,this.relPos1Z=NaN,this.relPos2X=NaN,this.relPos2Y=NaN,this.relPos2Z=NaN,this.xTorqueUnit1X=NaN,this.xTorqueUnit1Y=NaN,this.xTorqueUnit1Z=NaN,this.xTorqueUnit2X=NaN,this.xTorqueUnit2Y=NaN,this.xTorqueUnit2Z=NaN,this.yTorqueUnit1X=NaN,this.yTorqueUnit1Y=NaN,this.yTorqueUnit1Z=NaN,this.yTorqueUnit2X=NaN,this.yTorqueUnit2Y=NaN,this.yTorqueUnit2Z=NaN,this.zTorqueUnit1X=NaN,this.zTorqueUnit1Y=NaN,this.zTorqueUnit1Z=NaN,this.zTorqueUnit2X=NaN,this.zTorqueUnit2Y=NaN,this.zTorqueUnit2Z=NaN,this.invI1e00=NaN,this.invI1e01=NaN,this.invI1e02=NaN,this.invI1e10=NaN,this.invI1e11=NaN,this.invI1e12=NaN,this.invI1e20=NaN,this.invI1e21=NaN,this.invI1e22=NaN,this.invI2e00=NaN,this.invI2e01=NaN,this.invI2e02=NaN,this.invI2e10=NaN,this.invI2e11=NaN,this.invI2e12=NaN,this.invI2e20=NaN,this.invI2e21=NaN,this.invI2e22=NaN,this.d00=NaN,this.d01=NaN,this.d02=NaN,this.d10=NaN,this.d11=NaN,this.d12=NaN,this.d20=NaN,this.d21=NaN,this.d22=NaN,this.norDenominator=NaN,this.tanDenominator=NaN,this.binDenominator=NaN,this.invNorDenominator=NaN,this.targetVelX=NaN,this.targetVelY=NaN,this.targetVelZ=NaN,this.targetAngVelNor=NaN,this.targetAngVelTan=NaN,this.targetAngVelBin=NaN,this.body1=t,this.body2=i,this.connection1.connected=i,this.connection2.connected=t,this.localAxis1=new OIMO.Vec3,this.localAxis2=new OIMO.Vec3,this.localAxis1.normalize(n.localAxis1),this.localAxis2.normalize(n.localAxis2);var r;this.localAxis1X=this.localAxis1.x,this.localAxis1Y=this.localAxis1.y,this.localAxis1Z=this.localAxis1.z,this.localAngAxis1X=this.localAxis1Y*this.localAxis1X-this.localAxis1Z*this.localAxis1Z,this.localAngAxis1Y=-this.localAxis1Z*this.localAxis1Y-this.localAxis1X*this.localAxis1X,this.localAngAxis1Z=this.localAxis1X*this.localAxis1Z+this.localAxis1Y*this.localAxis1Y,r=1/Math.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z),this.localAngAxis1X*=r,this.localAngAxis1Y*=r,this.localAngAxis1Z*=r,this.localAxis2X=this.localAxis2.x,this.localAxis2Y=this.localAxis2.y,this.localAxis2Z=this.localAxis2.z,this.localAngAxis2X=this.localAxis2Y*this.localAxis2X-this.localAxis2Z*this.localAxis2Z,this.localAngAxis2Y=-this.localAxis2Z*this.localAxis2Y-this.localAxis2X*this.localAxis2X,this.localAngAxis2Z=this.localAxis2X*this.localAxis2Z+this.localAxis2Y*this.localAxis2Y,r=1/Math.sqrt(this.localAngAxis2X*this.localAngAxis2X+this.localAngAxis2Y*this.localAngAxis2Y+this.localAngAxis2Z*this.localAngAxis2Z),this.localAngAxis2X*=r,this.localAngAxis2Y*=r,this.localAngAxis2Z*=r,this.allowCollision=n.allowCollision,this.localRelativeAnchorPosition1.copy(n.localRelativeAnchorPosition1),this.localRelativeAnchorPosition2.copy(n.localRelativeAnchorPosition2),this.type=this.JOINT_HINGE,this.lVel1=this.body1.linearVelocity,this.lVel2=this.body2.linearVelocity,this.aVel1=this.body1.angularVelocity,this.aVel2=this.body2.angularVelocity,this.invM1=this.body1.invertMass,this.invM2=this.body2.invertMass,this.impulse=new OIMO.Vec3,this.torque=new OIMO.Vec3,this.impulseX=0,this.impulseY=0,this.impulseZ=0,this.limitTorque=0,this.motorTorque=0,this.torqueX=0,this.torqueY=0,this.torqueZ=0,this.torqueTan=0,this.torqueBin=0},OIMO.HingeJoint.prototype=Object.create(OIMO.Joint.prototype),OIMO.HingeJoint.prototype.preSolve=function(n,t){var i,r,c,l,rt,ut,ft,a,u,f,e,v,o,s,h,y,p,w,b,k,d,g,nt,tt,it;i=this.body1.rotation.elements,this.axis1X=this.localAxis1X*i[0]+this.localAxis1Y*i[1]+this.localAxis1Z*i[2],this.axis1Y=this.localAxis1X*i[3]+this.localAxis1Y*i[4]+this.localAxis1Z*i[5],this.axis1Z=this.localAxis1X*i[6]+this.localAxis1Y*i[7]+this.localAxis1Z*i[8],this.angAxis1X=this.localAngAxis1X*i[0]+this.localAngAxis1Y*i[1]+this.localAngAxis1Z*i[2],this.angAxis1Y=this.localAngAxis1X*i[3]+this.localAngAxis1Y*i[4]+this.localAngAxis1Z*i[5],this.angAxis1Z=this.localAngAxis1X*i[6]+this.localAngAxis1Y*i[7]+this.localAngAxis1Z*i[8],r=this.localRelativeAnchorPosition1.x,c=this.localRelativeAnchorPosition1.y,l=this.localRelativeAnchorPosition1.z,this.relPos1X=this.relativeAnchorPosition1.x=r*i[0]+c*i[1]+l*i[2],this.relPos1Y=this.relativeAnchorPosition1.y=r*i[3]+c*i[4]+l*i[5],this.relPos1Z=this.relativeAnchorPosition1.z=r*i[6]+c*i[7]+l*i[8],i=this.body2.rotation.elements,this.axis2X=this.localAxis2X*i[0]+this.localAxis2Y*i[1]+this.localAxis2Z*i[2],this.axis2Y=this.localAxis2X*i[3]+this.localAxis2Y*i[4]+this.localAxis2Z*i[5],this.axis2Z=this.localAxis2X*i[6]+this.localAxis2Y*i[7]+this.localAxis2Z*i[8],this.angAxis2X=this.localAngAxis2X*i[0]+this.localAngAxis2Y*i[1]+this.localAngAxis2Z*i[2],this.angAxis2Y=this.localAngAxis2X*i[3]+this.localAngAxis2Y*i[4]+this.localAngAxis2Z*i[5],this.angAxis2Z=this.localAngAxis2X*i[6]+this.localAngAxis2Y*i[7]+this.localAngAxis2Z*i[8],r=this.localRelativeAnchorPosition2.x,c=this.localRelativeAnchorPosition2.y,l=this.localRelativeAnchorPosition2.z,this.relPos2X=this.relativeAnchorPosition2.x=r*i[0]+c*i[1]+l*i[2],this.relPos2Y=this.relativeAnchorPosition2.y=r*i[3]+c*i[4]+l*i[5],this.relPos2Z=this.relativeAnchorPosition2.z=r*i[6]+c*i[7]+l*i[8],this.anchorPosition1.x=this.relPos1X+this.body1.position.x,this.anchorPosition1.y=this.relPos1Y+this.body1.position.y,this.anchorPosition1.z=this.relPos1Z+this.body1.position.z,this.anchorPosition2.x=this.relPos2X+this.body2.position.x,this.anchorPosition2.y=this.relPos2Y+this.body2.position.y,this.anchorPosition2.z=this.relPos2Z+this.body2.position.z,r=1/(this.invM1+this.invM2),this.norX=(this.axis1X*this.invM1+this.axis2X*this.invM2)*r,this.norY=(this.axis1Y*this.invM1+this.axis2Y*this.invM2)*r,this.norZ=(this.axis1Z*this.invM1+this.axis2Z*this.invM2)*r,r=Math.sqrt(this.norX*this.norX+this.norY*this.norY+this.norZ*this.norZ),r>0&&(r=1/r),this.norX*=r,this.norY*=r,this.norZ*=r,this.tanX=this.norY*this.norX-this.norZ*this.norZ,this.tanY=-this.norZ*this.norY-this.norX*this.norX,this.tanZ=this.norX*this.norZ+this.norY*this.norY,r=1/Math.sqrt(this.tanX*this.tanX+this.tanY*this.tanY+this.tanZ*this.tanZ),this.tanX*=r,this.tanY*=r,this.tanZ*=r,this.binX=this.norY*this.tanZ-this.norZ*this.tanY,this.binY=this.norZ*this.tanX-this.norX*this.tanZ,this.binZ=this.norX*this.tanY-this.norY*this.tanX,this.hingeAngle=this.norX*(this.angAxis1Y*this.angAxis2Z-this.angAxis1Z*this.angAxis2Y)+this.norY*(this.angAxis1Z*this.angAxis2X-this.angAxis1X*this.angAxis2Z)+this.norZ*(this.angAxis1X*this.angAxis2Y-this.angAxis1Y*this.angAxis2X)<0?-Math.acos(this.angAxis1X*this.angAxis2X+this.angAxis1Y*this.angAxis2Y+this.angAxis1Z*this.angAxis2Z):Math.acos(this.angAxis1X*this.angAxis2X+this.angAxis1Y*this.angAxis2Y+this.angAxis1Z*this.angAxis2Z),i=this.body1.invertInertia.elements,this.invI1e00=i[0],this.invI1e01=i[1],this.invI1e02=i[2],this.invI1e10=i[3],this.invI1e11=i[4],this.invI1e12=i[5],this.invI1e20=i[6],this.invI1e21=i[7],this.invI1e22=i[8],i=this.body2.invertInertia.elements,this.invI2e00=i[0],this.invI2e01=i[1],this.invI2e02=i[2],this.invI2e10=i[3],this.invI2e11=i[4],this.invI2e12=i[5],this.invI2e20=i[6],this.invI2e21=i[7],this.invI2e22=i[8],this.xTorqueUnit1X=this.relPos1Z*this.invI1e01-this.relPos1Y*this.invI1e02,this.xTorqueUnit1Y=this.relPos1Z*this.invI1e11-this.relPos1Y*this.invI1e12,this.xTorqueUnit1Z=this.relPos1Z*this.invI1e21-this.relPos1Y*this.invI1e22,this.xTorqueUnit2X=this.relPos2Z*this.invI2e01-this.relPos2Y*this.invI2e02,this.xTorqueUnit2Y=this.relPos2Z*this.invI2e11-this.relPos2Y*this.invI2e12,this.xTorqueUnit2Z=this.relPos2Z*this.invI2e21-this.relPos2Y*this.invI2e22,this.yTorqueUnit1X=-this.relPos1Z*this.invI1e00+this.relPos1X*this.invI1e02,this.yTorqueUnit1Y=-this.relPos1Z*this.invI1e10+this.relPos1X*this.invI1e12,this.yTorqueUnit1Z=-this.relPos1Z*this.invI1e20+this.relPos1X*this.invI1e22,this.yTorqueUnit2X=-this.relPos2Z*this.invI2e00+this.relPos2X*this.invI2e02,this.yTorqueUnit2Y=-this.relPos2Z*this.invI2e10+this.relPos2X*this.invI2e12,this.yTorqueUnit2Z=-this.relPos2Z*this.invI2e20+this.relPos2X*this.invI2e22,this.zTorqueUnit1X=this.relPos1Y*this.invI1e00-this.relPos1X*this.invI1e01,this.zTorqueUnit1Y=this.relPos1Y*this.invI1e10-this.relPos1X*this.invI1e11,this.zTorqueUnit1Z=this.relPos1Y*this.invI1e20-this.relPos1X*this.invI1e21,this.zTorqueUnit2X=this.relPos2Y*this.invI2e00-this.relPos2X*this.invI2e01,this.zTorqueUnit2Y=this.relPos2Y*this.invI2e10-this.relPos2X*this.invI2e11,this.zTorqueUnit2Z=this.relPos2Y*this.invI2e20-this.relPos2X*this.invI2e21,this.d00=this.invM1+this.invM2,this.d01=0,this.d02=0,this.d10=0,this.d11=this.d00,this.d12=0,this.d20=0,this.d21=0,this.d22=this.d00,u=-this.relPos1Z,f=this.relPos1Y,e=this.relPos1Z,o=-this.relPos1X,s=-this.relPos1Y,h=this.relPos1X,p=this.invI1e01*e+this.invI1e02*s,w=this.invI1e00*u+this.invI1e02*h,b=this.invI1e00*f+this.invI1e01*o,k=this.invI1e11*e+this.invI1e12*s,d=this.invI1e10*u+this.invI1e12*h,g=this.invI1e10*f+this.invI1e11*o,nt=this.invI1e21*e+this.invI1e22*s,tt=this.invI1e20*u+this.invI1e22*h,it=this.invI1e20*f+this.invI1e21*o,this.d00-=u*k+f*nt,this.d01-=u*d+f*tt,this.d02-=u*g+f*it,this.d10-=e*p+o*nt,this.d11-=e*w+o*tt,this.d12-=e*b+o*it,this.d20-=s*p+h*k,this.d21-=s*w+h*d,this.d22-=s*b+h*g,u=-this.relPos2Z,f=this.relPos2Y,e=this.relPos2Z,o=-this.relPos2X,s=-this.relPos2Y,h=this.relPos2X,p=this.invI2e01*e+this.invI2e02*s,w=this.invI2e00*u+this.invI2e02*h,b=this.invI2e00*f+this.invI2e01*o,k=this.invI2e11*e+this.invI2e12*s,d=this.invI2e10*u+this.invI2e12*h,g=this.invI2e10*f+this.invI2e11*o,nt=this.invI2e21*e+this.invI2e22*s,tt=this.invI2e20*u+this.invI2e22*h,it=this.invI2e20*f+this.invI2e21*o,this.d00-=u*k+f*nt,this.d01-=u*d+f*tt,this.d02-=u*g+f*it,this.d10-=e*p+o*nt,this.d11-=e*w+o*tt,this.d12-=e*b+o*it,this.d20-=s*p+h*k,this.d21-=s*w+h*d,this.d22-=s*b+h*g,r=1/(this.d00*(this.d11*this.d22-this.d21*this.d12)+this.d10*(this.d21*this.d02-this.d01*this.d22)+this.d20*(this.d01*this.d12-this.d11*this.d02)),a=(this.d11*this.d22-this.d12*this.d21)*r,u=(this.d02*this.d21-this.d01*this.d22)*r,f=(this.d01*this.d12-this.d02*this.d11)*r,e=(this.d12*this.d20-this.d10*this.d22)*r,v=(this.d00*this.d22-this.d02*this.d20)*r,o=(this.d02*this.d10-this.d00*this.d12)*r,s=(this.d10*this.d21-this.d11*this.d20)*r,h=(this.d01*this.d20-this.d00*this.d21)*r,y=(this.d00*this.d11-this.d01*this.d10)*r,this.d00=a,this.d01=u,this.d02=f,this.d10=e,this.d11=v,this.d12=o,this.d20=s,this.d21=h,this.d22=y,a=this.invI1e00+this.invI2e00,u=this.invI1e01+this.invI2e01,f=this.invI1e02+this.invI2e02,e=this.invI1e10+this.invI2e10,v=this.invI1e11+this.invI2e11,o=this.invI1e12+this.invI2e12,s=this.invI1e20+this.invI2e20,h=this.invI1e21+this.invI2e21,y=this.invI1e22+this.invI2e22,this.invNorDenominator=this.norX*(this.norX*a+this.norY*u+this.norZ*f)+this.norY*(this.norX*e+this.norY*v+this.norZ*o)+this.norZ*(this.norX*s+this.norY*h+this.norZ*y),this.norDenominator=1/this.invNorDenominator,this.tanDenominator=1/(this.tanX*(this.tanX*a+this.tanY*u+this.tanZ*f)+this.tanY*(this.tanX*e+this.tanY*v+this.tanZ*o)+this.tanZ*(this.tanX*s+this.tanY*h+this.tanZ*y)),this.binDenominator=1/(this.binX*(this.binX*a+this.binY*u+this.binZ*f)+this.binY*(this.binX*e+this.binY*v+this.binZ*o)+this.binZ*(this.binX*s+this.binY*h+this.binZ*y)),this.enableLimits?this.hingeAngle<this.lowerLimit?(this.limitSign!=-1&&(this.limitTorque=0),this.limitSign=-1):this.hingeAngle>this.upperLimit?(this.limitSign!=1&&(this.limitTorque=0),this.limitSign=1):(this.limitSign=0,this.limitTorque=0):(this.limitSign=0,this.limitTorque=0),this.enableMotor&&(this.stepMotorTorque=n*this.maxMotorTorque),this.torqueTan*=.95,this.torqueBin*=.95,this.motorTorque*=.95,this.limitTorque*=.95,r=this.limitTorque+this.motorTorque,this.torqueX=r*this.norX+this.torqueTan*this.tanX+this.torqueBin*this.binX,this.torqueY=r*this.norY+this.torqueTan*this.tanY+this.torqueBin*this.binY,this.torqueZ=r*this.norZ+this.torqueTan*this.tanZ+this.torqueBin*this.binZ,this.lVel1.x+=this.impulseX*this.invM1,this.lVel1.y+=this.impulseY*this.invM1,this.lVel1.z+=this.impulseZ*this.invM1,this.aVel1.x+=this.xTorqueUnit1X*this.impulseX+this.yTorqueUnit1X*this.impulseY+this.zTorqueUnit1X*this.impulseZ+this.torqueX*this.invI1e00+this.torqueY*this.invI1e01+this.torqueZ*this.invI1e02,this.aVel1.y+=this.xTorqueUnit1Y*this.impulseX+this.yTorqueUnit1Y*this.impulseY+this.zTorqueUnit1Y*this.impulseZ+this.torqueX*this.invI1e10+this.torqueY*this.invI1e11+this.torqueZ*this.invI1e12,this.aVel1.z+=this.xTorqueUnit1Z*this.impulseX+this.yTorqueUnit1Z*this.impulseY+this.zTorqueUnit1Z*this.impulseZ+this.torqueX*this.invI1e20+this.torqueY*this.invI1e21+this.torqueZ*this.invI1e22,this.lVel2.x-=this.impulseX*this.invM2,this.lVel2.y-=this.impulseY*this.invM2,this.lVel2.z-=this.impulseZ*this.invM2,this.aVel2.x-=this.xTorqueUnit2X*this.impulseX+this.yTorqueUnit2X*this.impulseY+this.zTorqueUnit2X*this.impulseZ+this.torqueX*this.invI2e00+this.torqueY*this.invI2e01+this.torqueZ*this.invI2e02,this.aVel2.y-=this.xTorqueUnit2Y*this.impulseX+this.yTorqueUnit2Y*this.impulseY+this.zTorqueUnit2Y*this.impulseZ+this.torqueX*this.invI2e10+this.torqueY*this.invI2e11+this.torqueZ*this.invI2e12,this.aVel2.z-=this.xTorqueUnit2Z*this.impulseX+this.yTorqueUnit2Z*this.impulseY+this.zTorqueUnit2Z*this.impulseZ+this.torqueX*this.invI2e20+this.torqueY*this.invI2e21+this.torqueZ*this.invI2e22,this.targetVelX=this.anchorPosition2.x-this.anchorPosition1.x,this.targetVelY=this.anchorPosition2.y-this.anchorPosition1.y,this.targetVelZ=this.anchorPosition2.z-this.anchorPosition1.z,r=Math.sqrt(this.targetVelX*this.targetVelX+this.targetVelY*this.targetVelY+this.targetVelZ*this.targetVelZ),r<.005?(this.targetVelX=0,this.targetVelY=0,this.targetVelZ=0):(r=(.005-r)/r*t*.05,this.targetVelX*=r,this.targetVelY*=r,this.targetVelZ*=r),r=this.axis2Y*this.axis1Z-this.axis2Z*this.axis1Y,c=this.axis2Z*this.axis1X-this.axis2X*this.axis1Z,l=this.axis2X*this.axis1Y-this.axis2Y*this.axis1X,this.targetAngVelTan=this.tanX*r+this.tanY*c+this.tanZ*l,this.targetAngVelTan=this.targetAngVelTan>.02?(this.targetAngVelTan-.02)*t*.05:this.targetAngVelTan<-.02?(this.targetAngVelTan+.02)*t*.05:0,this.targetAngVelBin=this.binX*r+this.binY*c+this.binZ*l,this.targetAngVelBin=this.targetAngVelBin>.02?(this.targetAngVelBin-.02)*t*.05:this.targetAngVelBin<-.02?(this.targetAngVelBin+.02)*t*.05:0,this.limitSign==-1?(this.targetAngVelNor=this.lowerLimit-this.hingeAngle,this.targetAngVelNor=this.targetAngVelNor<.02?0:(this.targetAngVelNor-.02)*t*.05):this.limitSign==1?(this.targetAngVelNor=this.upperLimit-this.hingeAngle,this.targetAngVelNor=this.targetAngVelNor>-.02?0:(this.targetAngVelNor+.02)*t*.05):this.targetAngVelNor=0},OIMO.HingeJoint.prototype.solve=function(){var r,u,f,e,n,t,i,s,h,l,o,a,c;r=this.lVel2.x-this.lVel1.x+this.aVel2.y*this.relPos2Z-this.aVel2.z*this.relPos2Y-this.aVel1.y*this.relPos1Z+this.aVel1.z*this.relPos1Y-this.targetVelX,u=this.lVel2.y-this.lVel1.y+this.aVel2.z*this.relPos2X-this.aVel2.x*this.relPos2Z-this.aVel1.z*this.relPos1X+this.aVel1.x*this.relPos1Z-this.targetVelY,f=this.lVel2.z-this.lVel1.z+this.aVel2.x*this.relPos2Y-this.aVel2.y*this.relPos2X-this.aVel1.x*this.relPos1Y+this.aVel1.y*this.relPos1X-this.targetVelZ,n=r*this.d00+u*this.d01+f*this.d02,t=r*this.d10+u*this.d11+f*this.d12,i=r*this.d20+u*this.d21+f*this.d22,this.impulseX+=n,this.impulseY+=t,this.impulseZ+=i,this.lVel1.x+=n*this.invM1,this.lVel1.y+=t*this.invM1,this.lVel1.z+=i*this.invM1,this.aVel1.x+=this.xTorqueUnit1X*n+this.yTorqueUnit1X*t+this.zTorqueUnit1X*i,this.aVel1.y+=this.xTorqueUnit1Y*n+this.yTorqueUnit1Y*t+this.zTorqueUnit1Y*i,this.aVel1.z+=this.xTorqueUnit1Z*n+this.yTorqueUnit1Z*t+this.zTorqueUnit1Z*i,this.lVel2.x-=n*this.invM2,this.lVel2.y-=t*this.invM2,this.lVel2.z-=i*this.invM2,this.aVel2.x-=this.xTorqueUnit2X*n+this.yTorqueUnit2X*t+this.zTorqueUnit2X*i,this.aVel2.y-=this.xTorqueUnit2Y*n+this.yTorqueUnit2Y*t+this.zTorqueUnit2Y*i,this.aVel2.z-=this.xTorqueUnit2Z*n+this.yTorqueUnit2Z*t+this.zTorqueUnit2Z*i,r=this.aVel2.x-this.aVel1.x,u=this.aVel2.y-this.aVel1.y,f=this.aVel2.z-this.aVel1.z,e=r*this.norX+u*this.norY+f*this.norZ,this.enableMotor?(o=(e-this.motorSpeed)*this.norDenominator,l=this.motorTorque,this.motorTorque+=o,this.motorTorque>this.stepMotorTorque?this.motorTorque=this.stepMotorTorque:this.motorTorque<-this.stepMotorTorque&&(this.motorTorque=-this.stepMotorTorque),o=this.motorTorque-l,e-=o*this.invNorDenominator):o=0,this.limitSign!=0?(c=(e-this.targetAngVelNor)*this.norDenominator,a=this.limitTorque,this.limitTorque+=c,this.limitTorque*this.limitSign<0&&(this.limitTorque=0),c=this.limitTorque-a):c=0,e=o+c,s=(r*this.tanX+u*this.tanY+f*this.tanZ-this.targetAngVelTan)*this.tanDenominator,h=(r*this.binX+u*this.binY+f*this.binZ-this.targetAngVelBin)*this.binDenominator,this.torqueTan+=s,this.torqueBin+=h,n=e*this.norX+s*this.tanX+h*this.binX,t=e*this.norY+s*this.tanY+h*this.binY,i=e*this.norZ+s*this.tanZ+h*this.binZ,this.aVel1.x+=this.invI1e00*n+this.invI1e01*t+this.invI1e02*i,this.aVel1.y+=this.invI1e10*n+this.invI1e11*t+this.invI1e12*i,this.aVel1.z+=this.invI1e20*n+this.invI1e21*t+this.invI1e22*i,this.aVel2.x-=this.invI2e00*n+this.invI2e01*t+this.invI2e02*i,this.aVel2.y-=this.invI2e10*n+this.invI2e11*t+this.invI2e12*i,this.aVel2.z-=this.invI2e20*n+this.invI2e21*t+this.invI2e22*i},OIMO.HingeJoint.prototype.postSolve=function(){this.impulse.x=this.impulseX,this.impulse.y=this.impulseY,this.impulse.z=this.impulseZ,this.torque.x=this.torqueX,this.torque.y=this.torqueY,this.torque.z=this.torqueZ},OIMO.HingeJoint.prototype.acosClamp=function(n){return n>1?0:n<-1?Math.PI:Math.acos(n)},OIMO.Hinge2Joint=function(n,t,i){OIMO.Joint.call(this),this.limitTorque1=NaN,this.motorTorque1=NaN,this.limitTorque2=NaN,this.motorTorque2=NaN,this.enableLimits1=!1,this.lowerLimit1=NaN,this.upperLimit1=NaN,this.limitSign1=0,this.enableLimits2=!1,this.lowerLimit2=NaN,this.upperLimit2=NaN,this.limitSign2=0,this.enableMotor1=!1,this.motorSpeed1=NaN,this.maxMotorTorque1=NaN,this.stepMotorTorque1=NaN,this.enableMotor2=!1,this.motorSpeed2=NaN,this.maxMotorTorque2=NaN,this.stepMotorTorque2=NaN,this.tanX=NaN,this.tanY=NaN,this.tanZ=NaN,this.binX=NaN,this.binY=NaN,this.binZ=NaN,this.angAxis1X=NaN,this.angAxis1Y=NaN,this.angAxis1Z=NaN,this.angAxis2X=NaN,this.angAxis2Y=NaN,this.angAxis2Z=NaN,this.norX=NaN,this.norY=NaN,this.norZ=NaN,this.angle1=NaN,this.angle2=NaN,this.relPos1X=NaN,this.relPos1Y=NaN,this.relPos1Z=NaN,this.relPos2X=NaN,this.relPos2Y=NaN,this.relPos2Z=NaN,this.xTorqueUnit1X=NaN,this.xTorqueUnit1Y=NaN,this.xTorqueUnit1Z=NaN,this.xTorqueUnit2X=NaN,this.xTorqueUnit2Y=NaN,this.xTorqueUnit2Z=NaN,this.yTorqueUnit1X=NaN,this.yTorqueUnit1Y=NaN,this.yTorqueUnit1Z=NaN,this.yTorqueUnit2X=NaN,this.yTorqueUnit2Y=NaN,this.yTorqueUnit2Z=NaN,this.zTorqueUnit1X=NaN,this.zTorqueUnit1Y=NaN,this.zTorqueUnit1Z=NaN,this.zTorqueUnit2X=NaN,this.zTorqueUnit2Y=NaN,this.zTorqueUnit2Z=NaN,this.invI1e00=NaN,this.invI1e01=NaN,this.invI1e02=NaN,this.invI1e10=NaN,this.invI1e11=NaN,this.invI1e12=NaN,this.invI1e20=NaN,this.invI1e21=NaN,this.invI1e22=NaN,this.invI2e00=NaN,this.invI2e01=NaN,this.invI2e02=NaN,this.invI2e10=NaN,this.invI2e11=NaN,this.invI2e12=NaN,this.invI2e20=NaN,this.invI2e21=NaN,this.invI2e22=NaN,this.d00=NaN,this.d01=NaN,this.d02=NaN,this.d10=NaN,this.d11=NaN,this.d12=NaN,this.d20=NaN,this.d21=NaN,this.d22=NaN,this.norDenominator=NaN,this.tanDenominator=NaN,this.binDenominator=NaN,this.invTanDenominator=NaN,this.invBinDenominator=NaN,this.targetVelX=NaN,this.targetVelY=NaN,this.targetVelZ=NaN,this.targetAngVelNor=NaN,this.targetAngVelTan=NaN,this.targetAngVelBin=NaN,this.body1=t,this.body2=i,this.connection1.connected=i,this.connection2.connected=t,this.localAxis1=new OIMO.Vec3,this.localAxis2=new OIMO.Vec3,this.localAxis1.normalize(n.localAxis1),this.localAxis2.normalize(n.localAxis2);var r;this.localAxis1X=this.localAxis1.x,this.localAxis1Y=this.localAxis1.y,this.localAxis1Z=this.localAxis1.z,this.localAngAxis1X=this.localAxis1Y*this.localAxis1X-this.localAxis1Z*this.localAxis1Z,this.localAngAxis1Y=-this.localAxis1Z*this.localAxis1Y-this.localAxis1X*this.localAxis1X,this.localAngAxis1Z=this.localAxis1X*this.localAxis1Z+this.localAxis1Y*this.localAxis1Y,r=1/Math.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z),this.localAngAxis1X*=r,this.localAngAxis1Y*=r,this.localAngAxis1Z*=r,this.localAxis2X=this.localAxis2.x,this.localAxis2Y=this.localAxis2.y,this.localAxis2Z=this.localAxis2.z,this.localAngAxis2X=this.localAxis2Y*this.localAxis2X-this.localAxis2Z*this.localAxis2Z,this.localAngAxis2Y=-this.localAxis2Z*this.localAxis2Y-this.localAxis2X*this.localAxis2X,this.localAngAxis2Z=this.localAxis2X*this.localAxis2Z+this.localAxis2Y*this.localAxis2Y,r=1/Math.sqrt(this.localAngAxis2X*this.localAngAxis2X+this.localAngAxis2Y*this.localAngAxis2Y+this.localAngAxis2Z*this.localAngAxis2Z),this.localAngAxis2X*=r,this.localAngAxis2Y*=r,this.localAngAxis2Z*=r,this.allowCollision=n.allowCollision,this.localRelativeAnchorPosition1.copy(n.localRelativeAnchorPosition1),this.localRelativeAnchorPosition2.copy(n.localRelativeAnchorPosition2),this.type=this.JOINT_HINGE2,this.lVel1=this.body1.linearVelocity,this.lVel2=this.body2.linearVelocity,this.aVel1=this.body1.angularVelocity,this.aVel2=this.body2.angularVelocity,this.invM1=this.body1.invertMass,this.invM2=this.body2.invertMass,this.impulse=new OIMO.Vec3,this.torque=new OIMO.Vec3,this.impulseX=0,this.impulseY=0,this.impulseZ=0,this.limitTorque1=0,this.motorTorque1=0,this.limitTorque2=0,this.motorTorque2=0,this.torqueX=0,this.torqueY=0,this.torqueZ=0,this.torqueNor=0},OIMO.Hinge2Joint.prototype=Object.create(OIMO.Joint.prototype),OIMO.Hinge2Joint.prototype.preSolve=function(n,t){var i,r,c,l,rt,ut,ft,a,u,f,e,v,o,s,h,y,p,w,b,k,d,g,nt,tt,it;i=this.body1.rotation.elements,this.tanX=this.localAxis1X*i[0]+this.localAxis1Y*i[1]+this.localAxis1Z*i[2],this.tanY=this.localAxis1X*i[3]+this.localAxis1Y*i[4]+this.localAxis1Z*i[5],this.tanZ=this.localAxis1X*i[6]+this.localAxis1Y*i[7]+this.localAxis1Z*i[8],this.angAxis1X=this.localAngAxis1X*i[0]+this.localAngAxis1Y*i[1]+this.localAngAxis1Z*i[2],this.angAxis1Y=this.localAngAxis1X*i[3]+this.localAngAxis1Y*i[4]+this.localAngAxis1Z*i[5],this.angAxis1Z=this.localAngAxis1X*i[6]+this.localAngAxis1Y*i[7]+this.localAngAxis1Z*i[8],r=this.localRelativeAnchorPosition1.x,c=this.localRelativeAnchorPosition1.y,l=this.localRelativeAnchorPosition1.z,this.relPos1X=this.relativeAnchorPosition1.x=r*i[0]+c*i[1]+l*i[2],this.relPos1Y=this.relativeAnchorPosition1.y=r*i[3]+c*i[4]+l*i[5],this.relPos1Z=this.relativeAnchorPosition1.z=r*i[6]+c*i[7]+l*i[8],i=this.body2.rotation.elements,this.binX=this.localAxis2X*i[0]+this.localAxis2Y*i[1]+this.localAxis2Z*i[2],this.binY=this.localAxis2X*i[3]+this.localAxis2Y*i[4]+this.localAxis2Z*i[5],this.binZ=this.localAxis2X*i[6]+this.localAxis2Y*i[7]+this.localAxis2Z*i[8],this.angAxis2X=this.localAngAxis2X*i[0]+this.localAngAxis2Y*i[1]+this.localAngAxis2Z*i[2],this.angAxis2Y=this.localAngAxis2X*i[3]+this.localAngAxis2Y*i[4]+this.localAngAxis2Z*i[5],this.angAxis2Z=this.localAngAxis2X*i[6]+this.localAngAxis2Y*i[7]+this.localAngAxis2Z*i[8],r=this.localRelativeAnchorPosition2.x,c=this.localRelativeAnchorPosition2.y,l=this.localRelativeAnchorPosition2.z,this.relPos2X=this.relativeAnchorPosition2.x=r*i[0]+c*i[1]+l*i[2],this.relPos2Y=this.relativeAnchorPosition2.y=r*i[3]+c*i[4]+l*i[5],this.relPos2Z=this.relativeAnchorPosition2.z=r*i[6]+c*i[7]+l*i[8],this.anchorPosition1.x=this.relPos1X+this.body1.position.x,this.anchorPosition1.y=this.relPos1Y+this.body1.position.y,this.anchorPosition1.z=this.relPos1Z+this.body1.position.z,this.anchorPosition2.x=this.relPos2X+this.body2.position.x,this.anchorPosition2.y=this.relPos2Y+this.body2.position.y,this.anchorPosition2.z=this.relPos2Z+this.body2.position.z,this.norX=this.binY*this.tanZ-this.binZ*this.tanY,this.norY=this.binZ*this.tanX-this.binX*this.tanZ,this.norZ=this.binX*this.tanY-this.binY*this.tanX,r=Math.sqrt(this.norX*this.norX+this.norY*this.norY+this.norZ*this.norZ),r>0&&(r=1/r),this.norX*=r,this.norY*=r,this.norZ*=r,this.angle1=this.tanX*(this.angAxis1Y*this.binZ-this.angAxis1Z*this.binY)+this.tanY*(this.angAxis1Z*this.binX-this.angAxis1X*this.binZ)+this.tanZ*(this.angAxis1X*this.binY-this.angAxis1Y*this.binX)<0?-Math.acos(this.angAxis1X*this.binX+this.angAxis1Y*this.binY+this.angAxis1Z*this.binZ):Math.acos(this.angAxis1X*this.binX+this.angAxis1Y*this.binY+this.angAxis1Z*this.binZ),this.angle2=this.binX*(this.angAxis2Y*this.tanZ-this.angAxis2Z*this.tanY)+this.binY*(this.angAxis2Z*this.tanX-this.angAxis2X*this.tanZ)+this.binZ*(this.angAxis2X*this.tanY-this.angAxis2Y*this.tanX)<0?Math.acos(this.angAxis2X*this.tanX+this.angAxis2Y*this.tanY+this.angAxis2Z*this.tanZ):-Math.acos(this.angAxis2X*this.tanX+this.angAxis2Y*this.tanY+this.angAxis2Z*this.tanZ),i=this.body1.invertInertia.elements,this.invI1e00=i[0],this.invI1e01=i[1],this.invI1e02=i[2],this.invI1e10=i[3],this.invI1e11=i[4],this.invI1e12=i[5],this.invI1e20=i[6],this.invI1e21=i[7],this.invI1e22=i[8],i=this.body2.invertInertia.elements,this.invI2e00=i[0],this.invI2e01=i[1],this.invI2e02=i[2],this.invI2e10=i[3],this.invI2e11=i[4],this.invI2e12=i[5],this.invI2e20=i[6],this.invI2e21=i[7],this.invI2e22=i[8],this.xTorqueUnit1X=this.relPos1Z*this.invI1e01-this.relPos1Y*this.invI1e02,this.xTorqueUnit1Y=this.relPos1Z*this.invI1e11-this.relPos1Y*this.invI1e12,this.xTorqueUnit1Z=this.relPos1Z*this.invI1e21-this.relPos1Y*this.invI1e22,this.xTorqueUnit2X=this.relPos2Z*this.invI2e01-this.relPos2Y*this.invI2e02,this.xTorqueUnit2Y=this.relPos2Z*this.invI2e11-this.relPos2Y*this.invI2e12,this.xTorqueUnit2Z=this.relPos2Z*this.invI2e21-this.relPos2Y*this.invI2e22,this.yTorqueUnit1X=-this.relPos1Z*this.invI1e00+this.relPos1X*this.invI1e02,this.yTorqueUnit1Y=-this.relPos1Z*this.invI1e10+this.relPos1X*this.invI1e12,this.yTorqueUnit1Z=-this.relPos1Z*this.invI1e20+this.relPos1X*this.invI1e22,this.yTorqueUnit2X=-this.relPos2Z*this.invI2e00+this.relPos2X*this.invI2e02,this.yTorqueUnit2Y=-this.relPos2Z*this.invI2e10+this.relPos2X*this.invI2e12,this.yTorqueUnit2Z=-this.relPos2Z*this.invI2e20+this.relPos2X*this.invI2e22,this.zTorqueUnit1X=this.relPos1Y*this.invI1e00-this.relPos1X*this.invI1e01,this.zTorqueUnit1Y=this.relPos1Y*this.invI1e10-this.relPos1X*this.invI1e11,this.zTorqueUnit1Z=this.relPos1Y*this.invI1e20-this.relPos1X*this.invI1e21,this.zTorqueUnit2X=this.relPos2Y*this.invI2e00-this.relPos2X*this.invI2e01,this.zTorqueUnit2Y=this.relPos2Y*this.invI2e10-this.relPos2X*this.invI2e11,this.zTorqueUnit2Z=this.relPos2Y*this.invI2e20-this.relPos2X*this.invI2e21,this.d00=this.invM1+this.invM2,this.d01=0,this.d02=0,this.d10=0,this.d11=this.d00,this.d12=0,this.d20=0,this.d21=0,this.d22=this.d00,u=-this.relPos1Z,f=this.relPos1Y,e=this.relPos1Z,o=-this.relPos1X,s=-this.relPos1Y,h=this.relPos1X,p=this.invI1e01*e+this.invI1e02*s,w=this.invI1e00*u+this.invI1e02*h,b=this.invI1e00*f+this.invI1e01*o,k=this.invI1e11*e+this.invI1e12*s,d=this.invI1e10*u+this.invI1e12*h,g=this.invI1e10*f+this.invI1e11*o,nt=this.invI1e21*e+this.invI1e22*s,tt=this.invI1e20*u+this.invI1e22*h,it=this.invI1e20*f+this.invI1e21*o,this.d00-=u*k+f*nt,this.d01-=u*d+f*tt,this.d02-=u*g+f*it,this.d10-=e*p+o*nt,this.d11-=e*w+o*tt,this.d12-=e*b+o*it,this.d20-=s*p+h*k,this.d21-=s*w+h*d,this.d22-=s*b+h*g,u=-this.relPos2Z,f=this.relPos2Y,e=this.relPos2Z,o=-this.relPos2X,s=-this.relPos2Y,h=this.relPos2X,p=this.invI2e01*e+this.invI2e02*s,w=this.invI2e00*u+this.invI2e02*h,b=this.invI2e00*f+this.invI2e01*o,k=this.invI2e11*e+this.invI2e12*s,d=this.invI2e10*u+this.invI2e12*h,g=this.invI2e10*f+this.invI2e11*o,nt=this.invI2e21*e+this.invI2e22*s,tt=this.invI2e20*u+this.invI2e22*h,it=this.invI2e20*f+this.invI2e21*o,this.d00-=u*k+f*nt,this.d01-=u*d+f*tt,this.d02-=u*g+f*it,this.d10-=e*p+o*nt,this.d11-=e*w+o*tt,this.d12-=e*b+o*it,this.d20-=s*p+h*k,this.d21-=s*w+h*d,this.d22-=s*b+h*g,r=1/(this.d00*(this.d11*this.d22-this.d21*this.d12)+this.d10*(this.d21*this.d02-this.d01*this.d22)+this.d20*(this.d01*this.d12-this.d11*this.d02)),a=(this.d11*this.d22-this.d12*this.d21)*r,u=(this.d02*this.d21-this.d01*this.d22)*r,f=(this.d01*this.d12-this.d02*this.d11)*r,e=(this.d12*this.d20-this.d10*this.d22)*r,v=(this.d00*this.d22-this.d02*this.d20)*r,o=(this.d02*this.d10-this.d00*this.d12)*r,s=(this.d10*this.d21-this.d11*this.d20)*r,h=(this.d01*this.d20-this.d00*this.d21)*r,y=(this.d00*this.d11-this.d01*this.d10)*r,this.d00=a,this.d01=u,this.d02=f,this.d10=e,this.d11=v,this.d12=o,this.d20=s,this.d21=h,this.d22=y,a=this.invI1e00+this.invI2e00,u=this.invI1e01+this.invI2e01,f=this.invI1e02+this.invI2e02,e=this.invI1e10+this.invI2e10,v=this.invI1e11+this.invI2e11,o=this.invI1e12+this.invI2e12,s=this.invI1e20+this.invI2e20,h=this.invI1e21+this.invI2e21,y=this.invI1e22+this.invI2e22,this.norDenominator=1/(this.norX*(this.norX*a+this.norY*u+this.norZ*f)+this.norY*(this.norX*e+this.norY*v+this.norZ*o)+this.norZ*(this.norX*s+this.norY*h+this.norZ*y)),this.invTanDenominator=this.tanX*(this.tanX*a+this.tanY*u+this.tanZ*f)+this.tanY*(this.tanX*e+this.tanY*v+this.tanZ*o)+this.tanZ*(this.tanX*s+this.tanY*h+this.tanZ*y),this.tanDenominator=1/this.invTanDenominator,this.invBinDenominator=this.binX*(this.binX*a+this.binY*u+this.binZ*f)+this.binY*(this.binX*e+this.binY*v+this.binZ*o)+this.binZ*(this.binX*s+this.binY*h+this.binZ*y),this.binDenominator=1/this.invBinDenominator,this.enableLimits1?this.angle1<this.lowerLimit1?(this.limitSign1!=-1&&(this.limitTorque1=0),this.limitSign1=-1):this.angle1>this.upperLimit1?(this.limitSign1!=1&&(this.limitTorque1=0),this.limitSign1=1):(this.limitSign1=0,this.limitTorque1=0):(this.limitSign1=0,this.limitTorque1=0),this.enableLimits2?this.angle2<this.lowerLimit2?(this.limitSign2!=-1&&(this.limitTorque2=0),this.limitSign2=-1):this.angle2>this.upperLimit2?(this.limitSign2!=1&&(this.limitTorque2=0),this.limitSign2=1):(this.limitSign2=0,this.limitTorque2=0):(this.limitSign2=0,this.limitTorque2=0),this.enableMotor1&&(this.stepMotorTorque1=n*this.maxMotorTorque1),this.enableMotor2&&(this.stepMotorTorque2=n*this.maxMotorTorque2),this.torqueNor*=.95,this.motorTorque1*=.95,this.limitTorque1*=.95,this.motorTorque2*=.95,this.limitTorque2*=.95,r=this.motorTorque1+this.limitTorque1,c=this.motorTorque2+this.limitTorque2,this.torqueX=this.torqueNor*this.norX+r*this.tanX+c*this.binX,this.torqueY=this.torqueNor*this.norY+r*this.tanY+c*this.binY,this.torqueZ=this.torqueNor*this.norZ+r*this.tanZ+c*this.binZ,this.lVel1.x+=this.impulseX*this.invM1,this.lVel1.y+=this.impulseY*this.invM1,this.lVel1.z+=this.impulseZ*this.invM1,this.aVel1.x+=this.xTorqueUnit1X*this.impulseX+this.yTorqueUnit1X*this.impulseY+this.zTorqueUnit1X*this.impulseZ+this.torqueX*this.invI1e00+this.torqueY*this.invI1e01+this.torqueZ*this.invI1e02,this.aVel1.y+=this.xTorqueUnit1Y*this.impulseX+this.yTorqueUnit1Y*this.impulseY+this.zTorqueUnit1Y*this.impulseZ+this.torqueX*this.invI1e10+this.torqueY*this.invI1e11+this.torqueZ*this.invI1e12,this.aVel1.z+=this.xTorqueUnit1Z*this.impulseX+this.yTorqueUnit1Z*this.impulseY+this.zTorqueUnit1Z*this.impulseZ+this.torqueX*this.invI1e20+this.torqueY*this.invI1e21+this.torqueZ*this.invI1e22,this.lVel2.x-=this.impulseX*this.invM2,this.lVel2.y-=this.impulseY*this.invM2,this.lVel2.z-=this.impulseZ*this.invM2,this.aVel2.x-=this.xTorqueUnit2X*this.impulseX+this.yTorqueUnit2X*this.impulseY+this.zTorqueUnit2X*this.impulseZ+this.torqueX*this.invI2e00+this.torqueY*this.invI2e01+this.torqueZ*this.invI2e02,this.aVel2.y-=this.xTorqueUnit2Y*this.impulseX+this.yTorqueUnit2Y*this.impulseY+this.zTorqueUnit2Y*this.impulseZ+this.torqueX*this.invI2e10+this.torqueY*this.invI2e11+this.torqueZ*this.invI2e12,this.aVel2.z-=this.xTorqueUnit2Z*this.impulseX+this.yTorqueUnit2Z*this.impulseY+this.zTorqueUnit2Z*this.impulseZ+this.torqueX*this.invI2e20+this.torqueY*this.invI2e21+this.torqueZ*this.invI2e22,this.targetVelX=this.anchorPosition2.x-this.anchorPosition1.x,this.targetVelY=this.anchorPosition2.y-this.anchorPosition1.y,this.targetVelZ=this.anchorPosition2.z-this.anchorPosition1.z,r=Math.sqrt(this.targetVelX*this.targetVelX+this.targetVelY*this.targetVelY+this.targetVelZ*this.targetVelZ),r<.005?(this.targetVelX=0,this.targetVelY=0,this.targetVelZ=0):(r=(.005-r)/r*t*.05,this.targetVelX*=r,this.targetVelY*=r,this.targetVelZ*=r),this.targetAngVelNor=-(this.tanX*this.binX+this.tanY*this.binY+this.tanZ*this.binZ),this.targetAngVelNor=this.targetAngVelNor>.02?(this.targetAngVelNor-.02)*t*.05:this.targetAngVelNor<-.02?(this.targetAngVelNor+.02)*t*.05:0,this.limitSign1==-1?(this.targetAngVelTan=this.lowerLimit1-this.angle1,this.targetAngVelTan=this.targetAngVelTan<.02?0:(this.targetAngVelTan-.02)*t*.05):this.limitSign1==1?(this.targetAngVelTan=this.upperLimit1-this.angle1,this.targetAngVelTan=this.targetAngVelTan>-.02?0:(this.targetAngVelTan+.02)*t*.05):this.targetAngVelTan=0,this.limitSign2==-1?(this.targetAngVelBin=this.lowerLimit2-this.angle2,this.targetAngVelBin=this.targetAngVelBin<.02?0:(this.targetAngVelBin-.02)*t*.05):this.limitSign2==1?(this.targetAngVelBin=this.upperLimit2-this.angle2,this.targetAngVelBin=this.targetAngVelBin>-.02?0:(this.targetAngVelBin+.02)*t*.05):this.targetAngVelBin=0},OIMO.Hinge2Joint.prototype.solve=function(){var r,u,f,e,n,t,i,h,a,v,y,o,p,c,w,s,b,l;r=this.lVel2.x-this.lVel1.x+this.aVel2.y*this.relPos2Z-this.aVel2.z*this.relPos2Y-this.aVel1.y*this.relPos1Z+this.aVel1.z*this.relPos1Y-this.targetVelX,u=this.lVel2.y-this.lVel1.y+this.aVel2.z*this.relPos2X-this.aVel2.x*this.relPos2Z-this.aVel1.z*this.relPos1X+this.aVel1.x*this.relPos1Z-this.targetVelY,f=this.lVel2.z-this.lVel1.z+this.aVel2.x*this.relPos2Y-this.aVel2.y*this.relPos2X-this.aVel1.x*this.relPos1Y+this.aVel1.y*this.relPos1X-this.targetVelZ,n=r*this.d00+u*this.d01+f*this.d02,t=r*this.d10+u*this.d11+f*this.d12,i=r*this.d20+u*this.d21+f*this.d22,this.impulseX+=n,this.impulseY+=t,this.impulseZ+=i,this.lVel1.x+=n*this.invM1,this.lVel1.y+=t*this.invM1,this.lVel1.z+=i*this.invM1,this.aVel1.x+=this.xTorqueUnit1X*n+this.yTorqueUnit1X*t+this.zTorqueUnit1X*i,this.aVel1.y+=this.xTorqueUnit1Y*n+this.yTorqueUnit1Y*t+this.zTorqueUnit1Y*i,this.aVel1.z+=this.xTorqueUnit1Z*n+this.yTorqueUnit1Z*t+this.zTorqueUnit1Z*i,this.lVel2.x-=n*this.invM2,this.lVel2.y-=t*this.invM2,this.lVel2.z-=i*this.invM2,this.aVel2.x-=this.xTorqueUnit2X*n+this.yTorqueUnit2X*t+this.zTorqueUnit2X*i,this.aVel2.y-=this.xTorqueUnit2Y*n+this.yTorqueUnit2Y*t+this.zTorqueUnit2Y*i,this.aVel2.z-=this.xTorqueUnit2Z*n+this.yTorqueUnit2Z*t+this.zTorqueUnit2Z*i,r=this.aVel2.x-this.aVel1.x,u=this.aVel2.y-this.aVel1.y,f=this.aVel2.z-this.aVel1.z,e=r*this.tanX+u*this.tanY+f*this.tanZ,this.enableMotor1?(o=(e-this.motorSpeed1)*this.tanDenominator,y=this.motorTorque1,this.motorTorque1+=o,this.motorTorque1>this.stepMotorTorque1?this.motorTorque1=this.stepMotorTorque1:this.motorTorque1<-this.stepMotorTorque1&&(this.motorTorque1=-this.stepMotorTorque1),o=this.motorTorque1-y,e-=o*this.invTanDenominator):o=0,this.limitSign1!=0?(c=(e-this.targetAngVelTan)*this.tanDenominator,p=this.limitTorque1,this.limitTorque1+=c,this.limitTorque1*this.limitSign1<0&&(this.limitTorque1=0),c=this.limitTorque1-p):c=0,e=r*this.binX+u*this.binY+f*this.binZ,this.enableMotor2?(s=(e-this.motorSpeed2)*this.binDenominator,w=this.motorTorque2,this.motorTorque2+=s,this.motorTorque2>this.stepMotorTorque2?this.motorTorque2=this.stepMotorTorque2:this.motorTorque2<-this.stepMotorTorque2&&(this.motorTorque2=-this.stepMotorTorque2),s=this.motorTorque2-w,e-=s*this.invBinDenominator):s=0,this.limitSign2!=0?(l=(e-this.targetAngVelBin)*this.binDenominator,b=this.limitTorque2,this.limitTorque2+=l,this.limitTorque2*this.limitSign2<0&&(this.limitTorque2=0),l=this.limitTorque2-b):l=0,h=(r*this.norX+u*this.norY+f*this.norZ-this.targetAngVelNor)*this.norDenominator,a=o+c,v=s+l,this.torqueNor+=h,n=h*this.norX+a*this.tanX+v*this.binX,t=h*this.norY+a*this.tanY+v*this.binY,i=h*this.norZ+a*this.tanZ+v*this.binZ,this.aVel1.x+=this.invI1e00*n+this.invI1e01*t+this.invI1e02*i,this.aVel1.y+=this.invI1e10*n+this.invI1e11*t+this.invI1e12*i,this.aVel1.z+=this.invI1e20*n+this.invI1e21*t+this.invI1e22*i,this.aVel2.x-=this.invI2e00*n+this.invI2e01*t+this.invI2e02*i,this.aVel2.y-=this.invI2e10*n+this.invI2e11*t+this.invI2e12*i,this.aVel2.z-=this.invI2e20*n+this.invI2e21*t+this.invI2e22*i},OIMO.Hinge2Joint.prototype.postSolve=function(){this.impulse.x=this.impulseX,this.impulse.y=this.impulseY,this.impulse.z=this.impulseZ,this.torque.x=this.torqueX,this.torque.y=this.torqueY,this.torque.z=this.torqueZ},OIMO.Mat44=function(n,t,i,r,u,f,e,o,s,h,c,l,a,v,y,p){this.elements=new Float32Array(16);var w=this.elements;w[0]=n!==undefined?n:1,w[4]=t||0,w[8]=i||0,w[12]=r||0,w[1]=u||0,w[5]=f!==undefined?f:1,w[9]=e||0,w[13]=o||0,w[2]=s||0,w[6]=h||0,w[10]=c!==undefined?c:1,w[14]=l||0,w[3]=a||0,w[7]=v||0,w[11]=y||0,w[15]=p!==undefined?p:1},OIMO.Mat44.prototype={constructor:OIMO.Mat44,set:function(n,t,i,r,u,f,e,o,s,h,c,l,a,v,y,p){var w=this.elements;return w[0]=n,w[4]=t,w[8]=i,w[12]=r,w[1]=u,w[5]=f,w[9]=e,w[13]=o,w[2]=s,w[6]=h,w[10]=c,w[14]=l,w[3]=a,w[7]=v,w[11]=y,w[15]=p,this}},OIMO.Mat33=function(n,t,i,r,u,f,e,o,s){this.elements=new Float32Array(9);var h=this.elements;this.init(n!==undefined?n:1,t||0,i||0,r||0,u!==undefined?u:1,f||0,e||0,o||0,s!==undefined?s:1)},OIMO.Mat33.prototype={constructor:OIMO.Mat33,init:function(n,t,i,r,u,f,e,o,s){var h=this.elements;return h[0]=n!==undefined?n:1,h[1]=t||0,h[2]=i||0,h[3]=r||0,h[4]=u!==undefined?u:1,h[5]=f||0,h[6]=e||0,h[7]=o||0,h[8]=s!==undefined?s:1,this},add:function(n,t){var i=this.elements,r=n.elements,u=t.elements;return i[0]=r[0]+u[0],i[1]=r[1]+u[1],i[2]=r[2]+u[2],i[3]=r[3]+u[3],i[4]=r[4]+u[4],i[5]=r[5]+u[5],i[6]=r[6]+u[6],i[7]=r[7]+u[7],i[8]=r[8]+u[8],this},addEqual:function(n){var t=this.elements,i=n.elements;return t[0]+=i[0],t[1]+=i[1],t[2]+=i[2],t[3]+=i[3],t[4]+=i[4],t[5]+=i[5],t[6]+=i[6],t[7]+=i[7],t[8]+=i[8],this},sub:function(n,t){var i=this.elements,r=n.elements,u=t.elements;return i[0]=r[0]-u[0],i[1]=r[1]-u[1],i[2]=r[2]-u[2],i[3]=r[3]-u[3],i[4]=r[4]-u[4],i[5]=r[5]-u[5],i[6]=r[6]-u[6],i[7]=r[7]-u[7],i[8]=r[8]-u[8],this},subEqual:function(n){var t=this.elements,i=n.elements;return t[0]-=i[0],t[1]-=i[1],t[2]-=i[2],t[3]-=i[3],t[4]-=i[4],t[5]-=i[5],t[6]-=i[6],t[7]-=i[7],t[8]-=i[8],this},scale:function(n,t){var i=this.elements,r=n.elements;return i[0]=r[0]*t,i[1]=r[1]*t,i[2]=r[2]*t,i[3]=r[3]*t,i[4]=r[4]*t,i[5]=r[5]*t,i[6]=r[6]*t,i[7]=r[7]*t,i[8]=r[8]*t,this},scaleEqual:function(n){var t=this.elements;return t[0]*=n,t[1]*=n,t[2]*=n,t[3]*=n,t[4]*=n,t[5]*=n,t[6]*=n,t[7]*=n,t[8]*=n,this},mul:function(n,t){var i=this.elements,r=n.elements,u=t.elements,f=r[0],e=r[3],o=r[6],s=r[1],h=r[4],c=r[7],l=r[2],a=r[5],v=r[8],y=u[0],p=u[3],w=u[6],b=u[1],k=u[4],d=u[7],g=u[2],nt=u[5],tt=u[8];return i[0]=f*y+s*p+l*w,i[1]=f*b+s*k+l*d,i[2]=f*g+s*nt+l*tt,i[3]=e*y+h*p+a*w,i[4]=e*b+h*k+a*d,i[5]=e*g+h*nt+a*tt,i[6]=o*y+c*p+v*w,i[7]=o*b+c*k+v*d,i[8]=o*g+c*nt+v*tt,this},mulScale:function(n,t,i,r,u){var o=u||!1,f=this.elements,e=n.elements;return o?(f[0]=t*e[0],f[1]=t*e[1],f[2]=t*e[2],f[3]=i*e[3],f[4]=i*e[4],f[5]=i*e[5],f[6]=r*e[6],f[7]=r*e[7],f[8]=r*e[8]):(f[0]=e[0]*t,f[1]=e[1]*i,f[2]=e[2]*r,f[3]=e[3]*t,f[4]=e[4]*i,f[5]=e[5]*r,f[6]=e[6]*t,f[7]=e[7]*i,f[8]=e[8]*r),this},mulRotate:function(n,t,i,r,u,f){var st=f||!1,h=Math.sin(t),ot=Math.cos(t),o=1-ot,c=i*i*o+ot,l=i*r*o-u*h,a=i*u*o+r*h,v=r*i*o+u*h,y=r*r*o+ot,p=r*u*o-i*h,w=u*i*o-r*h,b=u*r*o+i*h,k=u*u*o+ot,s=n.elements,d=s[0],g=s[3],nt=s[6],tt=s[1],it=s[4],rt=s[7],ut=s[2],ft=s[5],et=s[8],e=this.elements;return st?(e[0]=c*d+l*g+a*nt,e[1]=c*tt+l*it+a*rt,e[2]=c*ut+l*ft+a*et,e[3]=v*d+y*g+p*nt,e[4]=v*tt+y*it+p*rt,e[5]=v*ut+y*ft+p*et,e[6]=w*d+b*g+k*nt,e[7]=w*tt+b*it+k*rt,e[8]=w*ut+b*ft+k*et):(e[0]=d*c+tt*v+ut*w,e[1]=d*l+tt*y+ut*b,e[2]=d*a+tt*p+ut*k,e[3]=g*c+it*v+ft*w,e[4]=g*l+it*y+ft*b,e[5]=g*a+it*p+ft*k,e[6]=nt*c+rt*v+et*w,e[7]=nt*l+rt*y+et*b,e[8]=nt*a+rt*p+et*k),this},transpose:function(n){var t=this.elements,i=n.elements;return t[0]=i[0],t[1]=i[3],t[2]=i[6],t[3]=i[1],t[4]=i[4],t[5]=i[7],t[6]=i[2],t[7]=i[5],t[8]=i[8],this},setQuat:function(n){var u=2*n.x,r=2*n.y,i=2*n.z,f=n.x*u,e=n.y*r,o=n.z*i,s=n.x*r,h=n.y*i,c=n.x*i,l=n.s*u,a=n.s*r,v=n.s*i,t=this.elements;return t[0]=1-e-o,t[1]=s-v,t[2]=c+a,t[3]=s+v,t[4]=1-f-o,t[5]=h-l,t[6]=c-a,t[7]=h+l,t[8]=1-f-e,this},invert:function(n){var i=this.elements,r=n.elements,c=r[0],l=r[3],a=r[6],u=r[1],f=r[4],e=r[7],o=r[2],s=r[5],h=r[8],t=c*(f*h-e*s)+l*(e*o-u*h)+a*(u*s-f*o);return t!==0&&(t=1/t),i[0]=t*(f*h-s*e),i[1]=t*(o*e-u*h),i[2]=t*(u*s-o*f),i[3]=t*(s*a-l*h),i[4]=t*(c*h-o*a),i[5]=t*(o*l-c*s),i[6]=t*(l*e-f*a),i[7]=t*(u*a-c*e),i[8]=t*(c*f-u*l),this},copy:function(n){var t=this.elements,i=n.elements;return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],this},toEuler:function(){function r(n){return Math.min(Math.max(n,-1),1)}var n=this.elements,u=n[0],f=n[3],i=n[6],c=n[1],e=n[4],o=n[7],l=n[2],s=n[5],h=n[8],t=new OIMO.Vec3,a=new OIMO.Quat,v;return t.y=Math.asin(r(i)),Math.abs(i)<.99999?(t.x=Math.atan2(-o,h),t.z=Math.atan2(-f,u)):(t.x=Math.atan2(s,e),t.z=0),t},clone:function(){var n=this.elements;return new OIMO.Mat33(n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8])},toString:function(){var n=this.elements;return"Mat33|"+n[0].toFixed(4)+", "+n[1].toFixed(4)+", "+n[2].toFixed(4)+"|\n     |"+n[3].toFixed(4)+", "+n[4].toFixed(4)+", "+n[5].toFixed(4)+"|\n     |"+n[6].toFixed(4)+", "+n[7].toFixed(4)+", "+n[8].toFixed(4)+"|"}},OIMO.Quat=function(n,t,i,r){this.s=n!==undefined?n:1,this.x=t||0,this.y=i||0,this.z=r||0},OIMO.Quat.prototype={constructor:OIMO.Quat,init:function(n,t,i,r){return this.s=n!==undefined?n:1,this.x=t||0,this.y=i||0,this.z=r||0,this},add:function(n,t){return this.s=n.s+t.s,this.x=n.x+t.x,this.y=n.y+t.y,this.z=n.z+t.z,this},sub:function(n,t){return this.s=n.s-t.s,this.x=n.x-t.x,this.y=n.y-t.y,this.z=n.z-t.z,this},scale:function(n,t){return this.s=n.s*t,this.x=n.x*t,this.y=n.y*t,this.z=n.z*t,this},mul:function(n,t){var i=n.s*t.s-n.x*t.x-n.y*t.y-n.z*t.z,r=n.s*t.x+n.x*t.s+n.y*t.z-n.z*t.y,u=n.s*t.y-n.x*t.z+n.y*t.s+n.z*t.x,f=n.s*t.z+n.x*t.y-n.y*t.x+n.z*t.s;return this.s=i,this.x=r,this.y=u,this.z=f,this},normalize:function(n){var t=Math.sqrt(n.s*n.s+n.x*n.x+n.y*n.y+n.z*n.z);return t>0&&(t=1/t),this.s=n.s*t,this.x=n.x*t,this.y=n.y*t,this.z=n.z*t,this},invert:function(n){return this.s=-n.s,this.x=-n.x,this.y=-n.y,this.z=-n.z,this},length:function(){return Math.sqrt(this.s*this.s+this.x*this.x+this.y*this.y+this.z*this.z)},copy:function(n){return this.s=n.s,this.x=n.x,this.y=n.y,this.z=n.z,this},clone:function(){return new OIMO.Quat(this.s,this.x,this.y,this.z)},toString:function(){return"Quat["+this.s.toFixed(4)+", ("+this.x.toFixed(4)+", "+this.y.toFixed(4)+", "+this.z.toFixed(4)+")]"}},OIMO.Vec3=function(n,t,i){this.x=n||0,this.y=t||0,this.z=i||0},OIMO.Vec3.prototype={constructor:OIMO.Vec3,init:function(n,t,i){return this.x=n||0,this.y=t||0,this.z=i||0,this},add:function(n,t){return this.x=n.x+t.x,this.y=n.y+t.y,this.z=n.z+t.z,this},sub:function(n,t){return this.x=n.x-t.x,this.y=n.y-t.y,this.z=n.z-t.z,this},scale:function(n,t){return this.x=n.x*t,this.y=n.y*t,this.z=n.z*t,this},scaleEqual:function(n){return this.x*=n,this.y*=n,this.z*=n,this},dot:function(n){return this.x*n.x+this.y*n.y+this.z*n.z},cross:function(n,t){var i=n.y*t.z-n.z*t.y,r=n.z*t.x-n.x*t.z,u=n.x*t.y-n.y*t.x;return this.x=i,this.y=r,this.z=u,this},mulMat:function(n,t){var i=n.elements,r=i[0]*t.x+i[1]*t.y+i[2]*t.z,u=i[3]*t.x+i[4]*t.y+i[5]*t.z,f=i[6]*t.x+i[7]*t.y+i[8]*t.z;return this.x=r,this.y=u,this.z=f,this},normalize:function(n){var t=Math.sqrt(n.x*n.x+n.y*n.y+n.z*n.z);return t>0&&(t=1/t),this.x=n.x*t,this.y=n.y*t,this.z=n.z*t,this},invert:function(n){return this.x=-n.x,this.y=-n.y,this.z=-n.z,this},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},copy:function(n){return this.x=n.x,this.y=n.y,this.z=n.z,this},clone:function(){return new OIMO.Vec3(this.x,this.y,this.z)},toString:function(){return"Vec3["+this.x.toFixed(4)+", "+this.y.toFixed(4)+", "+this.z.toFixed(4)+"]"}},OIMO.EulerToAxis=function(n,t,i){var e=Math.cos(t*.5),o=Math.sin(t*.5),s=Math.cos(i*.5),h=Math.sin(i*.5),u=Math.cos(n*.5),f=Math.sin(n*.5),c=e*s,l=o*h,a=c*u-l*f,n=c*f+l*u,t=o*s*u+e*h*f,i=e*h*u-o*s*f,v=2*Math.acos(a),r=n*n+t*t+i*i;return r<.001?(n=1,t=i=0):(r=Math.sqrt(r),n/=r,t/=r,i/=r),[v,n,t,i]},OIMO.EulerToMatrix=function(n,t,i){var u=Math.cos(t),f=Math.sin(t),h=Math.cos(i),e=Math.sin(i),o=Math.cos(n),s=Math.sin(n),c=new OIMO.Mat33,r=c.elements;return r[0]=u*h,r[1]=f*s-u*e*o,r[2]=u*e*s+f*o,r[3]=e,r[4]=h*o,r[5]=-h*s,r[6]=-f*h,r[7]=f*e*o+u*s,r[8]=-f*e*s+u*o,c},OIMO.MatrixToEuler=function(n){var t=n.elements,i,r,u;return t[3]>.998?(r=Math.atan2(t[2],t[8]),u=Math.PI/2,i=0):t[3]<-.998?(r=Math.atan2(t[2],t[8]),u=-Math.PI/2,i=0):(r=Math.atan2(-t[6],t[0]),i=Math.atan2(-t[5],t[4]),u=Math.asin(t[3])),[i,r,u]},OIMO.Distance3d=function(n,t){var i=t[0]-n[0],r=t[1]-n[1],u=t[2]-n[2];return Math.sqrt(i*i+r*r+u*u)}